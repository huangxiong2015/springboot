<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yikuyi.party.supplier.dao.SupplierDao">

	<resultMap id="SupplierSimpleResultMap" type="com.yikuyi.party.supplier.SupplierVo">
		<id column="PARTY_ID" property="supplierId" jdbcType="VARCHAR" />
		<result column="PARTY_CODE" property="supplierCode" jdbcType="VARCHAR" />
		<result column="GROUP_NAME" property="supplierName" jdbcType="VARCHAR" />
		<result column="GROUP_NAME_FULL" property="supplierFullName" jdbcType="VARCHAR" />
		<result column="IS_SHOW_NAME" property="showName" jdbcType="BOOLEAN" />
		<result column="IS_AUTO_INTEGRATE_QTY" property="isAutoIntegrateQty" jdbcType="VARCHAR" />
		<result column="VENDOR_MOV_STATUS" property="vendorMovStatus" jdbcType="VARCHAR" />
		<result column="SKU_MOV_STATUS" property="skuMovStatus" jdbcType="VARCHAR" />
		<result column="LEADTIME_ACCURACYRATE" property="leadtimeAccuracyrate" jdbcType="VARCHAR" />
		<association property="leadtimeAccuracyrate" column="PARTY_ID" javaType="java.lang.String" select="getSupplierLeadtimeConfig"/>
		<collection property="facilitys" column="PARTY_ID" javaType="java.util.Set" ofType="com.yikuyi.party.facility.model.Facility" select="getFacilityBySupplierId"/>
	</resultMap>
	
	<resultMap id="FacilityResultMap" type="com.yikuyi.party.facility.model.Facility">
		<id column="FACILITY_ID" property="id" jdbcType="VARCHAR" />
		<result column="OWNER_PARTY_ID" property="ownerPartyId" jdbcType="VARCHAR" />
		<result column="FACILITY_NAME" property="facilityName" jdbcType="VARCHAR" />
		<result column="FACILITY_NAME_ALIA" property="facilityNameAlia" jdbcType="VARCHAR" />
		<result column="IS_SHOW_FACILITY" property="isShowaFacility" jdbcType="VARCHAR" />
		<result column="CREATOR" property="creator"/>
		<result column="CREATED_DATE" property="createdDate"/>
		<result column="LAST_UPDATE_USER" property="lastUpdateUser"/>
		<result column="LAST_UPDATE_DATE" property="lastUpdateDate"/>
	</resultMap>
	
	<resultMap id="SupplierMailResultMap" type="com.yikuyi.party.supplier.SupplierMailVo">
		<id column="PARTY_ID" property="supplierId" jdbcType="VARCHAR" />
		<result column="GROUP_NAME" property="supplierName" jdbcType="VARCHAR" />
		<collection property="principalMails" column="PARTY_ID" javaType="java.util.Set" ofType="java.lang.String" select="getPrincipalMails"/>
		<collection property="inquiryMails"   column="PARTY_ID" javaType="java.util.Set" ofType="java.lang.String" select="getInquiryMails"/>
	</resultMap>
	
	<!-- 根据供应商ID查询供应商简单信息 如果没有传入参数，查询所有供应商 -->
	<select id="searchSupplierSimple" resultMap="SupplierSimpleResultMap" parameterType="java.util.List">
		SELECT t1.`PARTY_ID` ,t1.`PARTY_CODE`, t2.`GROUP_NAME` , t2.`GROUP_NAME_FULL` , t3.`IS_AUTO_INTEGRATE_QTY` ,  t3.`IS_SHOW_NAME`,
		t3.VENDOR_MOV_STATUS, t3.SKU_MOV_STATUS , 
		IF((SELECT t3.`RATE` FROM `SUPPLIER_LEADTIME_RATE` t3 WHERE t3.`PARTY_ID` = t1.`PARTY_ID` ORDER  BY t3.`LAST_UPDATE_DATE` DESC LIMIT 1 ) IS NULL, t2.LEADTIME_ACCURACYRATE,
		 (SELECT t3.`RATE` FROM `SUPPLIER_LEADTIME_RATE` t3 WHERE t3.`PARTY_ID` = t1.`PARTY_ID` ORDER  BY t3.`LAST_UPDATE_DATE` DESC LIMIT 1 )) AS LEADTIME_ACCURACYRATE
		FROM PARTY t1 
		LEFT JOIN PARTY_GROUP t2 ON t1.`PARTY_ID` = t2.`PARTY_ID`
		LEFT JOIN PARTY_SUPPLIER t3 ON t1.`PARTY_ID` = t3.`PARTY_ID` 
		WHERE t1.`PARTY_TYPE_ID` = 'SUPPLIER' AND t1.`STATUS_ID` = 'PARTY_ENABLED' AND t2.ACCOUNT_STATUS= 'VALID' 
		<if test="supplierIds != null and supplierIds.size() !=0">
			AND t1.`PARTY_ID` IN
			<foreach collection="supplierIds" item="item" index="index" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
	</select>
	
	<!-- 根据供应商ID查询供应商所有仓库，这里作为子查询语句 -->
	<select id="getFacilityBySupplierId" resultMap="FacilityResultMap" parameterType="java.lang.String" >
	    SELECT t.`FACILITY_ID` , t.`OWNER_PARTY_ID` , t.`FACILITY_NAME` , t.`FACILITY_NAME_ALIA` , t.`IS_SHOW_FACILITY` , 
	    t.`CREATOR` , t.`CREATED_DATE` , t.`LAST_UPDATE_USER` , t.`LAST_UPDATE_DATE`
	    FROM FACILITY t WHERE t.`OWNER_PARTY_ID` = #{PARTY_ID} AND (t.`THRU_DATE` IS NULL OR t.`THRU_DATE` > NOW())
	</select>
	
	<!-- 根据关联关系查询对应人的邮箱 -->
	<select id="getSupplierLeadtimeConfig" resultType="java.lang.String" parameterType="java.lang.String" >
	    SELECT t3.`RATE` FROM `SUPPLIER_LEADTIME_RATE` t3 WHERE t3.`PARTY_ID` = #{PARTY_ID} ORDER  BY t3.`LAST_UPDATE_DATE` DESC LIMIT 1
	</select>
	
	<!-- 根据关联关系查询对应人的邮箱 -->
	<select id="getSuplierrelationShipMail" resultMap="SupplierMailResultMap" parameterType="java.lang.String" >
	    SELECT T1.PARTY_ID , T1.GROUP_NAME FROM PARTY_GROUP T1 WHERE T1.PARTY_ID = #{supplierId}
	</select>
	
	<!-- 根据关联关系查询对应人的邮箱 -->
	<select id="getPrincipalMails" resultType="java.lang.String" parameterType="java.lang.String" >
	    SELECT t2.`MAIL` FROM PARTY_RELATIONSHIP t1 LEFT JOIN PERSON t2 ON t1.`PARTY_ID_FROM` =  t2.`PARTY_ID` 
	    WHERE t1.`PARTY_ID_TO` = #{PARTY_ID}
	    AND t1.`ROLE_TYPE_ID_FROM` = 'OPERATION_REP' 
		AND t1.`ROLE_TYPE_ID_TO` = 'SUPPLIER' 
		AND t1.`PARTY_RELATIONSHIP_TYPE_ID` = 'DEVELOPMENT_BY' 
		AND (t1.`THRU_DATE` IS NULL OR t1.`THRU_DATE` > NOW())
	</select>
	
	<!-- 根据关联关系查询对应人的邮箱 -->
	<select id="getInquiryMails" resultType="java.lang.String" parameterType="java.lang.String" >
	    SELECT t2.`MAIL` FROM PARTY_RELATIONSHIP t1 LEFT JOIN PERSON t2 ON t1.`PARTY_ID_FROM` =  t2.`PARTY_ID` 
	    WHERE t1.`PARTY_ID_TO` = #{PARTY_ID}
	    AND t1.`ROLE_TYPE_ID_FROM` = 'SUPPLIER' 
		AND t1.`ROLE_TYPE_ID_TO` = 'INQUIRY_SPECIALIST' 
		AND t1.`PARTY_RELATIONSHIP_TYPE_ID` = 'VENDOR_ENQUIRY_REL' 
		AND (t1.`THRU_DATE` IS NULL OR t1.`THRU_DATE` > NOW())
	</select>
	
</mapper>