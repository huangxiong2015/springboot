package com.yikuyi.party.acl.bll;

import java.util.Date;
import java.util.List;
import java.util.Set;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.framewrok.springboot.web.RequestHelper;
import com.yikuyi.party.contact.vo.MsgResultVo;
import com.yikuyi.party.dept.dao.roleDao;
import com.yikuyi.party.enterprise.bll.EnterpriseManager;
import com.yikuyi.party.model.Party;
import com.yikuyi.party.party.dao.PartyPermissionDao;
import com.yikuyi.party.party.dao.PartyRoleDao;
import com.yikuyi.party.role.model.RoleType;
import com.yikuyi.party.vo.RoleTypeVo;
import com.yikuyi.party.vo.RoleVo;

/**
 * @author tangr
 *
 */
@Service
@Transactional
public class ACLManager {

	
	private static final Logger logger = LoggerFactory.getLogger(ACLManager.class);
	
	@Autowired
	private PartyRoleDao partyRoleDao;
	
	@Autowired
	private PartyPermissionDao partyPermissionDao;
	
	@Autowired
	private EnterpriseManager enterpriseManager;
	
	@Autowired
	private roleDao roleDao;
	
    /**
     * 获取当前用户所有的角色数据
     * @param user
     * @return
     * @author tangrong@yikuyi.com
     */
	@Cacheable(value="userShiroAuthorityInfoCache", key="'roles-user-[' + #partyId + ']'")
    public Set<String> getUserRoleList(String partyId){
    	return partyRoleDao.findRoleByPartyId(partyId);
    }
    
    
	/**12
	  * 获取当前用户所有权限数据
	  * @param user
	  * @return
	  * @author tangrong@yikuyi.com
	  */
	@Cacheable(value="userShiroAuthorityInfoCache",key="'permissions-user-[' + #partyId + ']'")
	 public Set<String> getUserPermissionList(String partyId){
		 String partyGroupId = partyId;
		 Party party = enterpriseManager.getPartyGroupByEmployeeId(partyId);
		 if(party!= null && party.getId() !=null){
			 partyGroupId = party.getId();
		 }
		 return partyPermissionDao.findPermissionByPartyId(partyGroupId, partyId);
	 }

	/**
	 * 根据角色id查询用户
	 * @param role
	 * @return
	 * @since 2017年2月28日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public List<Party> getUserByRole(String role) {
		return partyRoleDao.getUserByRole(role);
	}
	
	/**
	 * 查询用户菜单角色
	 * @param role
	 * @return
	 * @since 2017年4月17日
	 * @author zr.helinmei@yikuyi.com
	 */
	public List<RoleTypeVo> getMenuRole(RoleType roleType) {
		return partyRoleDao.getMenuRole(roleType);
		
	}
	
	public MsgResultVo addRoelMenuRelaction(RoleVo vo ){
		//先删除之前分配的角色菜单关系
		MsgResultVo msgResultVo = new MsgResultVo();
		try {
			String menuId = vo.getMenuType()+":"+vo.getMenuPower()+":"+vo.getMenuId(); 
			roleDao.deleteRoleByMenuId(menuId);
			String userId = RequestHelper.getLoginUserId();
			Date date = new Date();
			vo.setMenuId(menuId);
			vo.setCreator(userId);
			vo.setCreatedDate(date);
			vo.setLastUpdateUser(userId);
			vo.setLastUpdateDate(date);
			roleDao.securityRolePermissionSave(vo);
			msgResultVo.setCode("SUCCESS");
			return msgResultVo;
		} catch (Exception e) {
			logger.error("编辑菜单角色关系异常：{}",e);
			msgResultVo.setCode("FAILED");
			return msgResultVo;
		}
		
	}
}