<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yikuyi.party.partygroup.dao.PartyRelationshipDao" >
  <resultMap id="BaseResultMap" type="com.yikuyi.party.model.PartyRelationship" >
    <id column="PARTY_ID_FROM" property="partyIdFrom" jdbcType="VARCHAR" />
    <id column="PARTY_ID_TO" property="partyIdTo" jdbcType="VARCHAR" />
    <id column="ROLE_TYPE_ID_FROM" property="roleTypeIdFrom" jdbcType="VARCHAR" />
    <id column="ROLE_TYPE_ID_TO" property="roleTypeIdTo" jdbcType="VARCHAR" />
    <id column="FROM_DATE" property="fromDate" jdbcType="TIMESTAMP" />
    <result column="THRU_DATE" property="thruDate" jdbcType="TIMESTAMP" />
    <result column="STATUS_ID" property="statusId" jdbcType="VARCHAR" />
    <result column="RELATIONSHIP_NAME" property="relationshipName" jdbcType="VARCHAR" />
    <result column="SECURITY_GROUP_ID" property="securityGroupId" jdbcType="VARCHAR" />
    <result column="PRIORITY_TYPE_ID" property="priorityTypeId" jdbcType="VARCHAR" />
    <result column="PARTY_RELATIONSHIP_TYPE_ID" property="partyRelationshipTypeId" jdbcType="VARCHAR" />
    <result column="PERMISSIONS_ENUM_ID" property="permissionsEnumId" jdbcType="VARCHAR" />
    <result column="POSITION_TITLE" property="positionTitle" jdbcType="VARCHAR" />
    <result column="COMMENTS" property="comments" jdbcType="VARCHAR" />
    <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
    <result column="CREATED_DATE" property="createdDate" jdbcType="TIMESTAMP" />
    <result column="LAST_UPDATE_USER" property="lastUpdateUser" jdbcType="VARCHAR" />
    <result column="LAST_UPDATE_DATE" property="lastUpdateDate" jdbcType="TIMESTAMP" />
  </resultMap>
  
  <sql id="Base_Column_List">
	  PARTY_ID_FROM,PARTY_ID_TO,ROLE_TYPE_ID_FROM,ROLE_TYPE_ID_TO,FROM_DATE,THRU_DATE,
	  STATUS_ID,RELATIONSHIP_NAME,SECURITY_GROUP_ID,PRIORITY_TYPE_ID,PARTY_RELATIONSHIP_TYPE_ID,
	  PERMISSIONS_ENUM_ID,POSITION_TITLE,COMMENTS,CREATOR,CREATED_DATE,LAST_UPDATE_USER,LAST_UPDATE_DATE
  </sql>
	<select id="getPartyRelationship" resultMap="BaseResultMap" parameterType="com.yikuyi.party.model.PartyRelationship">
		SELECT 
		<include refid="Base_Column_List"></include>
		FROM
		  PARTY_RELATIONSHIP 
		where 1=1
      <if test="partyIdFrom != null" >
        and PARTY_ID_FROM = #{partyIdFrom}
      </if>
      <if test="partyIdTo != null" >
        and PARTY_ID_TO = #{partyIdTo}
      </if>
      <if test="roleTypeIdFrom != null" >
        and ROLE_TYPE_ID_FROM = #{roleTypeIdFrom}
      </if>
      <if test="roleTypeIdTo != null" >
        and ROLE_TYPE_ID_TO = #{roleTypeIdTo}
      </if>
      <if test="fromDate != null" >
        and FROM_DATE = #{fromDate}
      </if>
      <if test="statusId != null" >
        and STATUS_ID = #{statusId}
      </if>
      and (`THRU_DATE` > NOW() or THRU_DATE is null)
      order by LAST_UPDATE_DATE desc
	</select>
  <insert id="insert" parameterType="com.yikuyi.party.model.PartyRelationship" >
    insert into PARTY_RELATIONSHIP
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="partyIdFrom != null" >
        PARTY_ID_FROM,
      </if>
      <if test="partyIdTo != null" >
        PARTY_ID_TO,
      </if>
      <if test="roleTypeIdFrom != null" >
        ROLE_TYPE_ID_FROM,
      </if>
      <if test="roleTypeIdTo != null" >
        ROLE_TYPE_ID_TO,
      </if>
      <if test="fromDate != null" >
        FROM_DATE,
      </if>
      <if test="thruDate != null" >
        THRU_DATE,
      </if>
      <if test="statusId != null" >
        STATUS_ID,
      </if>
      <if test="relationshipName != null" >
        RELATIONSHIP_NAME,
      </if>
      <if test="securityGroupId != null" >
        SECURITY_GROUP_ID,
      </if>
      <if test="priorityTypeId != null" >
        PRIORITY_TYPE_ID,
      </if>
      <if test="partyRelationshipTypeId != null" >
        PARTY_RELATIONSHIP_TYPE_ID,
      </if>
      <if test="permissionsEnumId != null" >
        PERMISSIONS_ENUM_ID,
      </if>
      <if test="positionTitle != null" >
        POSITION_TITLE,
      </if>
      <if test="comments != null" >
        COMMENTS,
      </if>
      <if test="creator != null" >
        CREATOR,
      </if>
      <if test="createdDate != null" >
        CREATED_DATE,
      </if>
      <if test="lastUpdateUser != null" >
        LAST_UPDATE_USER,
      </if>
      <if test="lastUpdateDate != null" >
        LAST_UPDATE_DATE,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="partyIdFrom != null" >
        #{partyIdFrom,jdbcType=VARCHAR},
      </if>
      <if test="partyIdTo != null" >
        #{partyIdTo,jdbcType=VARCHAR},
      </if>
      <if test="roleTypeIdFrom != null" >
        #{roleTypeIdFrom,jdbcType=VARCHAR},
      </if>
      <if test="roleTypeIdTo != null" >
        #{roleTypeIdTo,jdbcType=VARCHAR},
      </if>
      <if test="fromDate != null" >
        #{fromDate,jdbcType=TIMESTAMP},
      </if>
      <if test="thruDate != null" >
        #{thruDate,jdbcType=TIMESTAMP},
      </if>
      <if test="statusId != null" >
        #{statusId,jdbcType=VARCHAR},
      </if>
      <if test="relationshipName != null" >
        #{relationshipName,jdbcType=VARCHAR},
      </if>
      <if test="securityGroupId != null" >
        #{securityGroupId,jdbcType=VARCHAR},
      </if>
      <if test="priorityTypeId != null" >
        #{priorityTypeId,jdbcType=VARCHAR},
      </if>
      <if test="partyRelationshipTypeId != null" >
        #{partyRelationshipTypeId,jdbcType=VARCHAR},
      </if>
      <if test="permissionsEnumId != null" >
        #{permissionsEnumId,jdbcType=VARCHAR},
      </if>
      <if test="positionTitle != null" >
        #{positionTitle,jdbcType=VARCHAR},
      </if>
      <if test="comments != null" >
        #{comments,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        #{creator,jdbcType=VARCHAR},
      </if>
      <if test="createdDate != null" >
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="lastUpdateUser != null" >
        #{lastUpdateUser,jdbcType=VARCHAR},
      </if>
      <if test="lastUpdateDate != null" >
        #{lastUpdateDate,jdbcType=TIMESTAMP},
      </if>
    </trim>
  </insert>
 <update id="updateRelationShip" parameterType="com.yikuyi.party.model.PartyRelationship" >
     update PARTY_RELATIONSHIP 
     <set >
      <if test="thruDate != null">
		 THRU_DATE = #{thruDate,jdbcType=TIMESTAMP},
	  </if>
	   <if test="statusId != null">
		 STATUS_ID = #{statusId,jdbcType=VARCHAR},
	  </if>
    </set>
       where 1=1
       <if test="partyIdFrom != null">
		and  PARTY_ID_FROM = #{partyIdFrom,jdbcType=VARCHAR}
	   </if>
       <if test="partyIdTo != null">
		 and PARTY_ID_TO = #{partyIdTo,jdbcType=VARCHAR}
	  </if>
	  <if test="roleTypeIdFrom != null">
		 and ROLE_TYPE_ID_FROM = #{roleTypeIdFrom,jdbcType=VARCHAR}
	  </if>
	  <if test="roleTypeIdTo != null">
		 and ROLE_TYPE_ID_TO = #{roleTypeIdTo,jdbcType=VARCHAR}
	  </if>
	  <if test="partyRelationshipTypeId != null">
		 and PARTY_RELATIONSHIP_TYPE_ID = #{partyRelationshipTypeId,jdbcType=VARCHAR}
	  </if>
	  <if test="relationshipName != null">
		 and RELATIONSHIP_NAME = #{relationshipName,jdbcType=VARCHAR}
	  </if>
  </update>
  
  <select id="findByApplyId" resultMap="BaseResultMap" parameterType="com.yikuyi.party.model.PartyRelationship">
	 SELECT t.`PARTY_ID_TO` FROM PARTY_RELATIONSHIP t WHERE t.`PARTY_ID_FROM`= #{partyIdFrom,jdbcType=VARCHAR}  AND t.`ROLE_TYPE_ID_TO`=#{roleTypeIdTo,jdbcType=VARCHAR} AND t.`PARTY_ID_TO` != #{partyIdTo,jdbcType=VARCHAR}
  </select>
  
  <select id="getAllPartyRelationship" resultType="java.lang.String">
	 SELECT t.`PARTY_ID_FROM` FROM PARTY_RELATIONSHIP t WHERE 1=1 
	 AND t.PARTY_RELATIONSHIP_TYPE_ID='REPORTS_TO'
	 AND (t.THRU_DATE > NOW() or t.THRU_DATE is null)
	 <if test="userId != null"> 
	 	AND t.`PARTY_ID_TO`= #{userId}
	 </if>
	 <if test="userIds != null and userIds.size() > 0">
	 	AND t.`PARTY_ID_FROM`in
		<foreach item="item" index="index" collection="userIds" open="(" separator="," close=")">
            #{item}  
	    </foreach>
	 </if>
	 order by t.LAST_UPDATE_DATE desc
  </select>
  
  <select id="findpartyIdByEnterpriseId" resultMap="BaseResultMap" parameterType="java.lang.String">
  select  
  	  PARTY_ID_FROM,
	  PARTY_ID_TO,
	  ROLE_TYPE_ID_FROM,
	  ROLE_TYPE_ID_TO,
	  FROM_DATE,
	  THRU_DATE,
	  STATUS_ID,
	  RELATIONSHIP_NAME,
	  SECURITY_GROUP_ID,
	  PRIORITY_TYPE_ID,
	  PARTY_RELATIONSHIP_TYPE_ID,
	  PERMISSIONS_ENUM_ID,
	  POSITION_TITLE,
	  COMMENTS,
	  CREATOR,
	  CREATED_DATE,
	  LAST_UPDATE_USER,
	  LAST_UPDATE_DATE 
   from PARTY_RELATIONSHIP  where PARTY_ID_TO=#{enterpriseId} and ROLE_TYPE_ID_TO='CORPORATION' and ROLE_TYPE_ID_FROM='MAIN_ROLE' and THRU_DATE is null
  </select>
  
  <select id="getAgentByPartyfromTo" resultMap="BaseResultMap">
  	SELECT 
	  PARTY_ID_FROM,
	  PARTY_ID_TO,
	  ROLE_TYPE_ID_FROM,
	  ROLE_TYPE_ID_TO,
	  FROM_DATE,
	  THRU_DATE,
	  STATUS_ID,
	  RELATIONSHIP_NAME,
	  SECURITY_GROUP_ID,
	  PRIORITY_TYPE_ID,
	  PARTY_RELATIONSHIP_TYPE_ID,
	  PERMISSIONS_ENUM_ID,
	  POSITION_TITLE,
	  COMMENTS,
	  CREATOR,
	  CREATED_DATE,
	  LAST_UPDATE_USER,
	  LAST_UPDATE_DATE 
  FROM PARTY_RELATIONSHIP t
  WHERE t.PARTY_ID_TO=#{partyIdTo}
  AND t.RELATIONSHIP_NAME=#{name} and THRU_DATE is null
  </select>
</mapper>