/*
 * Created: 2016年11月28日
 *
 * Shenzhen Yikuyi Co., Ltd. All rights reserved. 
 * Copyright (c) 2015-2016 
 * License, Version 1.0. Published by Yikuyi IT department.
 *
 * For the convenience of communicating and reusing of codes,
 * any java names, variables as well as comments should be written according to the regulations strictly.
 */
package com.yikuyi.party.register.bll;


import java.text.SimpleDateFormat;
import java.util.Date;

import org.apache.commons.codec.binary.Base64;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;
import org.springframework.web.client.RestTemplate;

import com.alibaba.fastjson.JSONObject;
import com.yikuyi.message.mail.vo.MailInfoVo;
import com.yikuyi.message.sms.vo.MailAddressValidVO;
import com.yikuyi.party.contact.model.ContactMech;
import com.yikuyi.party.contact.model.PostalAddress;
import com.yikuyi.party.contact.vo.UserVo;
import com.yikuyi.party.customer.bll.CustomerSummeryManager;
import com.yikuyi.party.customer.dao.PersonDao;
import com.yikuyi.party.group.model.PartyGroup;
import com.yikuyi.party.group.model.PartyGroup.AccountStatus;
import com.yikuyi.party.group.model.PartyGroup.ActiveStatus;
import com.yikuyi.party.login.model.UserLogin;
import com.yikuyi.party.login.model.UserLogin.PwdStrength;
import com.yikuyi.party.login.model.UserLogin.UserLoginMethod;
import com.yikuyi.party.model.Party;
import com.yikuyi.party.model.Party.PartyStatus;
import com.yikuyi.party.model.Party.PartyType;
import com.yikuyi.party.model.PartyAttribute;
import com.yikuyi.party.model.PartyAttributes;
import com.yikuyi.party.model.PartyContactMech;
import com.yikuyi.party.model.PartyContactMech.PurposeType;
import com.yikuyi.party.model.PartyRelationship;
import com.yikuyi.party.model.PartyRelationship.PartyRelationshipType;
import com.yikuyi.party.party.dao.PartyAttributeDao;
import com.yikuyi.party.party.dao.PartyDao;
import com.yikuyi.party.party.dao.PartyRoleDao;
import com.yikuyi.party.partygroup.dao.PartyGroupDao;
import com.yikuyi.party.partygroup.dao.PartyRelationshipDao;
import com.yikuyi.party.person.model.Person;
import com.yikuyi.party.role.model.RoleType;
import com.yikuyi.party.shipAddress.bll.PartyContactMechManager;
import com.yikuyi.party.userLogin.dao.UserLoginDao;
import com.ykyframework.model.IdGen;
import com.ykyframework.mqservice.sender.MsgSender;


@Service
@Transactional
public class RegisterManager {
	private static final Logger logger = LoggerFactory.getLogger(RegisterManager.class);
	@Autowired
	private PartyDao partyDao;
	@Autowired
	private PersonDao personDao;
	@Autowired
	private UserLoginDao userLoginDao;
	@Autowired
	private PartyRoleDao partyRoleDao;
	@Autowired
	private PartyGroupDao partyGroupDao;
	@Autowired
	private PartyAttributeDao partyAttributeDao;
	@Autowired
	private PartyRelationshipDao relationshipDao;
	
	@Autowired
	private PartyContactMechManager partyContactMechManager;	
	@Autowired
	private CustomerSummeryManager customerSummeryManager;	
	@Autowired
	private RestTemplate restTemplate;
	
	public static final String SUCCESS = "success";
	
	@Value("${api.message.serverUrlPrefix}")
	private String serverUrl;
	@Value("${customer.serverUrlPrefix}")
	private String customerUrl;
	@Autowired
	private MsgSender msgSender;

	@Value("${mqConsumeConfig.sendMsgAndEmail.topicName}")
	private String sendMsgAndEmailTopicName;
	private static final String CORPORATION_CATEGORY_ID = "CORPORATION_CATEGORY_ID";//公司类型
	private static final String INDUSTRY_CATEGORY_ID = "INDUSTRY_CATEGORY_ID";//所属行业
	private static final String INDUSTRY_CATEGORY_ID_OTHER = "INDUSTRY_CATEGORY_ID_OTHER";//所属行业其它属性拓展属性
	private static final String STATUS_ID = "ENABLE";
	/**
	 * 个人注册
	 * @param userVo
	 * @since 2017年1月12日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public String save(UserVo userVo) {
		//a.校验图片验证码
		String flag = verifyCode(userVo);
		if("fail".equals(flag)){
			flag = "verifyFail";
			return flag;
		}
        savePerson(userVo);
        flag = SUCCESS;
		return flag;
		
	}


	public void savePerson(UserVo userVo) {
		//b.保存接口： PARTY表里面生成记录， PARTY_TYPE  设置为： PERSON ，STATUS_ID 初始化为:  ACTIVE；
		String id = String.valueOf(IdGen.getInstance().nextId());
		Party party = new Party();
		party.setId(id);
		party.setPartyType(PartyType.PERSON);
		party.setPartyStatus(PartyStatus.PARTY_ENABLED);
		party.setCreator(id);
		party.setCreatedDate(new Date());
		party.setLastUpdateDate(new Date());
		party.setLastUpdateUser(id);
		partyDao.insert(party);
        //PERSON 表生成记录 PARTY_ID 和  PARTY表一致。
		Person person = new Person();
		person.setLastNameLocal(userVo.getMobile());
		person.setMail(userVo.getMail());
		person.setTel(userVo.getMobile());
		person.setTelStatus(1);
		person.setMailStatus(0);
		party.setPerson(person);
		personDao.insert(party);
		//c.生成登录数据USER_LOGIN  字段： ENABLED = ‘Y’ , PARTY_ID 和 PARTY表一致， USER_LOGIN_ID =  刚刚注册的手机号。
		UserLogin userLogin = new UserLogin();
		userLogin.setId(userVo.getMobile());
		userLogin.setParty(party);
		userLogin.setCurrentPassword(userVo.getPassword());
		userLogin.setEnabled("Y");
		userLogin.setIsSystem("N");
		userLogin.setRequirePasswordChange("N");
		userLogin.setUserLoginMethod(UserLoginMethod.MOBILE.toString());
		userLogin.setCreatedDate(new Date());
		userLogin.setLastUpdateDate(new Date());
		//密码强度 
		PwdStrength pwdStrength = customerSummeryManager.checkedPwdStrong(userVo.getPassword());
		userLogin.setPwdStrength(pwdStrength);
		userLoginDao.insert(userLogin);
        
        //d.生成 PARTY_ROLE 数据  ROLE_TYPE_ID 为：CUSTOMER
		partyRoleDao.insert(id, RoleType.CUSTOMER.toString(),id,new Date(),id,new Date());
		partyRoleDao.insert(id, RoleType.INDIVIDUAL_CUST.toString(),id,new Date(),id,new Date());
	}

	/**
	 * 校验验证码
	 * @param userVo
	 * @return
	 * @since 2017年4月28日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public String verifyCode(UserVo userVo) {
		String flag = "fail";
		if(StringUtils.isEmpty(userVo.getUuid()) || StringUtils.isEmpty(userVo.getImgCode())){
			return flag;
		}
		String url = serverUrl + "/v1/img/verifycode?uuid="+userVo.getUuid() +"&imgValidCode="+userVo.getImgCode();
		ResponseEntity<String> response;
		try{
			response = restTemplate.exchange(url, HttpMethod.POST, null, String.class);
			flag = response.getBody();
		}catch(Exception e){
			logger.error("调用图片验证码失败:{}",e);
		}
		return flag;
	}

	/**
	 * 获取验证码
	 * @param userVo
	 * @return
	 * @since 2017年4月28日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public String getVerifyCode(UserVo userVo) {
		String code = "";
		if(StringUtils.isEmpty(userVo.getUuid()) || StringUtils.isEmpty(userVo.getMail())){
			return code;
		}
		String url = serverUrl + "/v1/mail/verifyCode";
		ResponseEntity<String> response;
		try{
			MailAddressValidVO vo = new MailAddressValidVO();
			vo.setUuid(userVo.getUuid());
			vo.setMailAddress(userVo.getMail());
			HttpEntity<MailAddressValidVO> entity = new HttpEntity<>(vo, getHttpHeaders());
			response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
			code = response.getBody();
		}catch(Exception e){
			logger.error("调用获取邮箱验证码失败:{}",e);
		}
		return code;
	}
	
	public HttpHeaders getHttpHeaders(){
		HttpHeaders headers = new HttpHeaders();
		MediaType type = MediaType.parseMediaType("application/json; charset=UTF-8");
		headers.setContentType(type);
		headers.add("Accept", MediaType.APPLICATION_JSON.toString());
		return headers ;
	}
	/**
	 * 企业注册
	 * @param userVo
	 * @since 2017年1月12日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public String saveEnt(UserVo userVo) {

		//a.校验图片验证码 
		String flag = verifyCode(userVo);
		if(StringUtils.isEmpty(userVo.getMail())){
			flag = "empty";
			return flag;
		}
		if("fail".equals(flag)){
			flag = "verifyFail";
			return flag;
		}
		//获取邮箱验证码
		String code = this.getVerifyCode(userVo);
		logger.info("获取邮箱验证码code = "+code);
		if(StringUtils.isEmpty(code)){
			flag = "codeEmpty";
			return flag;
		}
		userVo.setImgCode(code);
		//判断之前是否注册过，并且注册没有成功（根据邮箱）
		UserLogin login = userLoginDao.findEntityById(userVo.getMail());
		if(login != null){
			if("Y".equals(login.getEnabled())){
				flag = "exist";
				return flag;
			}else{
				flag = SUCCESS;
				//发送邮件给用户
				flag = sendMail(userVo);
				return flag;
			}
			
		}
		//发送邮件给用户
		flag = sendMail(userVo);

		//判断是否为重复发送邮件
		if(!StringUtils.isEmpty(userVo.getReSend()) && "Y".equals(userVo.getReSend())){
			return flag;
		}
		if(!SUCCESS.equals(flag)){
			return flag;
		}

        //b.保存接口： PARTY表里面生成记录， PARTY_TYPE  设置为： PERSON ，STATUS_ID 
		saveEnterprise(userVo);
		flag = SUCCESS;
		return flag;
	}


	/**
	 * 企业注册保存
	 * @param userVo
	 * @since 2017年4月28日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public void saveEnterprise(UserVo userVo) {
		//1.保存企业信息
		String entId = this.createEnt(userVo);
		//2.保存账号信息
		String userId = this.createPerson(userVo,entId);
		//3.保存企业与账号的关联关系
		saveRelationShip(userId,entId);
	}


	/**
	 * 保存账号信息
	 * @param userVo
	 * @return
	 * @since 2017年4月28日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	private String createPerson(UserVo userVo,String entId) {
		//1.保存账号信息
		String id = String.valueOf(IdGen.getInstance().nextId());
		Party party = new Party();
		party.setId(id);
		party.setPartyType(PartyType.PERSON);
		party.setPartyStatus(PartyStatus.PARTY_ENABLED);
		party.setCreator(id);
		party.setCreatedDate(new Date());
		party.setLastUpdateDate(new Date());
		party.setLastUpdateUser(id);
		party.setCorporationId(entId);
		partyDao.insert(party);
        //PERSON 表生成记录 PARTY_ID 和  PARTY表一致。
		Person person = new Person();
		person.setLastNameLocal(userVo.getName());
		person.setMail(userVo.getMail());
		person.setPersonalTitle(userVo.getPersonalTitle());
		person.setTel(userVo.getMobile());
		person.setTelStatus(1);
		person.setMailStatus(1);
		party.setPerson(person);
		personDao.insert(party);
		//c.生成登录数据USER_LOGIN  字段： ENABLED = ‘Y’ , PARTY_ID 和 PARTY表一致， USER_LOGIN_ID =  刚刚注册的手机号。
		UserLogin userLogin = new UserLogin();
		userLogin.setId(userVo.getMail());
		userLogin.setParty(party);
		userLogin.setEnabled("N");
		userLogin.setIsSystem("N");
		userLogin.setRequirePasswordChange("N");
		userLogin.setUserLoginMethod(UserLoginMethod.EMAIL.toString());
		userLogin.setCreatedDate(new Date());
		userLogin.setLastUpdateDate(new Date());
		userLogin.setCurrentPassword(userVo.getPassword());
		//密码强度 
		PwdStrength pwdStrength = customerSummeryManager.checkedPwdStrong(userVo.getPassword());
		userLogin.setPwdStrength(pwdStrength);
		userLoginDao.insert(userLogin);
        
        //d.生成 PARTY_ROLE 数据  ROLE_TYPE_ID 为：REGISTER
		partyRoleDao.insert(id, RoleType.MAIN_ROLE.toString(),id,new Date(),id,new Date());
		partyRoleDao.insert(id, RoleType.ENTERPRISE_CUST.toString(),id,new Date(),id,new Date());
		return id;
	}


	/**
	 * 保存企业信息
	 * @param userVo
	 * @return
	 * @since 2017年4月28日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	private String createEnt(UserVo userVo) {
		String id = String.valueOf(IdGen.getInstance().nextId());
		Party party = new Party();
		party.setId(id);
		party.setPartyStatus(PartyStatus.PARTY_ENABLED);
		party.setLastUpdateDate(new Date());
		party.setLastUpdateUser(id);
		partyDao.updateParty(party);

		PartyGroup partyGroup = new PartyGroup();
		partyGroup.setGroupName(userVo.getCompanyName());
		partyGroup.setLastUpdateUser(id);
		partyGroup.setLastUpdateDate(new Date());
		partyGroup.setActiveStatus(ActiveStatus.PARTY_NOT_VERIFIED);
		partyGroup.setAccountStatus(AccountStatus.PARALLEL_ACCOUNT);
		party.setPartyGroup(partyGroup);
		partyGroupDao.insert(party);

		// 插入属性表,公司类型
		PartyAttributes corCategoryAttrs = new PartyAttributes();
		PartyAttribute corCategoryAttr = new PartyAttribute();
		corCategoryAttr.setKey(CORPORATION_CATEGORY_ID);
		corCategoryAttr.setValue(userVo.getCorCategory());
		corCategoryAttrs.setCorporationCategory(corCategoryAttr);
		party.setPartyAttributes(corCategoryAttrs);
		partyAttributeDao.insertCorporationCategory(party);

		// 插入属性表,所属行业
		PartyAttributes industryAttrs = new PartyAttributes();
		PartyAttribute industryAttr = new PartyAttribute();
		industryAttr.setKey(INDUSTRY_CATEGORY_ID);
		industryAttr.setValue(userVo.getIndustryCategory());
		industryAttrs.setIndustryCategory(industryAttr);
		party.setPartyAttributes(industryAttrs);
		partyAttributeDao.insertIndustryCategory(party);
		//设置other值  
		PartyAttributes otherAttrs = new PartyAttributes();
		PartyAttribute otherAttr = new PartyAttribute();
		otherAttr.setKey(INDUSTRY_CATEGORY_ID_OTHER);
		otherAttr.setValue(userVo.getOtherAttr());
		otherAttrs.setOtherAttrs(otherAttr);
		party.setPartyAttributes(otherAttrs);
		partyAttributeDao.insertOtherAttrs(party);

		//创建企业注册地址
		this.saveAddr(userVo,id);
		
		return id;
	}


	/**
	 * 创建企业注册地址
	 * @param userVo
	 * @param entId
	 * @since 2017年4月28日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	private void saveAddr(UserVo userVo,String entId) {
		PartyContactMech partyContactMech = new PartyContactMech();
		partyContactMech.setPurposeType(PurposeType.REGISTER_LOCATION);
		ContactMech contactMech = new ContactMech();
		PostalAddress postalAddress = new PostalAddress();
		postalAddress.setAddress1(userVo.getAddress());
		postalAddress.setCountryGeoName("中国");
		postalAddress.setCountryGeoId("china");

		postalAddress.setProvinceGeoName(userVo.getProvinceName());
		postalAddress.setProvinceGeoId(userVo.getProvince());

		postalAddress.setCountyGeoName(userVo.getCountryName());
		postalAddress.setCountyGeoId(userVo.getCountry());

		postalAddress.setCityGeoName(userVo.getCityName());
		postalAddress.setCityGeoId(userVo.getCity());

		contactMech.setPostalAddress(postalAddress);


		partyContactMech.setContactMech(contactMech);
		partyContactMech.setPartyId(entId);
		partyContactMechManager.insert(partyContactMech);
		
	}

	/**
	 * 保存企业与账号的关联关系
	 * @param userId
	 * @param id
	 * @since 2017年4月28日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	private void saveRelationShip(String userId, String id) {
		// 插入企业与注册用户的关联关系 主账号
		PartyRelationship relationShip = new PartyRelationship();
		relationShip.setPartyIdFrom(userId);// 当前的登录用户partyId
		relationShip.setPartyIdTo(id);// 企业partyId
		relationShip.setRoleTypeIdTo(RoleType.CORPORATION);
		relationShip.setRelationshipName("职位代表");
		relationShip.setStatusId(STATUS_ID);
		relationShip.setFromDate(new Date());
		relationShip.setCreator(userId);
		relationShip.setCreatedDate(new Date());
		relationShip.setLastUpdateUser(userId);
		relationShip.setLastUpdateDate(new Date());
		relationShip.setRoleTypeIdFrom(RoleType.EMPLOYEE);
		relationShip.setPartyRelationshipTypeId(PartyRelationshipType.EMPLOYMENT);
		relationShip.setRelationshipName("雇佣");
		relationshipDao.insert(relationShip);
	}
	/**
	 * 发送邮件
	 * @param userVo
	 * @since 2017年2月9日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public String sendMail(UserVo userVo) {
		String flag = SUCCESS;
		try {
			logger.info("给用户发送一封邮件"+userVo.getMail());
			//parms :第一个参数：发送时间    第二个参数：邮箱    第三个参数：验证码
			SimpleDateFormat format = new SimpleDateFormat("yyyyMMddHHmmss");
			String senddate = format.format(new Date());
			String mail = userVo.getMail();
			String imgCode = userVo.getImgCode();
			String sid = senddate + "---" + mail + "---" +imgCode;
			byte[] b=Base64.encodeBase64(sid.getBytes("utf-8"),true);
			sid = new String(b,"utf-8");
			String url = customerUrl+"/reg.htm?action=fromMail&sid="+sid;
			MailInfoVo mailInfoVo = new MailInfoVo();
			mailInfoVo.setTemplateId(MailInfoVo.TemplateId.REGISTER.toString());
			mailInfoVo.setType(MailInfoVo.Type.EMAIL.toString());
			mailInfoVo.setTo(userVo.getMail());
			JSONObject content = new JSONObject();
			content.put("url", url);
			mailInfoVo.setContent(content);
			msgSender.sendMsg(sendMsgAndEmailTopicName, mailInfoVo, null);
			logger.info("给用户发送一封邮件MailInfoVo:{}"+JSONObject.toJSON(mailInfoVo).toString());
		} catch (Exception e) {
			flag = "sendMailFail";
			logger.error("发送注册邮件MQ出错:{}", e);
		}
		return flag;
	}






}
