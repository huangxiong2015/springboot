/*
 * Created: 2016年11月28日
 *
 * Shenzhen Yikuyi Co., Ltd. All rights reserved. 
 * Copyright (c) 2015-2016 
 * License, Version 1.0. Published by Yikuyi IT department.
 *
 * For the convenience of communicating and reusing of codes,
 * any java names, variables as well as comments should be written according to the regulations strictly.
 */
package com.yikuyi.party.register.bll;


import java.text.SimpleDateFormat;
import java.util.Date;

import org.apache.commons.codec.binary.Base64;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;
import org.springframework.web.client.RestTemplate;

import com.alibaba.fastjson.JSONObject;
import com.yikuyi.message.mail.vo.MailInfoVo;
import com.yikuyi.message.sms.vo.MailAddressValidVO;
import com.yikuyi.party.contact.vo.UserVo;
import com.yikuyi.party.customer.bll.CustomerSummeryManager;
import com.yikuyi.party.customer.dao.PersonDao;
import com.yikuyi.party.login.model.UserLogin;
import com.yikuyi.party.login.model.UserLogin.PwdStrength;
import com.yikuyi.party.login.model.UserLogin.UserLoginMethod;
import com.yikuyi.party.model.Party;
import com.yikuyi.party.model.Party.PartyStatus;
import com.yikuyi.party.model.Party.PartyType;
import com.yikuyi.party.party.dao.PartyDao;
import com.yikuyi.party.party.dao.PartyRoleDao;
import com.yikuyi.party.person.model.Person;
import com.yikuyi.party.role.model.RoleType;
import com.yikuyi.party.userLogin.dao.UserLoginDao;
import com.ykyframework.model.IdGen;
import com.ykyframework.mqservice.sender.MsgSender;


@Service
@Transactional
public class RegisterManager {
	private static final Logger logger = LoggerFactory.getLogger(RegisterManager.class);
	@Autowired
	private PartyDao partyDao;
	@Autowired
	private PersonDao personDao;
	@Autowired
	private UserLoginDao userLoginDao;
	@Autowired
	private PartyRoleDao partyRoleDao;
	@Autowired
	private CustomerSummeryManager customerSummeryManager;	
	@Autowired
	private RestTemplate restTemplate;
	
	public static final String SUCCESS = "success";
	
	@Value("${api.message.serverUrlPrefix}")
	private String serverUrl;
	@Value("${customer.serverUrlPrefix}")
	private String customerUrl;
	@Autowired
	private MsgSender msgSender;

	@Value("${mqConsumeConfig.sendMsgAndEmail.topicName}")
	private String sendMsgAndEmailTopicName;
	/**
	 * 个人注册
	 * @param userVo
	 * @since 2017年1月12日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public String save(UserVo userVo) {
		//a.校验图片验证码
		String flag = verifyCode(userVo);
		if("fail".equals(flag)){
			flag = "verifyFail";
			return flag;
		}
        savePerson(userVo);
        flag = SUCCESS;
		return flag;
		
	}


	public void savePerson(UserVo userVo) {
		//b.保存接口： PARTY表里面生成记录， PARTY_TYPE  设置为： PERSON ，STATUS_ID 初始化为:  ACTIVE；
		String id = String.valueOf(IdGen.getInstance().nextId());
		Party party = new Party();
		party.setId(id);
		party.setPartyType(PartyType.PERSON);
		party.setPartyStatus(PartyStatus.PARTY_ENABLED);
		party.setCreator(id);
		party.setCreatedDate(new Date());
		party.setLastUpdateDate(new Date());
		party.setLastUpdateUser(id);
		partyDao.insert(party);
        //PERSON 表生成记录 PARTY_ID 和  PARTY表一致。
		Person person = new Person();
		person.setLastNameLocal(userVo.getMobile());
		person.setTel(userVo.getMobile());
		party.setPerson(person);
		personDao.insert(party);
		//c.生成登录数据USER_LOGIN  字段： ENABLED = ‘Y’ , PARTY_ID 和 PARTY表一致， USER_LOGIN_ID =  刚刚注册的手机号。
		UserLogin userLogin = new UserLogin();
		userLogin.setId(userVo.getMobile());
		userLogin.setParty(party);
		userLogin.setCurrentPassword(userVo.getPassword());
		userLogin.setEnabled("Y");
		userLogin.setIsSystem("N");
		userLogin.setRequirePasswordChange("N");
		userLogin.setUserLoginMethod(UserLoginMethod.MOBILE.toString());
		userLogin.setCreatedDate(new Date());
		userLogin.setLastUpdateDate(new Date());
		//密码强度 
		PwdStrength pwdStrength = customerSummeryManager.checkedPwdStrong(userVo.getPassword());
		userLogin.setPwdStrength(pwdStrength);
		userLoginDao.insert(userLogin);
        
        //d.生成 PARTY_ROLE 数据  ROLE_TYPE_ID 为：CUSTOMER
		partyRoleDao.insert(id, RoleType.CUSTOMER.toString(),id,new Date(),id,new Date());
		partyRoleDao.insert(id, RoleType.INDIVIDUAL_CUST.toString(),id,new Date(),id,new Date());
	}


	public String verifyCode(UserVo userVo) {
		String flag = "fail";
		if(StringUtils.isEmpty(userVo.getUuid()) || StringUtils.isEmpty(userVo.getImgCode())){
			return flag;
		}
		String url = serverUrl + "/v1/img/verifycode?uuid="+userVo.getUuid() +"&imgValidCode="+userVo.getImgCode();
		ResponseEntity<String> response;
		try{
			response = restTemplate.exchange(url, HttpMethod.POST, null, String.class);
			flag = response.getBody();
		}catch(Exception e){
			logger.error("调用图片验证码失败:{}",e);
		}
		return flag;
	}

	public String getVerifyCode(UserVo userVo) {
		String code = "";
		if(StringUtils.isEmpty(userVo.getUuid()) || StringUtils.isEmpty(userVo.getMail())){
			return code;
		}
		String url = serverUrl + "/v1/mail/verifyCode";
		ResponseEntity<String> response;
		try{
			MailAddressValidVO vo = new MailAddressValidVO();
			vo.setUuid(userVo.getUuid());
			vo.setMailAddress(userVo.getMail());
			HttpEntity<MailAddressValidVO> entity = new HttpEntity<>(vo, getHttpHeaders());
			response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
			code = response.getBody();
		}catch(Exception e){
			logger.error("调用获取邮箱验证码失败:{}",e);
		}
		return code;
	}
	
	public HttpHeaders getHttpHeaders(){
		HttpHeaders headers = new HttpHeaders();
		MediaType type = MediaType.parseMediaType("application/json; charset=UTF-8");
		headers.setContentType(type);
		headers.add("Accept", MediaType.APPLICATION_JSON.toString());
		return headers ;
	}
	/**
	 * 企业注册
	 * @param userVo
	 * @since 2017年1月12日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public String saveEnt(UserVo userVo) {

		//a.校验图片验证码 
		String flag = verifyCode(userVo);
		if(StringUtils.isEmpty(userVo.getMail())){
			flag = "empty";
			return flag;
		}
		if("fail".equals(flag)){
			flag = "verifyFail";
			return flag;
		}
		//获取邮箱验证码
		String code = this.getVerifyCode(userVo);
		logger.info("获取邮箱验证码code = "+code);
		if(StringUtils.isEmpty(code)){
			flag = "codeEmpty";
			return flag;
		}
		userVo.setImgCode(code);
		//发送邮件给用户
		flag = sendMail(userVo);

		//判断是否为重复发送邮件
		if(!StringUtils.isEmpty(userVo.getReSend()) && "Y".equals(userVo.getReSend())){
			return flag;
		}
		if(!SUCCESS.equals(flag)){
			return flag;
		}
		//判断之前是否注册过，并且注册没有成功（根据邮箱）
		UserLogin login = userLoginDao.findEntityById(userVo.getMail());
		if(login != null){
			if("Y".equals(login.getEnabled())){
				flag = "exist";
				return flag;
			}else{
				flag = SUCCESS;
				//发送邮件给用户
				return flag;
			}
		}
        //b.保存接口： PARTY表里面生成记录， PARTY_TYPE  设置为： PERSON ，STATUS_ID 
		saveEnterprise(userVo);
		flag = SUCCESS;
		return flag;
	}


	public void saveEnterprise(UserVo userVo) {
		String id = String.valueOf(IdGen.getInstance().nextId());
		Party party = new Party();
		party.setId(id);
		party.setPartyType(PartyType.PERSON);
		party.setPartyStatus(PartyStatus.PARTY_ENABLED);
		party.setCreator(id);
		party.setCreatedDate(new Date());
		party.setLastUpdateDate(new Date());
		party.setLastUpdateUser(id);
		partyDao.insert(party);
        //PERSON 表生成记录 PARTY_ID 和  PARTY表一致。
		Person person = new Person();
		person.setLastNameLocal(userVo.getMail());
		person.setMail(userVo.getMail());
		party.setPerson(person);
		personDao.insert(party);
		//c.生成登录数据USER_LOGIN  字段： ENABLED = ‘Y’ , PARTY_ID 和 PARTY表一致， USER_LOGIN_ID =  刚刚注册的手机号。
		UserLogin userLogin = new UserLogin();
		userLogin.setId(userVo.getMail());
		userLogin.setParty(party);
		userLogin.setEnabled("N");
		userLogin.setIsSystem("N");
		userLogin.setRequirePasswordChange("N");
		userLogin.setUserLoginMethod(UserLoginMethod.EMAIL.toString());
		userLogin.setCreatedDate(new Date());
		userLogin.setLastUpdateDate(new Date());
		userLoginDao.insert(userLogin);
        
        //d.生成 PARTY_ROLE 数据  ROLE_TYPE_ID 为：REGISTER
		partyRoleDao.insert(id, RoleType.MAIN_ROLE.toString(),id,new Date(),id,new Date());
		partyRoleDao.insert(id, RoleType.ENTERPRISE_CUST.toString(),id,new Date(),id,new Date());
	}


	/**
	 * 发送邮件
	 * @param userVo
	 * @since 2017年2月9日
	 * @author zr.aoxianbing@yikuyi.com
	 */
	public String sendMail(UserVo userVo) {
		String flag = SUCCESS;
		try {
			logger.info("给用户发送一封邮件"+userVo.getMail());
			//parms :第一个参数：发送时间    第二个参数：邮箱    第三个参数：验证码
			SimpleDateFormat format = new SimpleDateFormat("yyyyMMddHHmmss");
			String senddate = format.format(new Date());
			String mail = userVo.getMail();
			String imgCode = userVo.getImgCode();
			String sid = senddate + "---" + mail + "---" +imgCode;
			byte[] b=Base64.encodeBase64(sid.getBytes("utf-8"),true);
			sid = new String(b,"utf-8");
			String url = customerUrl+"/reg.htm?action=fromMail&sid="+sid;
			MailInfoVo mailInfoVo = new MailInfoVo();
			mailInfoVo.setTemplateId(MailInfoVo.TemplateId.REGISTER.toString());
			mailInfoVo.setType(MailInfoVo.Type.EMAIL.toString());
			mailInfoVo.setTo(userVo.getMail());
			JSONObject content = new JSONObject();
			content.put("url", url);
			mailInfoVo.setContent(content);
			msgSender.sendMsg(sendMsgAndEmailTopicName, mailInfoVo, null);
			logger.info("给用户发送一封邮件MailInfoVo:{}"+JSONObject.toJSON(mailInfoVo).toString());
		} catch (Exception e) {
			flag = "sendMailFail";
			logger.error("发送注册邮件MQ出错:{}", e);
		}
		return flag;
	}






}
