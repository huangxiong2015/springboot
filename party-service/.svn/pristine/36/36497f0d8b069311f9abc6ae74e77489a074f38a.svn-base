<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yikuyi.party.customer.dao.PersonDao">
	<resultMap id="BaseResultMap" type="com.yikuyi.party.model.Party">
		<id column="PARTY_ID" property="id" jdbcType="VARCHAR" />
	   <association property="person" javaType="com.yikuyi.party.person.model.Person"> 
          <result column="GENDER" property="gender" jdbcType="VARCHAR" />
          <result column="RELATION_STATUS_ID" property="relationSratus"/>
          <result column="LAST_NAME_LOCAL" property="lastNameLocal" jdbcType="VARCHAR" />
          <result column="CREATED_DATE" property="createdDate" jdbcType="TIMESTAMP" />
          <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
          <result column="LAST_UPDATE_DATE" property="lastUpdateDate" jdbcType="TIMESTAMP" />
          <result column="LAST_UPDATE_USER" property="lastUpdateUser" jdbcType="VARCHAR" />
          <result column="TEL" property="tel" jdbcType="VARCHAR" />
          <result column="MAIL" property="mail" jdbcType="VARCHAR" />
          <result column="PERSONAL_TITLE" property="personalTitle" />
          <result column="TEL_VERIFIED" property="telStatus"/>
          <result column="MAIL_VERIFIED" property="mailStatus"/>
          <result column="ACCOUNT_TYPE" property="personTypeStatus"/>
          <result column="LOGO_IMAGE_URL" property="logoImageUrl"/>
          <result column="FIXEDTEL" property="fixedTel"/>
          
       </association>
	</resultMap>
	<resultMap id="BasePersonMap" type="com.yikuyi.party.person.model.Person">
		<result column="GENDER" property="gender" jdbcType="VARCHAR" />
	    <result column="RELATION_STATUS_ID" property="relationSratus"/>
	    <result column="LAST_NAME_LOCAL" property="lastNameLocal" jdbcType="VARCHAR" />
	    <result column="CREATED_DATE" property="createdDate" jdbcType="TIMESTAMP" />
	    <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
	    <result column="LAST_UPDATE_DATE" property="lastUpdateDate" jdbcType="TIMESTAMP" />
	    <result column="LAST_UPDATE_USER" property="lastUpdateUser" jdbcType="VARCHAR" />
	    <result column="TEL" property="tel" jdbcType="VARCHAR" />
	    <result column="MAIL" property="mail" jdbcType="VARCHAR" />
	</resultMap>

	<!-- 查询单个地址信息 -->
	<select id="findPersonById" resultMap="BaseResultMap">
		  SELECT 
		         t.`PARTY_ID`,
		         t.`LAST_NAME_LOCAL`,
		         t.RELATION_STATUS_ID,
		         t.`GENDER`,
		         t.`TEL`,
		         t.`PERSONAL_TITLE`,
		         t.`TEL_VERIFIED`,
		         t.`MAIL_VERIFIED`,
		         t.`ACCOUNT_TYPE`,
		         t.`LOGO_IMAGE_URL`,
		         t.`MAIL`,
		         t.`FIXEDTEL` 
		  FROM PERSON t WHERE t.`PARTY_ID`=#{id}
	</select>
	
	<select id="getPersons" parameterType="com.yikuyi.party.model.Party" resultType="com.yikuyi.party.contact.vo.UserVo">
		SELECT 
		  p.`PARTY_ID` AS id,
		  p.`FIRST_NAME_LOCAL` AS NAME,
		  p.`MAIL` AS mail,
		  p.`TEL`AS mobile,
		  p.`PERSONAL_TITLE` AS personalTitle,
		  p.`RELATION_STATUS_ID` AS statusId,
		  DATE_FORMAT(
		    p.`LAST_UPDATE_DATE`,
		    '%Y-%m-%d %H:%i:%s'
		  ) AS relationDate 
		FROM
		  PERSON p 
		WHERE p.`PARTY_ID` IN(
			SELECT 
			  t.`PARTY_ID_FROM` 
			FROM
			  PARTY_RELATIONSHIP t 
			WHERE t.`PARTY_RELATIONSHIP_TYPE_ID`='REPORTS_TO'  
			  AND (
			    t.`THRU_DATE` > NOW() OR t.`THRU_DATE` IS NULL
			  )
			  <if test="id != null">
			  	AND t.`PARTY_ID_TO` = #{id}
			  </if>
		  )
		    <if test="person != null and person.relationSratus != null">
		    	and p.RELATION_STATUS_ID=#{person.relationSratus}
		    </if>
	</select>
	<select id="getUser" parameterType="com.yikuyi.party.model.Party" resultType="com.yikuyi.party.contact.vo.UserVo">
		SELECT 
		  p.`PARTY_ID` AS id,
		  p.`LAST_NAME_LOCAL` AS NAME
		FROM
		  PERSON p 
		<where>
		    <if test="person != null and person.lastNameLocal != null">
		    	and p.LAST_NAME_LOCAL like concat('%',#{person.lastNameLocal},'%')
		    </if>
	    </where>
	</select>
	<select id="getUsers" parameterType="com.yikuyi.party.model.Party" resultType="com.yikuyi.party.contact.vo.UserVo">
		SELECT 
		  p.`PARTY_ID` AS id,
		  p.`LAST_NAME_LOCAL` AS NAME,
		  p.`TEL` AS mobile,
		  p.`MAIL` AS mail
		FROM
		  PERSON p 
		<where>
		    <if test="person != null and person.lastNameLocal != null">
		    	and p.LAST_NAME_LOCAL = #{person.lastNameLocal}
		    </if>
		     <if test="person != null and person.mail != null">
		    	and p.MAIL = #{person.mail}
		    	and p.MAIL_VERIFIED = 'Y'
		    </if>
	    </where>
	</select>
	
	<select id="getUserList" parameterType="com.yikuyi.party.contact.vo.EnterpriseParamVo" resultType="com.yikuyi.party.contact.vo.UserVo">	
	SELECT
  	    t2.MAIL AS mail,
		t2.`TEL` AS mobile,
		t2.LAST_NAME_LOCAL AS NAME,
		t2.CREATED_DATE AS regTime,
		t2.PARTY_ID AS partyId,
		tt.lastLoginTime as lastLoginTime,
		 CASE
		    WHEN t.`STATUS_ID` = 'PARTY_ENABLED' 
		    THEN '正式' 
		    WHEN t.`STATUS_ID` = 'PARTY_DISABLED' 
		    THEN '冻结' 
		    ELSE '' 
		  END AS statusId,
                 CONCAT(
		    addr.`PROVINCE_GEO_NAME`,
		    addr.`CITY_GEO_NAME`,
		    addr.`COUNTY_GEO_NAME`,
		    addr.`ADDRESS1`
		  ) AS address 
	FROM PERSON t2 
	LEFT JOIN `PARTY` t  ON t2.PARTY_ID = t.PARTY_ID 
	LEFT JOIN PARTY_ROLE t6 ON t2.PARTY_ID = t6.PARTY_ID
        LEFT JOIN PARTY_CONTACT_MECH m 
	 	    ON t2.`PARTY_ID` = m.`PARTY_ID` 
		    AND m.`CONTACT_MECH_PURPOSE_TYPE_ID` = 'REGISTER_LOCATION' 
		    AND (
		      m.`THRU_DATE` > NOW() 
		      OR m.THRU_DATE IS NULL
		    ) 
         LEFT JOIN CONTACT_MECH c ON m.CONTACT_MECH_ID= c.CONTACT_MECH_ID
	 LEFT JOIN POSTAL_ADDRESS addr 
		    ON m.`CONTACT_MECH_ID` = addr.`CONTACT_MECH_ID` 
        LEFT JOIN (SELECT t1.`PARTY_ID` ,MAX(t1.`LAST_UPDATE_DATE` ) AS lastLoginTime FROM `USER_LOGIN` t1 WHERE t1.`ENABLED` ='Y' GROUP BY t1.`PARTY_ID` ) AS tt ON t2.party_id = tt.party_id
	WHERE t6.ROLE_TYPE_ID='INDIVIDUAL_CUST' 
		<if test="phone != null and phone !=''">
			AND t2.`TEL` LIKE CONCAT(#{phone}, '%')  
		</if>
		<if test="mail != null and mail !=''">
			AND t2.`MAIL` LIKE CONCAT(#{mail}, '%')  
		</if>
		<if test="name != null and name !=''">
			AND t2.`LAST_NAME_LOCAL` LIKE CONCAT(#{name}, '%')  
		</if>
		<if test="status != null ">
			AND t.STATUS_ID = #{status}
		</if>
		<if test="registerStart != null and registerStart !=''">
			 <![CDATA[ AND t2.CREATED_DATE >= DATE_FORMAT(#{registerStart},'%Y/%m/%d')]]>
		</if>
		<if test="registerEnd != null and registerEnd !=''">
			<![CDATA[ AND t2.CREATED_DATE <= DATE_FORMAT(#{registerEnd},'%Y/%m/%d 23:59:59')]]>
		</if>
		<if test="lastLoginStart != null and lastLoginStart !=''">
			<![CDATA[ AND tt.lastLoginTime >= DATE_FORMAT(#{lastLoginStart},'%Y/%m/%d')]]>
		</if>
		<if test="lastLoginEnd != null and lastLoginEnd !=''">
			<![CDATA[ AND tt.lastLoginTime <= DATE_FORMAT(#{lastLoginEnd},'%Y/%m/%d 23:59:59')]]>
		</if>
		ORDER BY t2.CREATED_DATE DESC
	</select>
	
	<insert id="insert" parameterType="com.yikuyi.party.model.Party">
		insert into PERSON
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				PARTY_ID,
			</if>
		   <if test="person != null and person.gender != null" >
				GENDER,
			</if>
			<if test="person != null and person.lastNameLocal != null" >
				LAST_NAME_LOCAL,
			</if>
			<if test="person != null and person.creator != null" >
				CREATOR,
			</if>
			<if test="person != null" >
				CREATED_DATE,
			</if>
			<if test="person != null and person.lastUpdateUser != null" >
				LAST_UPDATE_USER,
			</if>
			<if test="person != null and person.lastUpdateDate != null" >
				LAST_UPDATE_DATE,
			</if>
			<if test="person != null and person.tel != null" >
				TEL,
			</if>
			<if test="person != null and person.mail != null" >
				MAIL,
			</if>
			<if test="person != null and person.telStatus != null" >
				TEL_VERIFIED,
			</if>
			<if test="person != null and person.mailStatus != null" >
				MAIL_VERIFIED,
			</if>
			<if test="person != null and person.personalTitle != null" >
				PERSONAL_TITLE,
			</if>
		    <if test="person != null and person.personTypeStatus != null" >
				ACCOUNT_TYPE,
		    </if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=VARCHAR},
			</if>
		    <if test="person != null and person.gender != null" >
				#{person.gender,jdbcType=VARCHAR},
			</if>
			 <if test="person != null and person.lastNameLocal != null" >
			   #{person.lastNameLocal,jdbcType=VARCHAR},
			</if>
			  <if test="person != null and person.creator != null" >
				#{person.creator,jdbcType=VARCHAR},
			</if>
		    <if test="person != null" >
				NOW(),
			</if>
			<if test="person != null and person.lastUpdateUser != null" >
				#{person.lastUpdateUser,jdbcType=VARCHAR},
			</if>
			<if test="person != null and person.lastUpdateDate != null" >
				#{person.lastUpdateDate,jdbcType=TIMESTAMP},
			</if>
			<if test="person != null and person.tel != null" >
				#{person.tel},
			</if>
			<if test="person != null and person.mail != null" >
				#{person.mail},
			</if>
			<if test="person != null and person.telStatus != null" >
				#{person.telStatus},
			</if>
			<if test="person != null and person.mailStatus != null" >
				#{person.mailStatus},
			</if>
			<if test="person != null and person.personalTitle != null" >
				#{person.personalTitle},
			</if>
		    <if test="person != null and person.personTypeStatus != null" >
				#{person.personTypeStatus},
		    </if>
		</trim>
	</insert>
    <update id="editPerson" parameterType="com.yikuyi.party.model.Party">
    update PERSON
    <set >
       <if test="person != null and person.gender != null" >
        GENDER = #{person.gender},
      </if>
      <if test="person != null and person.relationSratus != null" >
        RELATION_STATUS_ID = #{person.relationSratus},
      </if>
      <if test="person != null and person.lastName != null" >
        LAST_NAME = #{person.lastName},
      </if>
      <if test="person != null and person.lastNameLocal != null" >
        LAST_NAME_LOCAL = #{person.lastNameLocal},
      </if>
      <if test="person != null and person.logoImageUrl != null" >
        LOGO_IMAGE_URL = #{person.logoImageUrl},
      </if>
      <if test="person != null and person.logoImageUrlSmall != null" >
        LOGO_IMAGE_URL_SMALL = #{person.logoImageUrlSmall},
      </if>
      <if test="person != null and person.lastUpdateUser != null" >
        LAST_UPDATE_USER = #{person.lastUpdateUser},
      </if>
      <if test="person != null and person.lastUpdateDate != null" >
        LAST_UPDATE_DATE = #{person.lastUpdateDate},
      </if>
      <if test="person != null and person.tel != null" >
        TEL = #{person.tel},
      </if>
	  <if test="person != null and person.mail != null" >
		MAIL = #{person.mail},
	  </if>
      <if test="person != null and person.telStatus != null" >
        TEL_VERIFIED = #{person.telStatus},
      </if>
	  <if test="person != null and person.mailStatus != null" >
		MAIL_VERIFIED = #{person.mailStatus},
	  </if>
	  <if test="person != null and person.personalTitle != null" >
		PERSONAL_TITLE = #{person.personalTitle},
	  </if>
	    <if test="person != null and person.personTypeStatus != null" >
		ACCOUNT_TYPE = #{person.personTypeStatus},
	  </if>
	   <if test="person != null and person.fixedTel != null" >
		FIXEDTEL = #{person.fixedTel},
	  </if>
    </set>
    where party_id = #{id}
  </update>
  <!-- 查询认证部邮件 -->
	<select id="findDataByRole" resultMap="BaseResultMap">
	   SELECT a.`PARTY_ID`, a.LAST_NAME_LOCAL,a.`MAIL` FROM PERSON a , PARTY_ROLE b WHERE a.party_id = b.party_id  
	   <if test="roleList != null and roleList.size !=0">
			AND  b.role_type_Id IN
	        <foreach collection="roleList" item="ids" index="index" open="(" close=")" separator=",">
	            #{ids,jdbcType=VARCHAR}
	        </foreach>
        </if>
	</select>
	
	<select id="getPersonByUserId" resultMap="BaseResultMap">
		SELECT 
		  PARTY_ID,
		  SALUTATION,
		  FIRST_NAME,
		  LAST_NAME,
		  PERSONAL_TITLE,
		  FIRST_NAME_LOCAL,
		  LAST_NAME_LOCAL,
		  GENDER,
		  COMMENTS,
		  OCCUPATION,
		  RELATION_STATUS_ID,
		  CREATOR,
		  CREATED_DATE,
		  LAST_UPDATE_USER,
		  LAST_UPDATE_DATE,
		  LOGO_IMAGE_URL,
		  LOGO_IMAGE_URL_SMALL,
		  MAIL,
		  ACCOUNT_TYPE
		FROM
		  PERSON
		WHERE PARTY_ID=#{userId}
	</select>
	
	<select id="getReportsTo" resultMap="BaseResultMap">
		SELECT 
		  t1.PARTY_ID,
		  t1.SALUTATION,
		  t1.FIRST_NAME,
		  t1.LAST_NAME,
		  t1.PERSONAL_TITLE,
		  t1.FIRST_NAME_LOCAL,
		  t1.LAST_NAME_LOCAL,
		  t1.GENDER,
		  t1.COMMENTS,
		  t1.OCCUPATION,
		  t1.RELATION_STATUS_ID,
		  t1.CREATOR,
		  t1.CREATED_DATE,
		  t1.LAST_UPDATE_USER,
		  t1.LAST_UPDATE_DATE,
		  t1.LOGO_IMAGE_URL,
		  t1.LOGO_IMAGE_URL_SMALL 
		FROM
		  PERSON t1
		WHERE t1.`PARTY_ID`IN(
			SELECT a.`PARTY_ID_FROM`FROM PARTY_RELATIONSHIP a WHERE <![CDATA[ a.`PARTY_ID_FROM`<>#{partyId}]]>
			AND `PARTY_RELATIONSHIP_TYPE_ID` IN('USER_DEPT_REL','EXECUTIVE_DEPT_REL') AND (`THRU_DATE` > NOW() OR `THRU_DATE` IS NULL )
			AND FIND_IN_SET(a.`PARTY_ID_TO`,queryChildrenDeptIdInfo(
				(SELECT `PARTY_ID_TO` FROM PARTY_RELATIONSHIP WHERE `PARTY_ID_FROM`= #{partyId} 
					AND `PARTY_RELATIONSHIP_TYPE_ID` IN('USER_DEPT_REL','EXECUTIVE_DEPT_REL') AND (`THRU_DATE` > NOW() OR `THRU_DATE` IS NULL ))))
		)
	</select>
	
	<select id="getEmailListByRoleType" resultMap="BasePersonMap">
		SELECT a.LAST_NAME_LOCAL,a.TEL,a.mail FROM PERSON a LEFT JOIN PARTY_ROLE b ON a.`PARTY_ID`=b.`PARTY_ID` 
		WHERE b.`ROLE_TYPE_ID`=#{roleType} AND a.mail IS NOT NULL
	</select>
	
	<select id="getPartyByIds" resultType="com.yikuyi.party.contact.vo.UserVo">
		SELECT 
		  p.`PARTY_ID` AS partyId,
		  p.`LAST_NAME_LOCAL` AS name,
		  p.`TEL` AS telNumber,
		  p.`MAIL` AS mail,
		  CASE WHEN r.`ROLE_TYPE_ID` IS NULL THEN '0'
		  ELSE '1' END AS isEnterprise,
		  t.`CORPORATION_ID` AS enterpriseId,
		  g.`GROUP_NAME` AS companyName
		FROM
		  PERSON p 
		  LEFT JOIN PARTY_ROLE r 
		    ON p.`PARTY_ID` = r.`PARTY_ID` 
		    AND r.`ROLE_TYPE_ID` = 'ENTERPRISE_CUST'
		  LEFT JOIN PARTY t ON p.`PARTY_ID`= t.`PARTY_ID`
		  LEFT JOIN PARTY_GROUP g ON t.`CORPORATION_ID`= g.`PARTY_ID`
		 <if test="ids != null and ids.size() !=0">
			WHERE p.`PARTY_ID` in 
	        <foreach collection="ids" item="id" index="index"
	            open="(" close=")" separator=",">
	            #{id}
	        </foreach>
        </if>
      
	</select>
	
	
<insert id="insertContactPersonInfo" parameterType="com.yikuyi.party.vendor.vo.ContactPersonInfo" >
    insert into PERSON
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="partyId != null" >
        PARTY_ID,
      </if>
      <if test="lastNameLocal != null" >
        LAST_NAME_LOCAL,
      </if>
      <if test="occupation != null" >
        OCCUPATION,
      </if>
      <if test="personalTitle != null" >
        PERSONAL_TITLE,
      </if>
      <if test="mail != null" >
        MAIL,
      </if>
      <if test="fixedtel != null" >
        FIXEDTEL,
      </if>     
       <if test="tel != null" >
        TEL,
      </if>  
       <if test="address != null" >
        ADDRESS,
      </if> 
      <if test="creator != null" >
        CREATOR,
      </if>
     <if test="createdDate != null" > 
        CREATED_DATE,
      </if>
       <if test="lastUpdateUser != null" >
       LAST_UPDATE_USER, 
      </if>
     <if test="lastUpdateDate != null" > 
      LAST_UPDATE_DATE,
      </if>         
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="partyId != null" >
         #{partyId},
      </if>
      <if test="lastNameLocal != null" >
         #{lastNameLocal},
      </if>
      <if test="occupation != null" >
         #{occupation},
      </if>
      <if test="personalTitle != null" >
        #{personalTitle},
      </if>
      <if test="mail != null" >
        #{mail},
      </if>
      <if test="fixedtel != null" >
        #{fixedtel},
      </if>     
       <if test="tel != null" >
        #{tel},
      </if> 
       <if test="address != null" >
        #{address},
      </if>    
      <if test="creator != null" >
        #{creator},
      </if>
     <if test="createdDate != null" > 
        #{createdDate},
      </if>
       <if test="lastUpdateUser != null" >
        #{lastUpdateUser},
      </if>
     <if test="lastUpdateDate != null" > 
        #{lastUpdateDate},
      </if>  
    </trim>
  </insert>
  
  <delete id="delContactPersonInfo" parameterType="java.lang.String">	
	 delete from PARTY_RELATIONSHIP 
	 where PARTY_RELATIONSHIP_TYPE_ID= #{partyRelationshipTypeId}  
	 and PARTY_ID_TO=#{partyIdTo}		
	</delete>
	
  <select id="findPartyRelationship" resultType="com.yikuyi.party.model.PartyRelationship" parameterType="java.lang.String">
		  SELECT 
		       PARTY_ID_FROM as partyIdFrom		     
		  FROM PARTY_RELATIONSHIP WHERE PARTY_ID_TO = #{partyIdTo} and PARTY_RELATIONSHIP_TYPE_ID = #{partyRelationshipTypeId}  
		  and STATUS_ID = 'ENABLE'
	</select>
  
   <delete id="delByPartyIdFrom" parameterType="java.lang.String">				
	   delete from PARTY_RELATIONSHIP
	   where PARTY_ID_FROM=#{partyIdFrom}
	   and PARTY_RELATIONSHIP_TYPE_ID= #{partyRelationshipTypeId}  
	</delete>
	
	<delete id="delByPartyIdTo" parameterType="java.lang.String">				
	   delete from PARTY_RELATIONSHIP
	   where PARTY_ID_TO=#{partyIdTo}
	   and PARTY_RELATIONSHIP_TYPE_ID= #{partyRelationshipTypeId}  
	</delete>
	
	<delete id="del" parameterType="java.lang.String">				
	   delete from PERSON where PARTY_ID =#{partyId}	   
	</delete>
	
	 <select id="findProductLineByPartyId" resultType="com.yikuyi.party.model.PartyRelationship" parameterType="java.lang.String">
		  SELECT 
		       PARTY_ID_TO as partyIdTo	     
		  FROM PARTY_RELATIONSHIP WHERE PARTY_ID_FROM = #{partyIdFrom} and PARTY_RELATIONSHIP_TYPE_ID = #{partyRelationshipTypeId}  
		  and STATUS_ID = 'ENABLE'
	</select>
  

</mapper>