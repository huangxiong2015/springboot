/*
 * Created: 2016年11月28日
 *
 * Shenzhen Yikuyi Co., Ltd. All rights reserved. 
 * Copyright (c) 2015-2016 
 * License, Version 1.0. Published by Yikuyi IT department.
 *
 * For the convenience of communicating and reusing of codes,
 * any java names, variables as well as comments should be written according to the regulations strictly.
 */
package com.yikuyi.party.partygroup.bll;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.function.Function;
import java.util.stream.Collectors;

import org.apache.ibatis.session.RowBounds;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;
import org.springframework.web.client.RestTemplate;

import com.yikuyi.news.model.News;
import com.yikuyi.party.contact.vo.MsgResultVo;
import com.yikuyi.party.customer.dao.PersonDao;
import com.yikuyi.party.group.model.PartyGroup.ActiveStatus;
import com.yikuyi.party.group.vo.PartyGroupVo;
import com.yikuyi.party.model.Party;
import com.yikuyi.party.model.PartyAttribute;
import com.yikuyi.party.model.PartyAttributes;
import com.yikuyi.party.model.PartyRelationship;
import com.yikuyi.party.party.bll.PartyAttributeManager;
import com.yikuyi.party.party.dao.PartyRoleDao;
import com.yikuyi.party.partygroup.dao.PartyGroupDao;
import com.yikuyi.party.partygroup.dao.PartyRelationshipDao;
import com.yikuyi.party.person.model.Person.RelationSratus;
import com.yikuyi.party.role.model.RoleType;

@Service
@Transactional
public class PartyGroupManager {
	private static final Logger logger = LoggerFactory.getLogger(PartyGroupManager.class);
	@Autowired
	private RestTemplate restTemplate;
	@Autowired
	private PartyGroupDao partyGroupDao;
	@Autowired
	private PartyRoleDao partyRoleDao;
	@Autowired
	private PartyRelationshipDao partyRelationshipDao;
	@Autowired
	private PersonDao personDao;
	
	
	@Autowired
	private PartyAttributeManager partyAttributeManager;

	@Value("${api.product.serverUrlPrefix}")
	private String productServerUrlPrefix;
	/**
	 * 根据条件查找详细的party信息
	 * @author 张伟
	 * @param paramPartyGroup
	 * @return
	 */
	@Cacheable(value="partyGroupGetAllPartyGroupListCache", key="'getAllPartyGroupList.List[roleType:'+ #param.roleType+',status:'+ #param.status+',partyId:'+ #param.partyId+',groupName:'+ #param.groupName+',partyType:'+ #param.partyType+',partyIdFrom:'+ #param.partyIdFrom+',partyIdTo:'+ #param.partyIdTo+',roleTypeIdFrom:'+ #param.roleTypeIdFrom+',roleTypeIdTo:'+ #param.roleTypeIdTo+', offset:' + #rowBounds.offset + ', limit:' + #rowBounds.limit + ']'")
	public List<Party> getAllPartyGroupList(PartyGroupVo param,RowBounds rowBounds){
		//查询所有供应商
		List<Party> list = partyGroupDao.getAllPartyGroupList(param,rowBounds);
		 //获取所有供应商id
		List<String> vendorIdList = list.stream().map(Party::getId).collect(Collectors.toList());
		//调用接口获取分销商数据
		List<News> newsList = this.getNewsByVnedorId(vendorIdList);
		Map<String, News> newsMap = newsList.stream().collect(Collectors.toMap(News::getNewsId,Function.identity()));
	
		 for (Party party : list) {
			 PartyAttributes attr=new PartyAttributes();
			 String ownerPartyId =party.getId();
			//如果存在key 则设置显示
			if (newsMap.containsKey(ownerPartyId)) {
				attr.setIsVendorDetail("Y");
			}else{
				attr.setIsVendorDetail("N");
			}
			 //物流官网
			 List<PartyAttribute> urls=partyAttributeManager.getPartyAttributelist(party.getId(),null);
			 for (PartyAttribute partyAttribute : urls) {
				if("WEBSITE_URL".equals(partyAttribute.getKey())){//物流官网
					 attr.setWebSite(partyAttribute);
				}else if("IS_SHOW_NAME".equals(partyAttribute.getKey())){ //是否显示名称
					 attr.setIsShowName(partyAttribute);
				}
			}
			party.setPartyAttributes(attr);
		 }
		 return list;
	}
	/**
	 * 查询供应商下的分销商
	 * @return
	 * @since 2017年4月17日
	 * @author zr.helinmei@yikuyi.com
	 */
	public List<News> getNewsByVnedorId(List<String> list){
		News news = new News();
		news.setNewsIds(list);
		news.setStatus("PUBLISHED");
		news.setCategoryTypeId("VENDOR");
		HttpEntity<News> entity = new HttpEntity<>(news);
		String url = productServerUrlPrefix + "/v1/news/newsbatch";
		logger.info("供应商调用查询分销商服务：{}",url);
		try {
			ResponseEntity<List<News>> response = restTemplate.exchange(url,HttpMethod.POST, entity, new ParameterizedTypeReference<List<News>>(){});
			return response.getBody();
		} catch (Exception e) {
			logger.error("供应商调用查询分销商服务异常：{}，服务地址：{}",e,url);
		}
		
		return new ArrayList<>();
	}
	/**
	 * 根据组织名称查找记录
	 * @author 张伟
	 * @param groupName
	 * @return
	 */
	public Party findPartyGroupByName(String groupName ){
		return partyGroupDao.findPartyGroupByName(groupName);
	}
	

	/**
	 * 根据partyGroupId获取party
	 * @param partyGroupId
	 * @return
	 */
	public Party getPartyGroupByGroupId(String partyGroupId) {
		return partyGroupDao.getPartyGroupByGroupId(partyGroupId);
	}
	
	/**
	 * @author 张伟
	 * @param partyId
	 * @return
	 */
	public MsgResultVo orderPermissions(String partyId) {
		MsgResultVo result = new MsgResultVo();
		//是否是管理员
		boolean isEnterpriseUser = false; 
		boolean isActiveStatus = false; 
		boolean isRelation = false;
		
		Set<String> partyRoles=partyRoleDao.findRoleByPartyId(partyId);
		if(null != partyRoles){
			for (String roles : partyRoles) {
				if("MAIN_ROLE".equals(roles)){
					isEnterpriseUser=true;
					break;
				}
			}
		}
		
		//是管理员
		if(isEnterpriseUser){
			PartyRelationship param=new PartyRelationship();
			param.setPartyIdFrom(partyId);
			param.setRoleTypeIdTo(RoleType.CORPORATION);
			List<PartyRelationship> partyRelationships =partyRelationshipDao.getPartyRelationship(param);
			String enterpriseUserId = ""; 
			for (PartyRelationship partyRelationship : partyRelationships) {
				RoleType roleTypeIdFrom =partyRelationship.getRoleTypeIdFrom();
				//找到当前当前人的企业账号
				if(null != roleTypeIdFrom && RoleType.MAIN_ROLE.equals(roleTypeIdFrom)){
					enterpriseUserId = partyRelationship.getPartyIdTo();
				}
			}
			//检查激活状态
			if(!StringUtils.isEmpty(enterpriseUserId)){
				Party enterpriseUser = partyGroupDao.findPartyGroupByPartyId(enterpriseUserId);
				if(null != enterpriseUser && null != enterpriseUser.getPartyGroup() && ActiveStatus.PARTY_VERIFIED.equals(enterpriseUser.getPartyGroup().getActiveStatus())){
					isActiveStatus=true;
				}
			}
			//检查关联状态
			Party person = personDao.findPersonById(partyId);
			if(null != person && null != person.getPerson() ){
				RelationSratus relationSratus = person.getPerson().getRelationSratus();
				//是否关联
				if(RelationSratus.RELATED.equals(relationSratus)){
					isRelation=true;
				}
			}
			
			//激活或者关联
			if(isActiveStatus || isRelation){
				result.setCode("10000");
				result.setValue("激活或者关联");
			}else{
				result.setCode("10002");
				result.setValue("未激活并且未关联");
			}
			return result;
		}else{
			result.setCode("10001");
			result.setValue("非企业用户");
			return result;
		}
	}
}