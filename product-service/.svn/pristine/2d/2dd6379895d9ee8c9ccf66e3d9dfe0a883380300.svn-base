<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yikuyi.product.promotion.dao.PromotionDao">

	<resultMap id="BaseResultMap" type="com.yikuyi.promotion.model.Promotion" >
	    <id column="PROMOTION_ID" property="promotionId" jdbcType="VARCHAR" />
	    <result column="PROMOTION_NAME" property="promotionName" jdbcType="VARCHAR" />
	    <result column="PROMOTION_STATUS" property="promotionStatus" jdbcType="VARCHAR" />
	    <result column="CREATE_TYPE" property="createType" jdbcType="VARCHAR" />
	    <result column="DISPLAY_SIDEBAR" property="displaySidebar" jdbcType="VARCHAR" />
	    <result column="PREVIEW_DISPLAY_SIDEBAR" property="previewDisplaySidebar" jdbcType="VARCHAR" />
	    <result column="PROMOTION_URL" property="promotionUrl" jdbcType="VARCHAR" />
	    <result column="FACE_IMG_URL" property="faceImgUrl" jdbcType="VARCHAR" />
	    <result column="COUPON_IDS" property="couponIds" jdbcType="VARCHAR" />
	     <result column="IS_USE_COUPON" property="isUseCoupon" jdbcType="VARCHAR" />
	    <result column="START_DATE" property="startDate" jdbcType="TIMESTAMP" />
	    <result column="END_DATE" property="endDate" jdbcType="TIMESTAMP"/>
	    <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
	    <result column="CREATOR_NAME" property="creatorName" jdbcType="VARCHAR" />
	    <result column="CREATED_DATE" property="createdDate" jdbcType="TIMESTAMP" />
	    <result column="LAST_UPDATE_USER" property="lastUpdateUser" jdbcType="VARCHAR" />
	    <result column="LAST_UPDATE_USER_NAME" property="lastUpdateUserName" jdbcType="VARCHAR" />
	    <result column="LAST_UPDATE_DATE" property="lastUpdateDate" jdbcType="TIMESTAMP" />
	</resultMap>
		
  	<sql id="Base_Column_List" >
	    PROMOTION_ID,PROMOTION_NAME,PROMOTION_STATUS,CREATE_TYPE,DISPLAY_SIDEBAR,PREVIEW_DISPLAY_SIDEBAR,
	    PROMOTION_URL,FACE_IMG_URL,COUPON_IDS,IS_USE_COUPON,
	    START_DATE,END_DATE,CREATOR,CREATOR_NAME,CREATED_DATE,LAST_UPDATE_USER,LAST_UPDATE_USER_NAME,LAST_UPDATE_DATE
	</sql>
  	
  	<select id="getPromotion" parameterType="java.lang.String" resultMap="BaseResultMap">
  		SELECT <include refid="Base_Column_List"/> FROM PROMOTION WHERE PROMOTION_ID = #{promotionId}
  	</select>


	<select id="getPromotionVoList" resultType="com.yikuyi.promotion.vo.PromotionVo"
		parameterType="com.yikuyi.promotion.vo.PromotionParamVo">
		SELECT p.`PROMOTION_ID` AS promotionId,
		p.`PROMOTION_NAME` AS promotionName,
		p.`PROMOTION_STATUS` AS promotionStatus,
		p.`CREATE_TYPE` AS createType,
		p.`DISPLAY_SIDEBAR` AS displaySidebar,
		p.`PREVIEW_DISPLAY_SIDEBAR` AS previewDisplaySidebar,
		p.`PROMOTION_URL` AS promotionUrl,
		p.`FACE_IMG_URL` AS faceImgUrl,
		p.`COUPON_IDS` AS couponIds,
		p.`IS_USE_COUPON` AS isUseCoupon,
		p.`START_DATE` AS startDate,
		p.`END_DATE` AS endDate,
		p.`CREATOR` AS creator,
		p.`CREATOR_NAME` AS creatorName,
		p.`CREATED_DATE` AS createdDate,
		p.`LAST_UPDATE_USER` AS lastUpdateUser,
		p.`LAST_UPDATE_USER_NAME` AS lastUpdateUserName,
		p.`LAST_UPDATE_DATE` AS lastUpdateDate
		FROM PROMOTION p WHERE 1=1
		<if test="promotionName != null and promotionName !='' ">
			And p.`PROMOTION_NAME` LIKE CONCAT(#{promotionName}, '%')
		</if>
		<if test="promotionStatusList != null and promotionStatusList.size() !=0">
			And p.`PROMOTION_STATUS` IN
			<foreach collection="promotionStatusList" item="promotionStatus" index="index" open="(" close=")" separator=",">
	            #{promotionStatus}
	        </foreach>
		</if>
		<if test="timeStatus !=null">
			<if test='timeStatus == "NOTSTARTED"'>
				AND DATE_FORMAT(NOW(), '%Y-%m-%d') <![CDATA[ < ]]> DATE_FORMAT(p.`START_DATE`, '%Y-%m-%d')
			</if>
			<if test='timeStatus == "ONGOING"'>
				AND DATE_FORMAT(NOW(), '%Y-%m-%d') <![CDATA[ >= ]]> DATE_FORMAT(p.`START_DATE`, '%Y-%m-%d')
				AND DATE_FORMAT(NOW(), '%Y-%m-%d') <![CDATA[ <= ]]> DATE_FORMAT(p.`END_DATE`, '%Y-%m-%d')
			</if>
			<if test='timeStatus == "COMPLETE"'>
				AND DATE_FORMAT(NOW(), '%Y-%m-%d') <![CDATA[ > ]]> DATE_FORMAT(p.`END_DATE`, '%Y-%m-%d')
			</if>
			 AND p.`PROMOTION_STATUS` = 'ENABLE'
		</if>
		<if test="createDateStart != null and createDateStart !=''">
			And p.`CREATED_DATE` >= DATE_FORMAT(concat(#{createDateStart},'
			00:00:00'),'%Y-%m-%d %H:%i:%s')
		</if>
		<if test="createDateEnd != null and createDateEnd !=''">
		   <![CDATA[ And p.`CREATED_DATE` <= DATE_FORMAT(concat(#{createDateEnd},' 23:59:59'),'%Y-%m-%d %H:%i:%s')]]>
		</if>
		<choose>
			<when test="timeStatus !=null">
				ORDER BY p.`START_DATE` DESC
			</when>
			<otherwise>
				ORDER BY p.`LAST_UPDATE_DATE` DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="getPromotionList" resultType="com.yikuyi.promotion.model.Promotion"
		parameterType="com.yikuyi.promotion.vo.PromotionVo">
		SELECT p.`PROMOTION_ID` AS promotionId,
		p.`PROMOTION_NAME` AS promotionName,
		p.`PROMOTION_STATUS` AS promotionStatus,
		p.`CREATE_TYPE` AS createType,
		p.`DISPLAY_SIDEBAR` AS displaySidebar,
		p.`PREVIEW_DISPLAY_SIDEBAR` AS previewDisplaySidebar,
		p.`PROMOTION_URL` AS promotionUrl,
		p.`FACE_IMG_URL` AS faceImgUrl,
		p.`COUPON_IDS` AS couponIds,
		p.`IS_USE_COUPON` AS isUseCoupon,
		p.`START_DATE` AS startDate,
		p.`END_DATE` AS endDate,
		p.`CREATOR` AS creator,
		p.`CREATOR_NAME` AS creatorName,
		p.`CREATED_DATE` AS createdDate,
		p.`LAST_UPDATE_USER` AS lastUpdateUser,
		p.`LAST_UPDATE_USER_NAME` AS lastUpdateUserName,
		p.`LAST_UPDATE_DATE` AS lastUpdateDate
		FROM PROMOTION p WHERE 1=1
		<if test="promotionName != null and promotionName !='' ">
			And p.`PROMOTION_NAME` LIKE CONCAT(#{promotionName}, '%')
		</if>
		<if test="promotionStatus != null">
			And p.`PROMOTION_STATUS` = #{promotionStatus}
		</if>
		ORDER BY p.`LAST_UPDATE_DATE` DESC
	</select>
	

	<!-- 创建活动 -->
	<insert id="insert" parameterType="com.yikuyi.promotion.model.Promotion">
		insert into PROMOTION
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="promotionId != null">
				PROMOTION_ID,
			</if>
			<if test="promotionName != null">
				PROMOTION_NAME,
			</if>
			<if test="promotionStatus != null">
				PROMOTION_STATUS,
			</if>
			<if test="createType != null">
				CREATE_TYPE,
			</if>
			<if test="promotionUrl != null">
				PROMOTION_URL,
			</if>
			<if test="faceImgUrl != null">
				FACE_IMG_URL,
			</if>
			<if test="couponIds != null">
				COUPON_IDS,
			</if>
			<if test="isUseCoupon != null">
				IS_USE_COUPON,
			</if>
			<if test="displaySidebar != null">
				DISPLAY_SIDEBAR,
			</if>
			<if test="previewDisplaySidebar != null">
				PREVIEW_DISPLAY_SIDEBAR,
			</if>
			<if test="startDate != null">
				START_DATE,
			</if>
			<if test="endDate != null">
				END_DATE,
			</if>
			<if test="creator != null">
				CREATOR,
			</if>
			<if test="creatorName != null">
				CREATOR_NAME,
			</if>
			<if test="createdDate != null">
				CREATED_DATE,
			</if>
			<if test="lastUpdateUser != null">
				LAST_UPDATE_USER,
			</if>
			<if test="lastUpdateDate != null">
				LAST_UPDATE_DATE,
			</if>
			<if test="lastUpdateUserName != null">
				LAST_UPDATE_USER_NAME,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="promotionId != null">
				#{promotionId,jdbcType=VARCHAR},
			</if>
			<if test="promotionName != null">
				#{promotionName,jdbcType=VARCHAR},
			</if>
			<if test="promotionStatus != null">
				#{promotionStatus,jdbcType=VARCHAR},
			</if>
			<if test="createType != null">
				#{createType,jdbcType=VARCHAR},
			</if>
			<if test="promotionUrl != null">
				#{promotionUrl,jdbcType=VARCHAR},
			</if>
			<if test="faceImgUrl != null">
				#{faceImgUrl,jdbcType=VARCHAR},
			</if>
			<if test="couponIds != null">
				#{couponIds,jdbcType=VARCHAR},
			</if>
			<if test="isUseCoupon != null">
				#{isUseCoupon,jdbcType=VARCHAR},
			</if>
			<if test="displaySidebar != null">
			  #{displaySidebar,jdbcType=VARCHAR},
			</if>
			<if test="previewDisplaySidebar != null">
			  #{previewDisplaySidebar,jdbcType=VARCHAR},
			</if>
			<if test="startDate != null">
				#{startDate,jdbcType=TIMESTAMP},
			</if>
			<if test="endDate != null">
				#{endDate,jdbcType=TIMESTAMP},
			</if>
			<if test="creator != null">
				#{creator,jdbcType=VARCHAR},
			</if>
			<if test="creatorName != null">
				#{creatorName,jdbcType=VARCHAR},
			</if>
			<if test="createdDate != null">
				#{createdDate,jdbcType=TIMESTAMP},
			</if>
			<if test="lastUpdateUser != null">
				#{lastUpdateUser,jdbcType=VARCHAR},
			</if>
			<if test="lastUpdateDate != null">
				#{lastUpdateDate,jdbcType=TIMESTAMP},
			</if>
			<if test="lastUpdateUserName != null">
				#{lastUpdateUserName,jdbcType=VARCHAR},
			</if>
		</trim>
	</insert>
	
		<!-- 根据活动id修改活动 -->
	<update id="update" parameterType="com.yikuyi.promotion.model.Promotion">
    	update PROMOTION
  		<set>
  			<if test="promotionId != null">
  				PROMOTION_ID = #{promotionId},
  			</if>
  			<if test="promotionName != null">
  				PROMOTION_NAME = #{promotionName},
  			</if>
  			<if test="promotionStatus != null" >
	        	PROMOTION_STATUS = #{promotionStatus},
	      	</if>
	      	<if test="createType != null">
	        	CREATE_TYPE = #{createType},
			</if>
			<if test="promotionUrl != null">
				PROMOTION_URL = #{promotionUrl},
			</if>
			<if test="faceImgUrl != null">
				FACE_IMG_URL = #{faceImgUrl},
			</if>
			<if test="couponIds != null">
				COUPON_IDS = #{couponIds},
			</if>
			<if test="isUseCoupon != null">
				IS_USE_COUPON = #{isUseCoupon},
			</if>
			<if test="displaySidebar != null">
			  	DISPLAY_SIDEBAR = #{displaySidebar},
			</if>
			<if test="previewDisplaySidebar != null">
			  	PREVIEW_DISPLAY_SIDEBAR = #{previewDisplaySidebar},
			</if>
			<if test="startDate != null">
				START_DATE = #{startDate},
			</if>
			<if test="endDate != null">
				END_DATE = #{endDate},
			</if>
	      	<if test="creatorName != null" >
	       	 	CREATOR_NAME = #{creatorName},
	      	</if>
	      	<if test="lastUpdateUserName != null" >
	       	 	LAST_UPDATE_USER_NAME = #{lastUpdateUserName},
	      	</if>
	      	<if test="createdDate != null" >
	       		 CREATED_DATE = #{createdDate},
	      	</if>
	      	<if test="creator != null" >
	       		 CREATOR = #{creator},
	      	</if>
	      	<if test="lastUpdateDate != null" >
	       		 LAST_UPDATE_DATE = #{lastUpdateDate},
	      	</if>
	      	<if test="lastUpdateUser != null" >
	       		 LAST_UPDATE_USER = #{lastUpdateUser},
	      	</if>
  		</set>
  	WHERE PROMOTION_ID = #{promotionId}
  </update>
  
  <select id="getPromotionNotStartList" resultType="com.yikuyi.promotion.model.Promotion">
		SELECT p.`PROMOTION_ID` AS promotionId,
		p.`PROMOTION_NAME` AS promotionName,
		p.`PROMOTION_STATUS` AS promotionStatus,
		p.`CREATE_TYPE` AS createType,
		p.`DISPLAY_SIDEBAR` AS displaySidebar,
		p.`PREVIEW_DISPLAY_SIDEBAR` AS previewDisplaySidebar,
		p.`PROMOTION_URL` AS promotionUrl,
		p.`FACE_IMG_URL` AS faceImgUrl,
		p.`COUPON_IDS` AS couponIds,
		p.`IS_USE_COUPON` AS isUseCoupon,
		p.`START_DATE` AS startDate,
		p.`END_DATE` AS endDate,
		p.`CREATOR` AS creator,
		p.`CREATOR_NAME` AS creatorName,
		p.`CREATED_DATE` AS createdDate,
		p.`LAST_UPDATE_USER` AS lastUpdateUser,
		p.`LAST_UPDATE_USER_NAME` AS lastUpdateUserName,
		p.`LAST_UPDATE_DATE` AS lastUpdateDate
		FROM PROMOTION p WHERE
		p.`PROMOTION_STATUS` = 'ENABLE'	
		AND p.`START_DATE` = CURDATE()
		ORDER BY p.`LAST_UPDATE_DATE` DESC
	</select>
 
 	<select id="getPromotionNotEndList" resultType="com.yikuyi.promotion.model.Promotion" parameterType="java.lang.String" >
		SELECT p.`PROMOTION_ID` AS promotionId,
		p.`PROMOTION_NAME` AS promotionName,
		p.`PROMOTION_STATUS` AS promotionStatus,
		p.`CREATE_TYPE` AS createType,
		p.`DISPLAY_SIDEBAR` AS displaySidebar,
		p.`PREVIEW_DISPLAY_SIDEBAR` AS previewDisplaySidebar,
		p.`PROMOTION_URL` AS promotionUrl,
		p.`FACE_IMG_URL` AS faceImgUrl,
		p.`COUPON_IDS` AS couponIds,
		p.`IS_USE_COUPON` AS isUseCoupon,
		p.`START_DATE` AS startDate,
		p.`END_DATE` AS endDate,
		p.`CREATOR` AS creator,
		p.`CREATOR_NAME` AS creatorName,
		p.`CREATED_DATE` AS createdDate,
		p.`LAST_UPDATE_USER` AS lastUpdateUser,
		p.`LAST_UPDATE_USER_NAME` AS lastUpdateUserName,
		p.`LAST_UPDATE_DATE` AS lastUpdateDate
		FROM PROMOTION p WHERE
		p.`PROMOTION_STATUS` = 'ENABLE'
	    <choose>
			<when test="endDate !=null">
				AND p.`END_DATE` = STR_TO_DATE(#{endDate},'%Y-%m-%d %H:%i:%S')
			</when>
			<otherwise>
				AND p.`END_DATE` = CURDATE()-1
			</otherwise>
		</choose>
		ORDER BY p.`LAST_UPDATE_DATE` DESC
	</select>
  
  	

</mapper>