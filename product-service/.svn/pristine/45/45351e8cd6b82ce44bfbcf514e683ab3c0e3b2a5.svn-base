<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yikuyi.product.activity.dao.ActivityDao" >
  <resultMap id="BaseResultMap" type="com.yikuyi.activity.vo.ActivityVo" >
    <id column="ACTIVITY_ID" property="activityId" jdbcType="VARCHAR" />
    <result column="NAME" property="name" jdbcType="VARCHAR" />
    <result column="TYPE" property="type" jdbcType="VARCHAR" />
    <result column="STATUS" property="status" jdbcType="VARCHAR" />
    <result column="START_DATE" property="startDate" jdbcType="TIMESTAMP" />
    <result column="END_DATE" property="endDate" jdbcType="TIMESTAMP" />
    <result column="PRODUCT_LIST_CSS" property="productListCss" jdbcType="VARCHAR" />
    <result column="PRODUCT_DETAIL_CSS" property="productDetailCss" jdbcType="VARCHAR" />
    <result column="BRAND_CSS" property="brandCss" jdbcType="VARCHAR" />
    <result column="VENDOR_CSS" property="vendorCss" jdbcType="VARCHAR" />
    <result column="PROMO_DISCOUNT_STATUS" property="promoDiscountStatus" jdbcType="CHAR"/>
	<result column="PROMO_DISCOUNT" property="promoDiscount" jdbcType="DOUBLE"/>
    <result column="CREATOR" property="creator" />		
    <result column="CREATOR_NAME" property="creatorName" />
	<result column="CREATED_DATE" property="createdDate" />
	<result column="LAST_UPDATE_USER" property="lastUpdateUser" />
	<result column="LAST_UPDATE_USER_NAME" property="lastUpdateUserName" />
	<result column="LAST_UPDATE_DATE" property="lastUpdateDate" />
	<result column="prStatus" property="prStatus" />
	<result column="activityTime" property="activityTime" />
	<result column="startDates" property="startDates" />
	<result column="endDates" property="endDates" />
	<result column="IS_SYSTEM_QTY" property="isSystemQty" />
	<result column="ICON_STATUS" property="iconStatus" jdbcType="CHAR" />
	<result column="ICON_SCENES" property="iconScenes" jdbcType="VARCHAR" />
	<result column="SPECIFY_SUPPLIER" property="specifySupplier" jdbcType="BOOLEAN" />
	<result column="SUPPLIER_RULE" property="supplierRule" jdbcType="VARCHAR" />
	<collection property="periodsList" ofType="com.yikuyi.activity.model.ActivityPeriods">
	      <id column="PERIODS_ID" property="periodsId" />
	      <result column="START_TIME" property="startTime" />
	      <result column="END_TIME" property="endTime" />  
	      <collection property="productList" ofType="com.yikuyi.activity.model.ActivityProduct">
		      <id column="ACTIVITY_PRODUCT_ID" property="activityProductId" />
		      <result column="PRODUCT_ID" property="productId" />
		      <result column="MANUFACTURER_PART_NUMBER" property="manufacturerPartNumber" /> 
		      <result column="MANUFACTURER" property="manufacturer" />
		      <result column="SOURCE_ID" property="sourceId" />
		      <result column="SOURCE_NAME" property="sourceName" />
		      <result column="VENDOR_ID" property="vendorId" />
		      <result column="VENDOR_NAME" property="vendorName" />
		      <result column="DISCOUNT" property="discount" />
		      <result column="CURRENCY_UOM_ID" property="currencyUomId" />
		      <result column="QTY_BREAK_1" property="qtyBreak1" />
		      <result column="PRICE_BREAK_1" property="priceBreak1" />  
		      <result column="QTY_BREAK_2" property="qtyBreak2" />
		      <result column="PRICE_BREAK_2" property="priceBreak2" />  
		      <result column="QTY_BREAK_3" property="qtyBreak3" />
		      <result column="PRICE_BREAK_3" property="priceBreak3" />  
		      <result column="QTY_BREAK_4" property="qtyBreak4" />
		      <result column="PRICE_BREAK_4" property="priceBreak4" /> 
		      <result column="QTY_BREAK_5" property="qtyBreak5" />
		      <result column="PRICE_BREAK_5" property="priceBreak5" /> 
		      <result column="TITLE" property="title" /> 
		      <result column="SUB_TITLE" property="subTitle" /> 
		      <result column="IMAGE_1" property="image1" /> 
		      <result column="IMAGE_2" property="image2" /> 
		      <result column="IMAGE_3" property="image3" /> 
		      <result column="IMAGE_4" property="image4" /> 
		      <result column="IMAGE_5" property="image5" /> 
		      <result column="TOTAL_QTY" property="totalQty" /> 
		      <result column="QTY" property="qty" />
		      <result column="DESCRIPTION" property="description" />
		      <result column="CATEGORY_3_NAME" property="category3Name" />
		      <result column="CATEGORY_3_ID" property="category3Id" />
          </collection>  
    </collection>
  </resultMap>
  
  <sql id="Base_Column_List" >
    ACTIVITY_ID, NAME, TYPE, STATUS, START_DATE, END_DATE, PRODUCT_LIST_CSS, PRODUCT_DETAIL_CSS, 
    BRAND_CSS, VENDOR_CSS, CREATOR, CREATOR_NAME, CREATED_DATE, LAST_UPDATE_USER, LAST_UPDATE_USER_NAME, LAST_UPDATE_DATE,
    PROMO_DISCOUNT_STATUS,PROMO_DISCOUNT
  </sql>
  <select id="getById" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from ACTIVITY
    where ACTIVITY_ID = #{activityId}
  </select>
  <delete id="deleteById">
  	DELETE FROM ACTIVITY WHERE ACTIVITY_ID = #{id}
  </delete>
  <insert id="save" parameterType="com.yikuyi.activity.model.Activity" >
    insert into ACTIVITY
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="activityId != null" >
        ACTIVITY_ID,
      </if>
      <if test="name != null" >
        NAME,
      </if>
      <if test="type != null" >
        TYPE,
      </if>
      <if test="status != null" >
        STATUS,
      </if>
      <if test="startDate != null" >
        START_DATE,
      </if>
      <if test="endDate != null" >
        END_DATE,
      </if>
      <if test="startDates != null" >
        START_DATE,
      </if>
      <if test="endDates != null" >
        END_DATE,
      </if>
      <if test="productListCss != null" >
        PRODUCT_LIST_CSS,
      </if>
      <if test="productDetailCss != null" >
        PRODUCT_DETAIL_CSS,
      </if>
      <if test="brandCss != null" >
        BRAND_CSS,
      </if>
      <if test="vendorCss != null" >
        VENDOR_CSS,
      </if>
      <if test="vendorCss != null" >
        VENDOR_CSS,
      </if>
      <if test="creator != null" >
        CREATOR,
      </if>
      <if test="creatorName != null" >
        CREATOR_NAME,
      </if>
      <if test="createdDate != null" >
        CREATED_DATE,
      </if>
      <if test="lastUpdateUser != null" >
        LAST_UPDATE_USER,
      </if>
      <if test="lastUpdateUserName != null" >
        LAST_UPDATE_USER_NAME,
      </if>
      <if test="lastUpdateDate != null" >
        LAST_UPDATE_DATE,
      </if>
      <if test="promoDiscountStatus != null" >
        PROMO_DISCOUNT_STATUS,
      </if>
      <if test="promoDiscount != null" >
        PROMO_DISCOUNT,
      </if>
      <if test="isSystemQty != null" >
        IS_SYSTEM_QTY,
      </if>
       <if test="iconStatus != null" >
        ICON_STATUS,
      </if>
       <if test="iconScenes != null" >
        ICON_SCENES,
      </if>
      <if test="specifySupplier != null" >
        SPECIFY_SUPPLIER,
      </if>
      <if test="supplierRule != null" >
        SUPPLIER_RULE,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="activityId != null" >
        #{activityId,jdbcType=VARCHAR},
      </if>
      <if test="name != null" >
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="type != null" >
        #{type,jdbcType=VARCHAR},
      </if>
      <if test="status != null" >
        #{status,jdbcType=VARCHAR},
      </if>
      <if test="startDate != null" >
        #{startDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null" >
        #{endDate,jdbcType=TIMESTAMP},
      </if>
       <if test="startDates != null" >
        #{startDates,jdbcType=TIMESTAMP},
      </if>
      <if test="endDates != null" >
        #{endDates,jdbcType=TIMESTAMP},
      </if>
      <if test="productListCss != null" >
        #{productListCss,jdbcType=VARCHAR},
      </if>
      <if test="productDetailCss != null" >
        #{productDetailCss,jdbcType=VARCHAR},
      </if>
      <if test="brandCss != null" >
        #{brandCss,jdbcType=VARCHAR},
      </if>
      <if test="vendorCss != null" >
        #{vendorCss,jdbcType=VARCHAR},
      </if>
      <if test="creator != null" >
        #{creator,jdbcType=VARCHAR},
      </if>
      <if test="creatorName != null" >
        #{creatorName,jdbcType=VARCHAR},
      </if>
      <if test="createdDate != null" >
        #{createdDate,jdbcType=TIMESTAMP},
      </if>
      <if test="lastUpdateUser != null" >
        #{lastUpdateUser,jdbcType=VARCHAR},
      </if>
      <if test="lastUpdateUserName != null" >
        #{lastUpdateUserName,jdbcType=VARCHAR},
      </if>
      <if test="lastUpdateDate != null" >
        #{lastUpdateDate,jdbcType=TIMESTAMP},
      </if>
      <if test="promoDiscountStatus != null" >
        #{promoDiscountStatus,jdbcType=CHAR},
      </if>
      <if test="promoDiscount != null" >
        #{promoDiscount,jdbcType=DOUBLE},
      </if>
      <if test="isSystemQty != null" >
        #{isSystemQty,jdbcType=CHAR},
      </if>
      <if test="iconStatus != null" >
        #{iconStatus},
      </if>
      <if test="iconScenes != null" >
        #{iconScenes},
      </if>
      <if test="specifySupplier != null" >
        #{specifySupplier},
      </if>
      <if test="supplierRule != null" >
        #{supplierRule},
      </if>
    </trim>
  </insert>
  
  <update id="update" parameterType="com.yikuyi.activity.model.Activity">
  	update `ACTIVITY` 
  		<set>
  			<if test="name != null">
  				NAME = #{name},
  			</if>
  			<if test="type != null">
  				TYPE = #{type},
  			</if>
  			<if test="status != null">
  				STATUS = #{status},
  			</if>
  			<if test="startDate != null" >
	        	START_DATE = #{startDate},
	      	</if>
	      	<if test="endDate != null" >
	       	 	END_DATE = #{endDate},
	      	</if>
	      	<if test="startDates != null" >
	        	START_DATE = #{startDates},
	      	</if>
	      	<if test="endDates != null" >
	       	 	END_DATE = #{endDates},
	      	</if>
	      	<if test="productListCss != null" >
	       	 	PRODUCT_LIST_CSS = #{productListCss},
	      	</if>
	      	<if test="productDetailCss != null" >
	        	PRODUCT_DETAIL_CSS = #{productDetailCss},
	      	</if>
	      	<if test="brandCss != null" >
	        	BRAND_CSS = #{brandCss},
	      	</if>
	      	<if test="vendorCss != null" >
	        	VENDOR_CSS = #{vendorCss},
	     	</if>
	      	<if test="lastUpdateUser != null" >
	       		 LAST_UPDATE_USER = #{lastUpdateUser},
	      	</if>
	      	<if test="lastUpdateUserName != null" >
	        	LAST_UPDATE_USER_NAME = #{lastUpdateUserName},
	      	</if>
	      	<if test="lastUpdateDate != null" >
	       		 LAST_UPDATE_DATE = #{lastUpdateDate},
	      	</if>
	      	<if test="promoDiscountStatus != null" >
	       		 PROMO_DISCOUNT_STATUS = #{promoDiscountStatus},
	      	</if>
	      	<if test="promoDiscount != null" >
	       		 PROMO_DISCOUNT = #{promoDiscount},
	      	</if>
	      	<if test="isSystemQty != null" >
	       		 IS_SYSTEM_QTY = #{isSystemQty},
	      	</if>
	      	<if test="iconStatus != null">
				ICON_STATUS = #{iconStatus},
			</if>
			<if test="iconScenes != null">
				ICON_SCENES = #{iconScenes},
			</if>
			<if test="specifySupplier != null">
				SPECIFY_SUPPLIER = #{specifySupplier},
			</if>
			<if test="supplierRule != null">
				SUPPLIER_RULE = #{supplierRule},
			</if>
  		</set>
  	WHERE ACTIVITY_ID = #{activityId}
  </update>

  <select id="getActivityInfo" parameterType="java.lang.String" resultMap="BaseResultMap">
  	select t.ACTIVITY_ID,t.NAME,t.TYPE,t.START_DATE,t.END_DATE,t.PROMO_DISCOUNT_STATUS,t.PROMO_DISCOUNT,t.IS_SYSTEM_QTY,ICON_STATUS,ICON_SCENES,t.LAST_UPDATE_DATE,t.CREATED_DATE,t.SPECIFY_SUPPLIER,t.SUPPLIER_RULE,
  	   a.PERIODS_ID,a.START_TIME,a.END_TIME,b.ACTIVITY_PRODUCT_ID,
       b.PRODUCT_ID,b.MANUFACTURER_PART_NUMBER,b.MANUFACTURER,b.SOURCE_ID,b.SOURCE_NAME,b.VENDOR_ID,
       b.VENDOR_NAME,b.DISCOUNT,b.CURRENCY_UOM_ID,b.QTY_BREAK_1,b.PRICE_BREAK_1,b.QTY_BREAK_2,
       b.PRICE_BREAK_2,b.QTY_BREAK_3,b.PRICE_BREAK_3,b.QTY_BREAK_4,b.PRICE_BREAK_4,b.QTY_BREAK_5,
       b.PRICE_BREAK_5,b.TITLE,b.SUB_TITLE,b.IMAGE_1,b.IMAGE_2,b.IMAGE_3,b.IMAGE_4,b.IMAGE_5,
       b.TOTAL_QTY,b.QTY,b.DESCRIPTION,b.CATEGORY_3_NAME,b.CATEGORY_3_ID
	 from ACTIVITY t left join ACTIVITY_PERIODS a on t.ACTIVITY_ID = a.ACTIVITY_ID left join ACTIVITY_PRODUCT b on 
	a.PERIODS_ID = b.PERIODS_ID and a.ACTIVITY_ID = b.ACTIVITY_ID where a.STATUS = 'ENABLE' and t.ACTIVITY_ID = #{activityId}
  </select>
  
    <!-- 查询活动管理列表 -->
  <select id="findActivityByEntity" parameterType="com.yikuyi.activity.vo.ActivityVo" resultMap="BaseResultMap">
  <!-- 	select * from (	
		select t.ACTIVITY_ID,t.NAME,t.TYPE,t.CREATED_DATE,t.LAST_UPDATE_USER,t.LAST_UPDATE_DATE,t.LAST_UPDATE_USER_NAME,
		DATE_FORMAT(t.START_DATE,'%Y-%m-%d %H:%i') as startDates,
		DATE_FORMAT(t.END_DATE,'%Y-%m-%d %H:%i') as endDates,t.STATUS,
		CASE 
  			WHEN DATE_FORMAT(now(),'%Y-%m-%d %T') <![CDATA[<]]> STR_TO_DATE(t.START_DATE,'%Y-%m-%d %T') and STATUS ='ENABLE' THEN 'NS'
  			WHEN STR_TO_DATE(t.START_DATE,'%Y-%m-%d %T')<![CDATA[<=]]> DATE_FORMAT(now(),'%Y-%m-%d %T') and DATE_FORMAT(now(),'%Y-%m-%d %T') <![CDATA[<=]]> STR_TO_DATE(t.END_DATE,'%Y-%m-%d %T') and STATUS ='ENABLE' THEN 'GOING'
  			WHEN DATE_FORMAT(now(),'%Y-%m-%d %T') <![CDATA[>]]> STR_TO_DATE(t.END_DATE,'%Y-%m-%d %T') and STATUS ='ENABLE' THEN 'OVER'  
		ELSE 'STOP' END as prStatus
		from 
		(select a.ACTIVITY_ID,a.NAME,a.TYPE,a.CREATED_DATE,a.LAST_UPDATE_USER,a.LAST_UPDATE_DATE,
			DATE_FORMAT(CONCAT(DATE_FORMAT(START_DATE,'%Y-%m-%d'),' ',(SELECT MIN(p.START_TIME) from ACTIVITY_PERIODS p where p.ACTIVITY_ID = a.ACTIVITY_ID)) ,'%Y-%m-%d %T') as START_DATE,
			DATE_FORMAT(CONCAT(DATE_FORMAT(END_DATE,'%Y-%m-%d'),' ',(SELECT MAX(p1.END_TIME) from ACTIVITY_PERIODS p1 where p1.ACTIVITY_ID = a.ACTIVITY_ID)) ,'%Y-%m-%d %T') as END_DATE,
			a.STATUS,a.LAST_UPDATE_USER_NAME
  		from ACTIVITY a) t ) tv  -->
  	
  		select * from(
		select ACTIVITY_ID,NAME,TYPE,CREATED_DATE,LAST_UPDATE_USER,LAST_UPDATE_DATE,LAST_UPDATE_USER_NAME,PROMO_DISCOUNT_STATUS,PROMO_DISCOUNT,IS_SYSTEM_QTY,SPECIFY_SUPPLIER,SUPPLIER_RULE,ICON_STATUS,ICON_SCENES,
		DATE_FORMAT(START_DATE,'%Y-%m-%d') as startDates,
		DATE_FORMAT(END_DATE,'%Y-%m-%d') as endDates,STATUS,
		CASE 
  			WHEN CURDATE() <![CDATA[<]]> START_DATE and STATUS ='ENABLE' THEN 'NS'
  			WHEN START_DATE<![CDATA[<=]]> CURDATE() and CURDATE() <![CDATA[<=]]> END_DATE and STATUS ='ENABLE' THEN 'GOING'
  			WHEN CURDATE() <![CDATA[>]]> END_DATE and STATUS ='ENABLE' THEN 'OVER'  
		ELSE 'STOP' END as prStatus
		from ACTIVITY) t
  		<where>
  			t.STATUS !='DELETE'
  			<if test="name !=null and name !=''">
  				and t.NAME like concat('%',#{name},'%') 
  			</if>
  			<if test="type !=null and type !=''">
  				and t.TYPE = #{type}
  			</if>
  			<if test="prStatus !=null and prStatus !=''">
  				and t.prStatus = #{prStatus}
  			</if>
  			<if test="startDate !=null">
  				and STR_TO_DATE(t.CREATED_DATE,'%Y-%m-%d') &gt;= #{startDate} 
  			</if>
  			<if test="endDate !=null">
  				and STR_TO_DATE(t.CREATED_DATE,'%Y-%m-%d') &lt;= #{endDate}
  			</if>
  		</where>		
  </select>
  
  <!-- 查询活动时间（判断活动时间是否重叠） -->
  <select id="findActivityDate" parameterType="com.yikuyi.activity.vo.ActivityVo" resultType="java.lang.Integer">
<!-- 		select count(*) from ACTIVITY t1 where  t1.STATUS ='ENABLE' and
		exists( select 1 from ACTIVITY t2 where ((#{endDates} <![CDATA[>=]]> t1.START_DATE and #{endDates} <![CDATA[<=]]> t1.END_DATE) OR 
		(#{startDates} <![CDATA[>=]]> t1.START_DATE and #{startDates} <![CDATA[<=]]> t1.END_DATE) OR 
		(#{endDates} <![CDATA[>]]> t1.END_DATE and #{startDates} <![CDATA[<]]> t1.START_DATE))) OR
		(#{startDates} <![CDATA[>]]> t1.START_DATE and #{endDates} <![CDATA[<]]> t1.END_DATE))) OR
		(#{startDates} <![CDATA[=]]> t1.START_DATE and #{endDates} <![CDATA[=]]> t1.END_DATE)  -->
		SELECT
			count(1)
		FROM
			ACTIVITY t1,
			(
				SELECT
					#{startDates} start_date,
					#{endDates} end_date
			) input_date
		WHERE
		(	(
				input_date.start_date &lt;= t1.start_date
				AND input_date.end_date &gt;= t1.start_date
			)
			OR (
				input_date.start_date &lt;= t1.end_date
				AND input_date.end_date &gt;= t1.end_date
			)
			OR (
				input_date.start_date &gt;= t1.start_date
				AND input_date.end_date &lt;= t1.end_date
			)
		) and t1.STATUS !='DELETE' and t1.type != '10000'
		<if test="activityId !=null and activityId !=''">
			and t1.ACTIVITY_ID <![CDATA[<>]]> #{activityId} 
		</if>
  </select>
  
  <!-- 查询活动名称是否存在 -->
  <select id="findActivityName" parameterType="com.yikuyi.activity.vo.ActivityVo" resultType="java.lang.Integer">
  		select count(1) from ACTIVITY where NAME =#{name} and STATUS !='DELETE'
  		<if test="activityId !=null and activityId !=''">
  				and ACTIVITY_ID != #{activityId}
  		</if>
  		
  </select>
  
  <resultMap id="ActivityResultMap" type="com.yikuyi.activity.vo.ActivityVo" >
  	<id column="ACTIVITY_ID" property="activityId" jdbcType="VARCHAR" />
	<result column="NAME" property="name" jdbcType="VARCHAR" />
	<result column="TYPE" property="type" jdbcType="VARCHAR" />
	<result column="STATUS" property="status"/>
	<result column="START_DATE" property="startDates" jdbcType="VARCHAR" />
	<result column="END_DATE" property="endDates" jdbcType="VARCHAR" />
	<result column="PROMO_DISCOUNT_STATUS" property="promoDiscountStatus" jdbcType="CHAR" />
	<result column="PROMO_DISCOUNT" property="promoDiscount" jdbcType="DOUBLE" />
	<result column="IS_SYSTEM_QTY" property="isSystemQty" jdbcType="CHAR" />
	<result column="ICON_STATUS" property="iconStatus" jdbcType="CHAR" />
	<result column="ICON_SCENES" property="iconScenes" jdbcType="VARCHAR" />
	<result column="SPECIFY_SUPPLIER" property="specifySupplier" jdbcType="BOOLEAN" />
	<result column="SUPPLIER_RULE" property="supplierRule" jdbcType="VARCHAR" />
	<collection property="periodsList" column="ACTIVITY_ID" select="findAPeriods" ></collection>
  </resultMap>
  <!-- 查询活动详情 -->
  <select id="findActivityById" parameterType="java.lang.String" resultMap="ActivityResultMap">
  		select
  			NAME,
  			ACTIVITY_ID,
  			TYPE,
  			STATUS,
  			DATE_FORMAT(START_DATE,'%Y-%m-%d') START_DATE,
  			DATE_FORMAT(END_DATE,'%Y-%m-%d') END_DATE,
  			PROMO_DISCOUNT_STATUS,
  			PROMO_DISCOUNT,
  			IS_SYSTEM_QTY,
  			ICON_STATUS,
  			ICON_SCENES,
  			SPECIFY_SUPPLIER,
  			SUPPLIER_RULE
  		from ACTIVITY where ACTIVITY_ID = #{activityId}
  </select>
  
  <resultMap id="ActivityPeriodsResultMap" type="com.yikuyi.activity.model.ActivityPeriods" >
  	<id column="PERIODS_ID" property="periodsId" jdbcType="VARCHAR" />
	<result column="ACTIVITY_ID" property="activityId" jdbcType="VARCHAR" />
	<result column="START_TIME" property="startTime" jdbcType="TIMESTAMP" />
	<result column="END_TIME" property="endTime" jdbcType="TIMESTAMP" />
	<result column="STATUS" property="status" jdbcType="VARCHAR" />
  </resultMap>
  <!-- 查询活动区间 -->
  <select id="findAPeriods" parameterType="java.lang.String" resultMap="ActivityPeriodsResultMap">
  		select 
  			PERIODS_ID,
	  		ACTIVITY_ID,
	  		START_TIME,
	  		END_TIME,
	  		STATUS 
	  	from ACTIVITY_PERIODS where ACTIVITY_ID = #{activityId} 
  </select>
  
  <!-- 删除活动管理 -->
  <delete id="deleteActivity" parameterType="java.lang.String">
  		delete from ACTIVITY where ACTIVITY_ID = #{activityId}
  </delete>
  
  <resultMap id="TodayActivityResultMap" type="com.yikuyi.activity.vo.ActivityVo" >
  	<id column="ACTIVITY_ID" property="activityId" jdbcType="VARCHAR" />
	<result column="NAME" property="name" jdbcType="VARCHAR" />
	<result column="TYPE" property="type" jdbcType="VARCHAR" />
	<result column="START_DATE" property="startDate" jdbcType="TIMESTAMP" />
	<result column="END_DATE" property="endDate" jdbcType="TIMESTAMP" />
	<result column="PROMO_DISCOUNT_STATUS" property="promoDiscountStatus" jdbcType="CHAR" />
	<result column="PROMO_DISCOUNT" property="promoDiscount" jdbcType="DOUBLE" />
	<collection property="periodsList" column="ACTIVITY_ID" select="findTodayAPeriods" ></collection>
  </resultMap>
  <!-- 查询当天活动详情 -->
  <select id="getTodayActivity" resultMap="TodayActivityResultMap">
<!--   		select * from (
		select ACTIVITY_ID,NAME,TYPE,STATUS,
		DATE_FORMAT(CONCAT(DATE_FORMAT(START_DATE,'%Y-%m-%d'),' ',(SELECT MIN(p.START_TIME) from ACTIVITY_PERIODS p where p.ACTIVITY_ID = a.ACTIVITY_ID)) ,'%Y-%m-%d %T') as START_DATE,
		DATE_FORMAT(CONCAT(DATE_FORMAT(END_DATE,'%Y-%m-%d'),' ',(SELECT MAX(p1.END_TIME) from ACTIVITY_PERIODS p1 where p1.ACTIVITY_ID = a.ACTIVITY_ID)) ,'%Y-%m-%d %T') as END_DATE
		from ACTIVITY a ) tv
		where tv.START_DATE &lt;= NOW() and tv.END_DATE &gt;=NOW() and tv.STATUS ='ENABLE' order by tv.START_DATE  LIMIT 1 -->
		
		
		select ACTIVITY_ID,NAME,TYPE,STATUS,
		DATE_FORMAT(START_DATE,'%Y-%m-%d'),
		DATE_FORMAT(END_DATE,'%Y-%m-%d'),
		PROMO_DISCOUNT_STATUS,
		PROMO_DISCOUNT
		from ACTIVITY 
		where START_DATE &lt;= CURDATE() and END_DATE &gt;=CURDATE() and STATUS ='ENABLE' AND TYPE !='10000' order by START_DATE LIMIT 1
  </select>
  
   <!-- 查询当天活动详情 -->
  <select id="getActivityStandardById" resultMap="TodayActivityResultMap" parameterType="java.lang.String">
		select ACTIVITY_ID,NAME,TYPE,STATUS,
		DATE_FORMAT(START_DATE,'%Y-%m-%d'),
		DATE_FORMAT(END_DATE,'%Y-%m-%d'),
		PROMO_DISCOUNT_STATUS,
		PROMO_DISCOUNT
		from ACTIVITY 
		where START_DATE &lt;= CURDATE() and END_DATE &gt;=CURDATE() and STATUS ='ENABLE' and ACTIVITY_ID =#{activityId}  order by START_DATE LIMIT 1
  </select>
  
  <!-- 查询活动区间 -->
  <select id="findTodayAPeriods" parameterType="java.lang.String" resultMap="ActivityPeriodsResultMap">
  		select 
  			PERIODS_ID,
	  		ACTIVITY_ID,
	  		START_TIME,
	  		END_TIME,
	  		STATUS 
	  	from ACTIVITY_PERIODS where ACTIVITY_ID = #{activityId} and STATUS ='ENABLE'
  </select>

  
  <select id="getEnableActivity" resultMap="BaseResultMap">
  	SELECT t.ACTIVITY_ID,t.NAME,t.TYPE,t.START_DATE,t.END_DATE,t.PROMO_DISCOUNT_STATUS,t.PROMO_DISCOUNT,t.IS_SYSTEM_QTY,t.SPECIFY_SUPPLIER,t.SUPPLIER_RULE,t.ICON_STATUS,t.ICON_SCENES,
  	   a.PERIODS_ID,a.START_TIME,a.END_TIME,b.ACTIVITY_PRODUCT_ID,
       b.PRODUCT_ID,b.MANUFACTURER_PART_NUMBER,b.MANUFACTURER,b.SOURCE_ID,b.SOURCE_NAME,b.VENDOR_ID,
       b.VENDOR_NAME,b.DISCOUNT,b.CURRENCY_UOM_ID,b.QTY_BREAK_1,b.PRICE_BREAK_1,b.QTY_BREAK_2,
       b.PRICE_BREAK_2,b.QTY_BREAK_3,b.PRICE_BREAK_3,b.QTY_BREAK_4,b.PRICE_BREAK_4,b.QTY_BREAK_5,
       b.PRICE_BREAK_5,b.TITLE,b.SUB_TITLE,b.IMAGE_1,b.IMAGE_2,b.IMAGE_3,b.IMAGE_4,b.IMAGE_5,
       b.TOTAL_QTY,b.QTY,b.DESCRIPTION,b.CATEGORY_3_NAME,b.CATEGORY_3_ID
	FROM ACTIVITY t LEFT JOIN ACTIVITY_PERIODS a ON t.ACTIVITY_ID = a.ACTIVITY_ID LEFT JOIN ACTIVITY_PRODUCT b ON 
	a.PERIODS_ID = b.PERIODS_ID AND a.ACTIVITY_ID = b.ACTIVITY_ID 
	WHERE t.`STATUS` = 'ENABLE' AND a.STATUS = 'ENABLE' 
	    AND (t.START_DATE  <![CDATA[ <= ]]>  CURDATE()  AND t.END_DATE <![CDATA[ >= ]]> CURDATE() ) ORDER BY t.`LAST_UPDATE_DATE`
  </select>
  
   <select id="getStartActivity" resultMap="BaseResultMap">
  	SELECT t.ACTIVITY_ID,t.NAME,t.TYPE,t.START_DATE,t.END_DATE,t.PROMO_DISCOUNT_STATUS,t.PROMO_DISCOUNT,t.IS_SYSTEM_QTY,t.SPECIFY_SUPPLIER,t.SUPPLIER_RULE,t.ICON_STATUS,t.ICON_SCENES,
  	   a.PERIODS_ID,a.START_TIME,a.END_TIME,b.ACTIVITY_PRODUCT_ID,
       b.PRODUCT_ID,b.MANUFACTURER_PART_NUMBER,b.MANUFACTURER,b.SOURCE_ID,b.SOURCE_NAME,b.VENDOR_ID,
       b.VENDOR_NAME,b.DISCOUNT,b.CURRENCY_UOM_ID,b.QTY_BREAK_1,b.PRICE_BREAK_1,b.QTY_BREAK_2,
       b.PRICE_BREAK_2,b.QTY_BREAK_3,b.PRICE_BREAK_3,b.QTY_BREAK_4,b.PRICE_BREAK_4,b.QTY_BREAK_5,
       b.PRICE_BREAK_5,b.TITLE,b.SUB_TITLE,b.IMAGE_1,b.IMAGE_2,b.IMAGE_3,b.IMAGE_4,b.IMAGE_5,
       b.TOTAL_QTY,b.QTY,b.DESCRIPTION,b.CATEGORY_3_NAME,b.CATEGORY_3_ID
	FROM ACTIVITY t LEFT JOIN ACTIVITY_PERIODS a ON t.ACTIVITY_ID = a.ACTIVITY_ID LEFT JOIN ACTIVITY_PRODUCT b ON 
	a.PERIODS_ID = b.PERIODS_ID AND a.ACTIVITY_ID = b.ACTIVITY_ID 
	WHERE t.`STATUS` = 'ENABLE' AND a.STATUS = 'ENABLE'  AND t.START_DATE = CURDATE() ORDER BY t.`LAST_UPDATE_DATE`
  </select>

	<select id="getEndActivity" resultMap="BaseResultMap">
  	SELECT t.ACTIVITY_ID,t.NAME,t.TYPE,t.START_DATE,t.END_DATE,t.PROMO_DISCOUNT_STATUS,t.PROMO_DISCOUNT,t.IS_SYSTEM_QTY,t.SPECIFY_SUPPLIER,t.SUPPLIER_RULE,t.ICON_STATUS,t.ICON_SCENES,
  	   a.PERIODS_ID,a.START_TIME,a.END_TIME,b.ACTIVITY_PRODUCT_ID,
       b.PRODUCT_ID,b.MANUFACTURER_PART_NUMBER,b.MANUFACTURER,b.SOURCE_ID,b.SOURCE_NAME,b.VENDOR_ID,
       b.VENDOR_NAME,b.DISCOUNT,b.CURRENCY_UOM_ID,b.QTY_BREAK_1,b.PRICE_BREAK_1,b.QTY_BREAK_2,
       b.PRICE_BREAK_2,b.QTY_BREAK_3,b.PRICE_BREAK_3,b.QTY_BREAK_4,b.PRICE_BREAK_4,b.QTY_BREAK_5,
       b.PRICE_BREAK_5,b.TITLE,b.SUB_TITLE,b.IMAGE_1,b.IMAGE_2,b.IMAGE_3,b.IMAGE_4,b.IMAGE_5,
       b.TOTAL_QTY,b.QTY,b.DESCRIPTION,b.CATEGORY_3_NAME,b.CATEGORY_3_ID
	FROM ACTIVITY t LEFT JOIN ACTIVITY_PERIODS a ON t.ACTIVITY_ID = a.ACTIVITY_ID LEFT JOIN ACTIVITY_PRODUCT b ON 
	a.PERIODS_ID = b.PERIODS_ID AND a.ACTIVITY_ID = b.ACTIVITY_ID 
	WHERE t.`STATUS` = 'ENABLE' AND a.STATUS = 'ENABLE'  AND t.START_DATE = DATE_ADD(CURDATE(),INTERVAL -1 DAY) ORDER BY t.`LAST_UPDATE_DATE`
  </select>

</mapper>