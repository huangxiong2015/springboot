/**
 * create by roy.he@yikuyi.com at 2017-8-18
 */
var vm = new Vue({
	el: '#detailVendor',
	data: {
		id: getQueryString('partyId'),
		tabValue: 'baseData', //baseData,product,credit,sales
		noSales: false,
		noContactInfo: false,
		baseData: {
			vendorInfoAttributeMap:{}
		},
		productLines: [],
		creditInfo: {
			creditAttributeMap:{}
		},
		salesInfo: {
			saleAttributeMap:{},
			contactPersonInfoList:[],
		},
		vendorLogo: '',
		auditList: [],
		downLoadUrl:[],
	},
	created: function(){
		var _this =this;

		getBaseData(_this.id)
		
		getProductLine(_this.id)
		
		getCreditInfo(_this.id);
		
		getSalesInfo(_this.id)
		
		getAuditList(_this.id)

	}
})

function getBaseData(id){
	syncData(ykyUrl.party + "/v1/vendors/vendorInfo/"+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.baseData = res;
			if(vm.baseData.logoImageUrl){
				getPrivateUrl(vm.baseData.logoImageUrl);
			}
		}
	});
}

function getProductLine(id){
	syncData(ykyUrl.party + "/v1/vendors/productLine/"+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.productLines = res;
		}
	});
}

function getCreditInfo(id){
	syncData(ykyUrl.party + "/v1/vendors/vendorCredit/"+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.creditInfo = res;
			if(res){
				if(!vm.creditInfo.creditAttributeMap){
					vm.creditInfo.creditAttributeMap = {};
				}
				if(!vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEAL){
					vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEAL = 'NOT_SIGN';
				}
				if(!vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEALDATE){
					vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEALDATE = '';
				}
				if(!vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOL){
					vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOL = 'NOT_SIGN';
				}
				if(!vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE){
					vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE = '';
				}
				if(res.creditAttachmentList){
					var creditAttachList = res.creditAttachmentList;
					var attachUrls = [];
					/*vm.creditAttachListLength = creditAttachList.length;*/
					if(creditAttachList.length>0){
						$.each(creditAttachList,function(index,item){
							if(item.attachmentUrl){
								attachUrls.push(item.attachmentUrl);
							}
						})
						getPrivateUrls(attachUrls);
					}
				}
			}
		}
	});
}

function getSalesInfo(id){
	syncData(ykyUrl.party + "/v1/vendors/vendorSaleInfo/"+id, 'GET', null, function(res, err) {
		if (!err) {
			if(res.offerId && res.offerId === $('#userId').val()){
				vm.noContactInfo = true;
			}
			if(!res.orderVerify && getQueryString('status') !== 'salesDetail'){
				vm.noSales = true;
			}
			vm.salesInfo = res;
			
			if(res){	
				if(!vm.salesInfo.contactPersonInfoList){
					vm.salesInfo.contactPersonInfoList = [];
				}
				if(!vm.salesInfo.saleAttributeMap){
					vm.salesInfo.saleAttributeMap = {};
				}
				if(!vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_FOCUSFIELDS){
					vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_FOCUSFIELDS = '';
				}
				if(!vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_MAJORCLIENTS){
					vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_MAJORCLIENTS = '';
				}
				if(!vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_PRODUCTCATEGORYS){
					vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_PRODUCTCATEGORYS = '';
				}
				if(!vm.salesInfo.saleAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE){
					vm.salesInfo.saleAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE = '';
				}
				for(var i = 0; i<vm.salesInfo.contactPersonInfoList.length; i++){
					if(vm.salesInfo.contactPersonInfoList[i].partyProductLineIdList){
						vm.salesInfo.contactPersonInfoList[i].partyProductLineList = [];
						for(var j = 0; j < vm.salesInfo.contactPersonInfoList[i].partyProductLineIdList.length; j++){
	        				for(var k = 0; k < vm.salesInfo.partyProductLineList.length; k++){
	        					if(vm.salesInfo.contactPersonInfoList[i].partyProductLineIdList[j] === vm.salesInfo.partyProductLineList[k].partyProductLineId){
	        						vm.salesInfo.contactPersonInfoList[i].partyProductLineList.push(vm.salesInfo.partyProductLineList[k]);
	        					}
	        				}
	        			}
					}    					        		
				}
			}
		}
	});
}

function getAuditList(id){
	syncData(ykyUrl.party + "/v1/audit?actionRst=SUCCEEDED&size=1000&actionId="+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.auditList = res.list;
		}
	});
}

var getPrivateUrl =  function(url){
	$.aAjax({
		url: ykyUrl.party + "/v1/enterprises/getImgUrl",
     	type:"POST",
     	data:JSON.stringify({"id":url}),
     	success: function(data) {
     		if(null !=data || data == ""){
     			vm.vendorLogo = data;
     		}
     	},
     	error:function(e){
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
 	});
}

function getPrivateUrls(urlArr){
	var urls = urlArr;
	var emptylist = [];
	function getPrivateUrlSubProcedure(urls){
		$.aAjax({
			url: ykyUrl.party + "/v1/enterprises/getImgUrl",
	     	type:"POST",
	     	data:JSON.stringify({"id":urls[0]}),
	     	success: function(data) {
	     		emptylist.push(data);
     			urls = urls.splice(1);
	     		if(urls.length!=0){
	     			while(urls[0]==""&&urls.length>0){
	     				emptylist.push("");
	         			urls.splice(1);
	     			}
	     			if(urls.length>0){
	     				getPrivateUrlSubProcedure(urls);
	     			}
	     			
	     		}else if(urls.length==0){
	     			vm.downLoadUrl = emptylist;
	     			/*return emptylist;*/
	     		}
	     	},
	     	error:function(e){
	     		emptylist.push(urls[0]);
	     		urls = urls.splice(1);
	     		if(urls.length!=0){
	     			while(urls[0]==""&&urls.length>0){
	     				emptylist.push("");
	         			urls.splice(1);
	     			}
	     			if(urls.length>0){
	     				getPrivateUrlSubProcedure(urls);
	     			}
	     			
	     		}else if(urls.length==0){
	     			vm.downLoadUrl = emptylist;
	     			/*return emptylist;*/
	     		}
		    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
		    }
	 	});
	}
	getPrivateUrlSubProcedure(urls);
}
