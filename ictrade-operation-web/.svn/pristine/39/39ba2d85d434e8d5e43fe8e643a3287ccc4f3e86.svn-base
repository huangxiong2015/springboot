
var passwordArray = [];
var cDetail = {};   //暂存getDetail结果，等调用获取private图片的服务返回结果后先将结果赋值给cDetail.approvedProof,再一起将它赋值给showData.detail
var showData = avalon.define({
    $id: "data",
    detail:{},
    logList:[],
    logListNull:false,
    offList:[],
    offListNull:false,
    getAvailbleProduct:function(){
    	if(!showData.detail.vendorName&&!showData.detail.brandName){
    		return "全平台通用";
    	}else if(showData.detail.vendorName&&showData.detail.brandName){
    		return "供应商:"+showData.detail.vendorName+"制作商:"+showData.detail.brandName;
    	}else if(showData.detail.vendorName&&!showData.detail.brandName){
    		return "供应商:"+showData.detail.vendorName+"制作商：不限";
    	}else if(!showData.detail.vendorName&&showData.detail.brandName){
    		return "供应商:不限，"+"制作商"+showData.detail.brandName;
    	}
    },
    showBigImage:function(){
		if($('.big_img').attr("src")!=''){
			layer.open({
				  type: 1,
				  title: false,
				  closeBtn: 0,
				  area: ['800px', '500px'],
				  offset: '100px',
				  shadeClose: true,
				  content: $('.big_img')
			});
		}
	},
    exportInfo:function(){
    	exportData();
    }
});

var getPrivateUrl =  function(){
	$.aAjax({
		url: ykyUrl.party + "/v1/enterprises/getImgUrl",
     	type:"POST",
     	data:JSON.stringify({"id":cDetail.approvedProof}),
     	success: function(data) {
     		if(null !=data || data == ""){
     			cDetail.approvedProof = data;
     			showData.detail = cDetail;
     		}
     	},
	    error:function(e){
	    	showData.detail = cDetail;
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
 	});
}
var getDetail = function(id,fn){
	var detailUrl = ykyUrl.pay+"/v1/coupons/detail/"+id;
	$.aAjax({
		url: detailUrl,
		type:"GET",
	    success: function(data) {
	    	/*showData.detail = data;*/
	    	cDetail =data;
	    	getPrivateUrl(data.approvedProof);
	    	if(fn!=undefined&&(data.couponCate=='OFFLINE_PROMO'||data.couponCate=='offline_promo')){
	    		fn();
	    	}
	    },
	    error:function(e){
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
	});
}

var getLogList = function(id){
	var logListUrl = ykyUrl.pay+"/v1/coupons/getCouponStatusList/"+id+"?actionName=EDIT";
	$.aAjax({
		url: logListUrl,
		type:"GET",
	    success: function(data) {
	    	showData.logList = data;
	    	if(data.length>0){
	    		showData.logListNull = true;
	    	}
	    },
	    error:function(e){
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
	});
}
var getOfflineList = function(id){
	var offListUrl = ykyUrl.pay+"/v1/coupons/getOfflinePromoList/"+id;
	$.aAjax({
		url: offListUrl,
		type:"GET",
	    success: function(data) {
	    	showData.offList = data;
	    	if(data.length>0){
	    		showData.offListNull = true;
	    		$.each(data,function(i,n){
	    			var temp = {
    					"couponCodeId": n.couponCodeId, 
    				    "partyName": n.partyName

	    			}
	    			passwordArray.push(temp);
	    		})
	    	}
	    },
	    error:function(e){
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
	});
}

var exportData = function(){
	$.aAjax({
		url: ykyUrl.pay + "/v1/coupons/exportCouponCode",
     	type:"POST",
     	data:JSON.stringify(passwordArray),
     	success: function(data) {
     		var zipUrl = data;
	    	if(zipUrl.indexOf("http")!=-1){
	    		window.location.href = zipUrl;
	    	}else{
	    		console.log("系统错误，审批失败，请联系系统管理员："+zipUrl);
	    	}
     	}
 	});
}
var initUI = function(id){
	if(id){
		getDetail(id,function(){
			getOfflineList(id);
		});
		getLogList(id);
	}else{
		console.log("id为空,系统错误，审批失败，请联系系统管理员：");
	}
}
$(function(){
	var id = getQueryString("id");
	initUI(id);
})