var app = new Vue({
	el: '#limitPurch',
	data: {
		id:$("#detailId").val(),
		type:'',
		showPrdList:true,
		showModal:false,
		modalStyle:{
			width:950,
			maxHeight:600,
			overflowY:'auto'
		},
		modalTitle:'添加商品',
		productAssociate:{
        	api: ykyUrl.product + '/v1/products/batch/basic',
        	requestType: 'POST',
        	productData:{
        		id:'', //商品id
	    		prdUrl:'', //型号链接
				model:'', //型号
				manufacturer:'',  //原厂
				manufacturerId:'', //原厂id
				sourceId:'', //仓库id
				sourceName:'', //仓库名称
				qty:'',
				moq:'',
				limitNum:''
        	},
        	isAdd:true,
        	showImage:false,
        	showLimit:true,
        },
		columns:[
		         	{key :'index', name: '序号', align:'center', width: '50px',textColor:{
		    	    	condition: "'{status}'=='UNABLE'",
		    	    	color: 'red'
		    	    		}
		         	},
		         	{key :'mpn', name: '型号', align:'center',cutstring: true,'default' : '-',textColor:{
		    	    	condition: "'{status}'=='UNABLE'",
		    	    	color: 'red'
		    	    		}
		         	},
		         	{key :'brandName', name: '原厂', align:'center',cutstring: true,'default' : '-',textColor:{
		    	    	condition: "'{status}'=='UNABLE'",
		    	    	color: 'red'
		    	    		}
		         	},
		         	{key :'vendorName', name: '分销商', align:'center',cutstring: true,'default' : '-',textColor:{
		    	    	condition: "'{status}'=='UNABLE'",
		    	    	color: 'red'
		    	    		}
		         	},
		         	{key :'sourceName', name: '仓库', align:'center',cutstring: true,'default' : '-',textColor:{
		    	    	condition: "'{status}'=='UNABLE'",
		    	    	color: 'red'
		    	    		}
		         	},
		         	{key :'qty', name: '库存', align:'center',cutstring: true,'default' : '-',textColor:{
		    	    	condition: "'{status}'=='UNABLE'",
		    	    	color: 'red'
		    	    		}
		         	},
		         	{key :'moq', name: '起订量', align:'center',cutstring: true,'default' : '-',textColor:{
		    	    	condition: "'{status}'=='UNABLE'",
		    	    	color: 'red'
		    	    		}
		         	},
		         	{key :'limitNum', name: '限购数', align:'center',cutstring: true,'default' : '-',textColor:{
		    	    	condition: "'{status}'=='UNABLE'",
		    	    	color: 'red'
		    	    		}
		         	},
		         	{key :'operate', name: '操作', align:'center',
		         		items:[
	         		    	   {className:'btn-detail',
		         		    	text: '详情',
		         		    	show: true,
       		         		    callback: {
       		         		    	action: 'detailPrd', 
       		                        params: ['{rowData}']
       		         		    	}
	         		    	   	},
	         		    	   {className:'btn-detail',
		         		    	text: '删除',
		         		    	show: true,
       		         		    callback: {
	       		         		    confirm: {
	       		                		title : '删除',
	       								content : '确认删除？'
	       		                	},
       		         		    	action: 'delPrd', 
       		                        params: ['{id}']
       		         		    	}
	         		    	   	}
		         		       ]
		         	}
		         ],
        pageflag:true,
		prdListApi:ykyUrl.product + '/v1/strategyProductDraft',
		queryParams:{
			strategyId:'',
			page:1,
			pageSize:10,
			defaultStatus:true
		},
		defaultTip:'暂无数据',
		initData:{
			title:'', //名称
			strategyType:'FREE_DERIVERY', //类型（限购），方便后续拓展
			startDate:'', //限购开始时间
			endDate:'', //限购结束时间
			//limitNum:'' //限购数量
		},
		disabled:false,
	},
	mounted:function(){
		var that = this;
		$('#startDate').datetimepicker({
		    language:  config.language, 
		    format: 'yyyy-mm-dd hh:ii:00',
		    minuteStep: 1,
		    autoclose: true,
		    todayHighlight: true,
		    pickerPosition: "bottom-left"
		}).on('change',function(ev){
		    var startDate = $('#startDate').val();
		    $("#endDate").datetimepicker('setStartDate',startDate);
		    that.initData.startDate = startDate;
		    $('#startDate').valid();
		    that.dateValidate()
		});
		
		$('#endDate').datetimepicker({
			 language:  config.language, 
		     format: 'yyyy-mm-dd hh:ii:00',
		     minuteStep: 1,
		     autoclose: true,
		     todayHighlight: true
		}).on('change',function(ev){
		    var endDate = $('#endDate').val();
		    $("#startDate").datetimepicker('setEndDate',endDate);
		    that.initData.endDate = endDate;
		    $('#endDate').valid();
		    that.dateValidate()
		});
	},
	created:function(){
		var that = this;
		if(this.id){
			this.type = 'PUT';
			//将正式商品表中的数据迁移到草稿表中
			syncData(ykyUrl.product + '/v1/strategy/cpoyStartegyProductToDraft?strategyId=' + this.id, 'POST', null, function(res, err){
				if(err == null){
					that.queryParams.strategyId = that.id;
					that.queryParams.defaultStatus = !that.queryParams.defaultStatus;
				}
			});
			//获取规则详情
			syncData(ykyUrl.product + '/v1/strategy/' + this.id, 'GET', null, function(res, err){
				if(err == null){
					that.initData = res;
					that.$nextTick(function(){
						if(that.id){
							$("#startDate").datetimepicker('setEndDate',that.initData.endDate);
							$("#endDate").datetimepicker('setStartDate',that.initData.startDate);
						}
					})
				}
			})
		}else{
			this.type = 'POST';
			this.id = $("#strategId").val();
			this.queryParams.strategyId = this.id;
			this.queryParams.defaultStatus = !this.queryParams.defaultStatus;
		}
	},
	methods:{
		dateValidate:function(){
			$('.daterange-tip').hide();
			var startDate = this.initData.startDate,
				endDate = this.initData.endDate;
			if(startDate && endDate){
				var sd = new Date(startDate),
					ed = new Date(endDate);
				var bool = sd >= ed ? false : true;
				if(!bool){
					$('.daterange-tip').show();
				}
				return bool
			}else{
				return true
			}
		},
		toggleModal: function(){
			this.showModal = false;
		},
		getProductInfo: function(data){
			var that = this;
			if(this.productAssociate.isAdd){
				var obj = {
						strategyId:this.id,
	        			mpn:data.model ? data.model : '',
						mpnUrl:data.prdUrl ? data.prdUrl : '',
						brandId:data.manufacturerId ? data.manufacturerId : '',
						brandName:data.manufacturer ? data.manufacturer : '',
						vendorId:data.vendorId ? data.vendorId : '',
					    vendorName:data.vendorName ? data.vendorName : '',
						productId:data.id ? data.id : '',
						imageUrl:data.imageUrl ? data.imageUrl : '',
						sourceId:data.sourceId ? data.sourceId : '',
						sourceName:data.sourceName ? data.sourceName : '',
						qty:data.qty?data.qty:'',
						moq:data.moq?data.moq:'',
						limitNum:data.limitNum
				}
				if(obj.qty < obj.limitNum){
					layer.msg('限购数不能大于库存数！');
					return;
				}
				//商品数据保存到草稿表中
				syncData(ykyUrl.product + '/v1/strategyProductDraft', 'POST', obj, function(res, err){
					if(err == null){
						that.queryParams.defaultStatus = !that.queryParams.defaultStatus;
						that.showModal = false;
					}
				})
			}else{
				this.showModal = false;
			}
		},
		addProduct: function(){
			this.productAssociate.productData = {
					id:'',
					prdUrl:'',
					model:'',
					manufacturer:'',
					manufacturerId:'',
					sourceName:'',
					sourceId:'',
					vendorId:'',
					vendorName:'',
					qty:'',
					limitNum:''
			}
			this.productAssociate.isAdd = true;
			this.showModal = true;
		},
		saveData: function(){
			$("#create").submit();
		},
		cancel: function(){
			location.href = ykyUrl._this + "/limitPurch.htm";
		}
	}
	
});
formValidate('#create', {}, function(){
	if(!app.dateValidate()){
		return
	}
	var data = $("#create").serializeObject(),
		type = app.type,
		url = type == 'POST' ? ykyUrl.product + '/v1/strategy?strategyId=' + app.id : ykyUrl.product + '/v1/strategy/' + app.id;
	data.startDate = Date.parse(new Date(data.startDate));
	data.endDate = Date.parse(new Date(data.endDate));
	syncData(url, type, data, function(res, err){
		if(err == null){
			app.disabled = true;
			layer.msg('保存成功！');
			setTimeout(function(){
				location.href = ykyUrl._this + "/limitPurch.htm";
			},2000);
		}
	})
})
function detailPrd(id,param){
	var productData = app.productAssociate.productData;
	productData.id = param[0].id;
	productData.model = param[0].mpn;
	productData.manufacturer = param[0].brandName;
	productData.qty = param[0].qty;
	productData.moq = param[0].moq;
	productData.limitNum = param[0].limitNum;
	app.productAssociate.isAdd = false;
	app.showModal = true;
}
function delPrd(id,param){
	multiDelete(ykyUrl.product + '/v1/strategyProductDraft/delete?strategyType=LIMITATIONS', 'DELETE', param, function(res, err){
		if(err == null){
			app.queryParams.defaultStatus = !app.queryParams.defaultStatus;
		}
	})
}