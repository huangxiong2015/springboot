<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%@taglib uri="http://www.springframework.org/tags/form" prefix="form" %>
<%@taglib prefix="spring" uri="http://www.springframework.org/tags" %>
<c:set var="ctx" value="${pageContext.request.contextPath }" scope="request" />
<!-- <!DOCTYPE> -->
<!DOCTYPE html>
<html lang="zh-CN">
<html>
<head>
<title>编辑物料</title>
<style type="text/css">
/* 物料详情  */
.table .name {
	background-color: #eeeeee;
	text-align: right;
	padding-right: 10px;
}

.table .value {
	background-color: #fff;
	text-align: left;
	padding-left: 10px;
}

a:hover, a:active, a:focus {
	color: #23527c;
}

#largeImg {
	position: absolute;
	z-index: 99999;
}

.litterImg {
	width:100px;
	height:100px;
}

.bigImg {
	width: 200px;
	height: 200px;
	border:2px solid #d6d6d6;
}
.content{
  background-color: #fff;
 }
 .col-xs-10 ul li{
  list-style: none;
  }
  .l{
    float:left;
  }
  .mt30{
     margin-top:30px;
   }
  .mt10{
  margin-top:10px;}
.mt20{
  margin-top:20px;}
  .r{
    float:right;
  }
  #todateCode{
    height: 185px;
    width: 100%;
    padding: 10px;
  }
  .logo-box #uploadback{
    position: absolute;
    bottom: 0;
    width: 120px;

  }
  input[type=button]{
   filter: alpha(opacity=0.8);
    -moz-opacity: 0.8;
    -khtml-opacity:0 .8;
    opacity: 0.8;
  }
  
  .manu_logo .file-btn{
    width: 120px;
    margin-top: 20px;
  }
  .remove-box{
   margin-top:35px;
   margin-left:10px;
  }
  .del_logo, .re-change, .manu_text{
   margin-right:10px;
  }
  .add-box{
  margin-top:20px;
 
  }
  
 .condition_inquery{
    background-color: #c11f2e;
    color: #fff;
    padding: 10px 20px;
    font-size: 14px;
    border-radius: 3px;
  }
  .return_btn{
    padding: 10px 20px;
    cursor: pointer;
    border: solid 1px #ddd;
    border-radius: 3px;
    font-size: 14px;
    color: #919191;
    margin-left: 30px;
  }
  .logo-box  img{
    width: 120px;
    height: 120px;
   }
   .b_red{
    border:1px  solid #eb0038;
    }
</style>

<c:import url ="/WEB-INF/jsp/include/lemon/constants.jsp"/>
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">
<c:import url ="/WEB-INF/jsp/include/lemon/layout.jsp"/>
	<div class="content-wrapper" id="extension_edit">
			<section class="content-header">
			  <h1>
			    	编辑物料
			    <small class="edit_state"></small>
			  </h1>
			  <ol class="breadcrumb">
			    <li><a href="./"><i class="fa fa-dashboard"></i> 首页</a></li>
			    <li class="active">编辑物料</li>
			  </ol>
			</section>

<section class="content" style="color:#666;">
<form class="form-horizontal" name="materials-modify" id="materials-modify" onsubmit="return false;" >

<!-- Main content -->
	 <div style="min-height: 406px;" >
		<section  class="content container-fluid" >
			<div class="row mt20">
				<div class="col-xs-6">
					<div class="row ">
						<div class="row ">
							<div class="col-xs-2 tr pl0">
								<label >物料型号：</label>
							</div>
							<div class="col-xs-10 c5e">
								<span  v-html="datas.manufacturerPartNumber ? datas.manufacturerPartNumber : '--' "></span>
							</div>
						</div>
						 <div class="row mt30">
							<div class="col-xs-2 tr">
								<label>物料分类：</label>
							</div>
							<div class="col-xs-10 c5e">
								<span v-for="ele in datas.categories">
								   <i v-if="ele.cateLevel=='1'" class="l">{{ele.cateName}}></i>
								   <i v-if="ele.cateLevel=='2'" class="l">{{ele.cateName}}></i>
								   <i v-if="ele.cateLevel=='3'" class="l">{{ele.cateName}}</i>
								</span>
							</div>
						</div>
						<div class="row mt30">
							<div class="col-xs-2 tr">
								<label>原厂：</label>
							</div>
							<div class="col-xs-10 c5e">
								<span v-html="datas.manufacturer ? datas.manufacturer : '--' "></span>
							</div>
						</div>
						<div class="row mt30">
							<div class="col-xs-2 tr">
								<label >物料图片：</label>
								<span></span>
							</div>
							<div class="col-xs-10 c5e">
								 <span>
									<%--  <ul v-for="(index,ele) in datas.images"
										v-on:mouseover="fn()"  v-on:mouseout="fn1()">
										<li :if="ele.type == 'thumbnail'" class="l">
										 <img src="${ctx}/images/defaultImg01.jpg" class="litterImg"  :attr="{'src':ele.url}"></li>

									</ul>  --%>
								<div class="logo-box">
				                     <input class="btn" type="button" value="上传文件" id="uploadback" >
				                     <img alt="" :src="attachUrl1 ? attachUrl1 : '${ctx}/images/static/defaultImg.120.jpg'" class="background" />
				                     <i>支持不大于2M的jpg、jpeg、png格式图形文件 </i>

				                </div>
				                   <input type="text" v-model="attachUrl1" id="attachUrl1" name="attachUrl1"  style="visibility: hidden;height:0;" required>
							    </div>
								</span>

						</div>
						<div class="row mt30   include"   >
				               <multi-file
						            :keyname="uploadFiles.keyname"
						            :file-id= "uploadFiles.key"
						            :file-name= "uploadFiles.name"
						            :button-id= "uploadFiles.config.buttonId"
						            :upload-type= "uploadFiles.config.uploadType"
						            :url= "uploadFiles.config.url"
						            :types= "uploadFiles.config.types"
						            :file-size= "uploadFiles.config.fileSize"
						            :is-image= "uploadFiles.isImage" 
						            :attach-files="uploadFiles.attachFiles"
						            :max-length="uploadFiles.max" 
						            ref="files"
                              ></multi-file>
                         

						</div>

				
						<div class="row mt30">
							<div class="col-xs-2 tr">
								<label>RoHS标准：</label>
							</div>
							<div class="col-xs-10 c5e">
								<span>
									<input id="isrohs" type="radio" name="isrohs"  value="true"  v-model="isrohs" >
									<label for="isrohs">符合</label></span>
									<span>
									<input id="isnorohs" type="radio" name="isrohs" value="false" v-model="isrohs" >
									<label for="isnorohs">不符合</label>
									<input id="norohs" type="radio" name="isrohs" value="" v-model="isrohs" >
									<label for="norohs">未知</label>
								</span>

							</div>
						</div>
						<div class="row mt30">
							<div class="col-xs-2 tr ">
								<label>物料描述：</label>
							</div>
							 <div class="col-xs-10 c5e">
								<textarea   id="todateCode"  maxlength="800"   v-model="datas.description">
                                </textarea>
                                <p><span class="r">/800</span><span class="r" id='number'>0</span></p >
							</div>
						</div>
						<div class="row mt30  mb30">
							<div class="col-xs-2 tr ">
								<label>状态：</label>
							</div>
							<div class="col-xs-10 c5e">
								<span> 
								<input id="status" type="radio" name="status" value="0" v-model = "status">
									<label for="status">有效</label></span>
									<span>
									<input id="nostatus" type="radio" name="status" value="1"  v-model = "status">
									<label for="nostatus">失效</label>
								
								</span>
							</div>
						</div>
						<div class="row mt30  mb30">
							<div class="col-xs-2 tr ">
								<label>是否限制物料：</label>
							</div>
							<div class="col-xs-10 c5e">
								<span>
								<input id="nType" type="radio" name="MaterialType" value="N" v-model ="MaterialType">
									<label for="nType">否</label></span>
									<span>
									<input id="pType" type="radio" name="MaterialType" value="P" v-model ="MaterialType">
									<label for="pType">需特殊包装</label>
									<input id="fType" type="radio" name="MaterialType" value="F" v-model ="MaterialType">
									<label for="fType">需特殊文件</label>
								
								</span>
							</div>
						</div>
					</div>
					     <div class="ovh btn mt20 ml30 pl30" style="margin-left: 300px;margin-bottom: 30px;">
				              <a id="save_btn" class="l mr30 btnStyle01 dib f16 tc active ml30 condition_inquery" href="javascript:;">提交</a>
				              <a id="cancel_btn" class="l mr20 btnStyle01 dib f16 tc return_btn" href="javascript:;">取 消</a>
				          </div>
				</div>
				<div class="col-xs-6">
					<div class="row">
						<div class="col-xs-2 pl0">
							<label>物料参数：</label>
						</div>
						<div class="col-xs-10 c5e">
							<table class="table">
								<tbody>
									 <tr v-for="ele in datas.parameters">
										<td class="name">{{ele.name}}</td>
										<td class="value">{{ele.value}}</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				 
			</div>
			
		</section>
	</div>
	<!-- Main content end -->
	      </form>
	    </section>

	</div>

</div>

<!---footer  start   ---->
<jsp:directive.include file="../include/lemon/footer.jsp" />
<!---footer  end   ---->
<script type="text/javascript" src="${ctx}/js/oss/common.js"></script>
<script type="text/javascript" src="${ctx}/js/lib/plupload-2.1.2/js/plupload.full.min.js"></script>
<script type="text/javascript" src="${ctx}/js/oss/oss_uploader.js"></script>
<script src="${webres}/lib/serialize/2.5.0/jquery-serialize-object.js"></script>
<script type="text/javascript" src="${ctx}/assets/lemon/1.0.0/lemon-multi-file.js"></script>

<script type="text/javascript">
var	 vm ;
var  id = getQueryString("id");    //活动id
var from = getQueryString("from"); //manage物料管理列表页    operation物料管理（操作）列表页  
$(function() {
vm = new Vue({
        el: '#materials-modify',
        data: {
	            datas:{},
	            attachUrl1:'',    //图片上传路径
	            cur: 1,
	            curPage: 1,
	            t:0,                   //上传计数
	            len:0,
	            description:'',
	            status : 0,     //status 状态  
	            MaterialType : 'N' ,   //限制物料，是否需特殊文件等 
	            isrohs:true ,     //rohs 特殊物料 
				uploadFiles: { 
	                "keyname":'SPEC文档地址:',     //label         
	                "isImage": "false",    //是否為圖片
	                "key": "other",        //字段id
	                "name": "other[]",      //字段name 
	                "attachFiles":[],   //设置默认值
	                "config": {						//设置上传按钮
	                    "buttonId": "faceUploadBtn",
	                    "types": "pdf",
	                    "url": ykyUrl.webres,
	                    "uploadType": "notice.publicRead",
	                    "fileSize": "20mb"
	                }, 
	                "max":5  //最多上传数   
				},	
				
		},
        beforeCreate:function(){
        	var that = this;
        	nowUrl = '';
        	 if(from == 'operation'){//审核操作人员 
        			nowUrl = ykyUrl.product + "/v1/products/standaudit/" +id;
    		 }else if(from == 'manage'){
    				nowUrl = ykyUrl.product + "/v1/products/stand/" +id;
    		  }
        	//查询活动详情
        	syncData(
        			nowUrl,
        			'GET',
        			null,
        			function(res,err) {
						if(res){     //初始化 
							that.datas = res;
							   if(res.description){
								   vm.description = res.description ;  //描述 

									  var text = vm.description;
								      var counter = text.length;
								      $("#number").text(counter);
							   }
								
							   if(res.rohs  != undefined){
								   vm.isrohs = res.rohs ;   //isrohs
							   }else if(res.rohs == undefined ){
								   vm.isrohs = '';
							   }
							   if(res.status ){
								   vm.status = res.status ;  //状态 
							   }
							   if(vm.datas.images && vm.datas.images.length >0 ){
								   $.each(vm.datas.images,function(index,ele){
								    	if(ele.type == "standard" ){
								    		 vm.attachUrl1 = ele.url;      //上传图片赋值 
								    	}
								    }) 
							   }
							   var list = [];
							   if(res.documents && res.documents.length >0){
								   //值存在类型为datasheets的集合里，portal是这样取值的，其他忽略掉  
								   $.each(res.documents,function(index,ele){
									   if(ele.type == 'datasheets'){
										    $.each(ele.attaches,function(ind,el){
										    	list.push(el.url); //文档地址赋值  
										    })
										  
									   }
								    	 
								    })
							   }
							   vm.uploadFiles.attachFiles  = list; 
							   if(vm.datas.restrictMaterialType){
								   vm.MaterialType = vm.datas.restrictMaterialType;  //限制物料 
							   }
						     
						}
				    }
        		)
        },
        methods: {
          initItems:function(event){
        	   
           },
        },
        computed: {
            showLast: function() {
            }
        },
    });

//初始化 上传图片
var uploader1 = createUploader({
	buttonId: "uploadback",
	uploadType: "notice.publicRead",
	url:  ykyUrl.webres,
	types: "jpg,png,jpeg",
	fileSize: "2mb",
	isImage: true,
	init:{
		FileUploaded : function(up, file, info) {
          layer.close(index);
			if (info.status == 200 || info.status == 203) {
				console.log(_fileUrl);
				console.log(file);
				vm.attachUrl1 = _fileUrl;
			} else {
				layer.msg("上传文件失败,请重新上传！",{icon:2,offset:120});
			}
			up.files=[];
		}
	}
});
 uploader1.init();


  $("#todateCode").on("blur keyup input", function() {
      var text = $("#todateCode").val();
      var counter = text.length;
      $("#number").text(counter);
  });

  
  $("#save_btn").on("click",function(){
	  if($(this).hasClass('disabled')){
		  return;
	  }
	  
	   //vm.datas传给接口  
	     var imgeList = [{type: "thumbnail", url: ""},{type: "standard", url: ""},{type: "large", url: ""}];
	     $.each(imgeList,function(index,el){
	    		 el.url = vm.attachUrl1;
	     })
	     
	     if(vm.datas.images && vm.attachUrl1 !='' ){
	    	 vm.datas.images = imgeList ;  //组装好3张图 ，赋值给 images对象 
	     }
	    
	    var obj={
	    	attaches:[],
	    	type:'datasheets'
	     }
	   //校验不规范文档地址 
	     if(vm.uploadFiles.attachFiles.length > 0 ){
	    	 var itemList = vm.uploadFiles.attachFiles;
	    	 $.each(itemList,function(ind,el){
	    		   if(el){
	    			   itemList[ind] = cutUrl(el,ind); 
	    		   }
	    		  
	    	 })
	    	 
	     }
	    $.each(vm.datas.documents,function(index,ele){
	    	 if(ele.type == 'datasheets'){
	    		 ele.attaches = [];  //重置文档集合 
				 //var itemList = vm.uploadFiles.attachFiles ;//name直接去掉了,文档地址直接赋值 
					$.each(itemList,function(ind,el){
						 var item ={
							    	url:''	 
							       };
						if(el){
							item.url = el ;
							ele.attaches.push(item);
						}
					})
			  }
	    	 
	     }) 
	    
	     //documents集合为空，往里面新增 
	    if(!vm.datas.documents || vm.datas.documents.length == 0){
    		vm.datas.documents = [];
	    	// var itemList = vm.uploadFiles.attachFiles ;//name直接去掉了,文档地址直接赋值 
				$.each(itemList,function(ind,el){
					var item ={
					    	url:''	 
					       };
					if(el){
						item.url = el ;
						obj.attaches.push(item);
					}
					
					
				})
	    	vm.datas.documents.push(obj);
	    }
	    
	    vm.datas.rohs  =  vm.isrohs ;   //isrohs
	    vm.datas.status = vm.status ;  //状态 
	    vm.datas.restrictMaterialType = vm.MaterialType ;  //限制物料 
	    id =  vm.datas.id ;
	   //数据流到审核页 
			$.aAjax({//保存 
				url : ykyUrl.product + "/v1/products/standaudit/"+id ,
				type : 'PUT',
				dataType:"JSON",
				data: JSON.stringify(vm.datas),
				success : function(res) {
					if(res){
						$("#save_btn").addClass('disabled');
						$("#cancel_btn").addClass('disabled');
						 layer.msg("操作成功 ！",{icon:1,offset:120});
						 setTimeout(function(){ 
							 if(from == 'operation'){
								 window.location = ykyUrl._this + '/basicMaterial/materialView.htm';
							 }else if(from == 'manage'){
								 window.location = ykyUrl._this + '/basicMaterial/materialist.htm';
							 }
						 },2000)
					}
				},
				error : function(data) {
					err = data.responseJSON.errCode;
					layer.msg(err,{icon:2,offset:120});
				}
			}) 
	    
	});
  //取消按钮 
  $("#cancel_btn").on("click",function(){
	  if($(this).hasClass('disabled')){
		  return;
	  }
	  if(from == 'operation'){
			 window.location = ykyUrl._this + '/basicMaterial/materialView.htm';
		 }else if(from == 'manage'){
			 window.location = ykyUrl._this + '/basicMaterial/materialist.htm';
		 }
	});
   
   function  cutUrl(url,index){
		var  Link = url;
		
		 if(Link.indexOf("http:")>=0){
			return Link;
		 }else if(Link.indexOf("https:")>=0){
			return Link;
		 }else{
			if(Link.substring(0,2) === "//"){
				return Link;
			}else{
				Link  = "//" + Link;
				return  Link ;
			}
		}
   }
  
});




</script>
</body>
</html>
