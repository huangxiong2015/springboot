/**
 * create by roy.he@yikuyi.com at 2017-7-21
 */


var vm = new Vue({
	el: '#paymentOrderList',
	data: {
		url: ykyUrl.pay+'/v1/accountperiod/paymentdaysList',
		/*url:'http://localhost:27085'+'/v1/accountperiod/paymentdaysList',*/
		queryParams : { //请求接口参数 
			size : 10, //分页参数
			page : 1, //当前页
			defaultStatus : true //监测参数变化标识
		},
		gridColumns : [{
			key : 'partyCode',
			name : 'YKY客户编码',
			default : '-',
			cutstring: true,	
		},{
			key : 'groupName',
			name : '公司名称',
			default : '-',
			cutstring: true
		},{
			key : 'creditQuota',
			name : '账期额度',
			default : '-',
			cutstring: true
		},{
			key : 'realtimeCreditQuota',
			name : '账期余额',
			default : '-',
			cutstring: true
		},{
			key : 'checkDate',
			name : '对账日期',
			default : '-',
			cutstring: true
		},{
			key : 'payDate',
			name : '付款日期',
			default : '-',
			cutstring: true
		},{
			key : 'periodOrderNum',
			name : '账期订单',
			default : '-',
			cutstring: true
		},{
			key : 'accountPeriodStatus',
			name : '账期权限',
			width: '80px',
			text : {
				PERIOD_VERIFIED : {
					'value': '正常'
				},
				PERIOD_DISABLED : {
					'value': '冻结'
				}
			}	
		},{
			key : 'operate',
			align : 'center',
			name : '操作',
			items: [{
				className : 'btn-detail ml5',
				show : true,
				text : '详情',
				href : ykyUrl._this + '/order/term.htm?action=detail&enterpriseId=' + '{partyId}'
			},{
				className : 'btn-detail ml5',
				show : "'{accountPeriodStatus}' === 'PERIOD_VERIFIED'",
				text : '冻结',
				callback: {
					action : 'endTicket',
					params : [ '{partyId}','PERIOD_DISABLED']
				}
			},{
				className : 'btn-detail ml5',
				show : "'{accountPeriodStatus}' === 'PERIOD_DISABLED'",
				text : '取消冻结',
				callback: {
					action : 'operateTicket',
					params : [ '{partyId}','PERIOD_ENABLED']
				}
			}]
		}],
		pageflag : true, //是否显示分页
		refresh : false, //重载 
	},
	methods: {
		search: function(){
		
			if($("#partyCode").val() === ''){
				delete vm.queryParams.partyCode;
			}else{
				vm.queryParams.partyCode = $("#partyCode").val();
			}
			
			if($("#groupName").val() === ''){
				delete vm.queryParams.groupName;
			}else{
				vm.queryParams.groupName = $("#groupName").val();
			}
			
			if($("#accountPeriodStatus select").val() === ''){
				delete vm.queryParams.accountPeriodStatus;
			}else{
				vm.queryParams.accountPeriodStatus = $("#accountPeriodStatus select").val();
			}
						
			vm.queryParams.page = 1;
			vm.queryParams.defaultStatus = !vm.queryParams.defaultStatus
		}
	}
})


function operateTicket(index, params){
	var inputLayer = layer.open({
		type: 1,
	  	//title: "确定结束发放？", //显示标题
		shade: 0.5,
		btn: ['确定', '取消'],
		area: ['510px', '200px'],
		skin:"up_skin_class",
		yes:function(){
			operatePromotion(params[0],params[1],inputLayer);
		},
		cancel: function(){
			
		}
	})
}

function operatePromotion(partyId,status,layerToHandle){
	$.aAjax({
		url: ykyUrl.pay+"/v1/enterprises/frozenCredit/"+partyId+"/"+status,
		type:"PUT",
		dataType: 'JSON',
		contentType:'application/json',
	    success: function(data) {
	    	layer.close(layerToHandle);
	    	if(data.code=='200'){
	    		vm.queryParams.defaultStatus = !vm.queryParams.defaultStatus;
	    	}else{
	    		layer.msg("<i class='icon-right-c'></i>操作失败，请重试 ！", {
	    			  time: 1000,
	    			  area:['506px','140px'],
	    			  skin:"fly_skin_class"      
	    			})
	    	}
	    },
	    error:function(e){
	    	console.log("系统错误，操作失败，请联系系统管理员："+e.responseText);
	    }
	});
	
}

function init(){
	//创建时间
	$('#createDate .input-daterange').datepicker({
	    format: config.dateFormat,
	    autoclose: true
	});
	
	//有效时间
	$('#thruDate .input-daterange').datepicker({
	    format: config.dateFormat,
	    autoclose: true 
	});
}

init();
