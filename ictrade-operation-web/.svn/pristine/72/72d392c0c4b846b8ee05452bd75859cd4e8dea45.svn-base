/**
 * create by roy.he@yikuyi.com at 2017-8-18
 */
var validate;
var vm = new Vue({
	el: '#detailVendor',
	data: {
		tabValue: 'baseData', //baseData,product,credit,sales
		baseDataGone: false,
		productGone: false,
		creditGone: false,
		status: '',
		saveDescribe: '',
		vendorMap: {},
		baseData: {
			deptId: '',
			vendorInfoAttributeMap:{}
		},
		productLines: [],
		creditInfo: {
			creditAttributeMap:{}
		},
		salesInfo: {
			saleAttributeMap:{},
			vendorMovStatus: 'N',
			skuMovStatus: 'N',
			contactPersonInfoList: [],
		},
		auditList: [],
		vendorLogo: '',
		categoryList: [],
		regionList: [],
		companyTypeList: [],
		deptList: [],
		userList: [],
		offerList: [],
		fileName: '',
		showRmb: true,
        showUsd: false,
        supportCurrency: ['RMB'],
        departmentId: '',
        enquiryId: '',
        principalId: '',
        offerId: '',
        saleDepartmentId: '',
        saleEnquiryId: '',
        salePrincipalId: '',
        saleOfferId: '',
        noSales: false,
        noContactInfo: false,
        baseDescribe: '',
        prodctDescribe: '',
        creditDescribe: '',
        salesDescribe: '',
        productFlagNum: 1,
        noEdit: false,
        salesEdit: false,
		stockCode:'',
		productSelectFlag: false,
		editProduct: false,
		productIndex: '',
		multBrand: true,
		productItem: {},
        productItems:[],
        
        focusFieldsname:'关注领域',
        focusFieldsId:'focusFields',
        focusFieldsName:'focusFields',
        focusFieldsOptions: [],
        focusFieldsClass:'form-control vendor-input-s inline',
        focusFieldsPlaceholder:'输入之后按回车键',
        
        productCategorysname:'优势产品类别',
        productCategorysId:'productCategorys',
        productCategorysName:'productCategorys',
        productCategorysOptions: [],
        productCategorysClass:'form-control vendor-input-s inline',
        productCategorysPlaceholder:'输入之后按回车键',
        
        majorClientsname:'主要客户',
        majorClientsId:'majorClients',
        majorClientsName:'majorClients',
        majorClientsOptions: [],
        majorClientsClass:'form-control vendor-input-s inline',
        majorClientsPlaceholder:'输入之后按回车键',
		
		keyname: '选择原厂',
        validate:{
            "required": true
        },
        id:'selbox',
        name:'selbox',
        api:ykyUrl.product +"/v1/products/brands",
        optionName: 'brandName',
        optionId: 'id',
        selected:[],
        multiple:true,   //复选
        placeholder:'搜索原厂',
        
        province : '',
        city : '',
        district : '',
        inputClass : 'l-input',
        styleObject: { width : "180px" },
        category: ykyUrl.product + '/v1/products/categories/children?parentCateId={pid}',
        cateId:'_id',
        cateName:'cateName',
        setProvince:'',
        setCity:'',
        setDistrict:'',
        parentId:'pid',
        queryParam:{
            id:''
        },
        catePlaceholder: {
        	province: '所有大类',
        	city: '所有小类',
        	district: '所有次小类',
        },
        
        partyBankAccount:{
        	accountName:'',//账号名称
        	bankAccount: '',//银行账号
        	bankName: '',// 银行名称 
        	contactNumber: '',//电话 
        	currency: 'CNY',
        	isDefault: 'Y',//是否默认银行,是:Y,否：N ,
        	swiftCode: '',//
        	taxNumber: '',//税号
        	address: '',//地址
        },
        
        contactPersonInfo: {
        	address: '',//地址
        	fixedtel: '',//电话 ,
        	isDefault: 'Y',//是否默认联系人：是:Y,否：N ,
        	lastNameLocal: '',// 联系人名字 ,
        	mail: '',//邮箱
        	occupation:'',// 联系人职位 ,
        	personalTitle: 'ENQUIRY',// 联系人职能 = ['ENQUIRY', 'ORDER', 'NOT_LIMIT'
        	tel: '',//手机   	
        	partyProductLineIdList: [],
        	partyProductLineList: [],
        },
        
        checkboxModel:[],
        checked:'',
        searchData: '',
        checkProductLine: [],
	},
	created: function(){
		var partyId = getQueryString('partyId');
		getRegionList();
		getCategoryList();
		getCompanyType();
		getBaseData(partyId)
		getProductLine(partyId)
		getCreditInfo(partyId);
		getSalesInfo(partyId);
		
		getAuditList(partyId);
		
		if(getQueryString('status') === 'applyNo'){
			this.noSales = true;
		}
		
		if(getQueryString('status') !== 'salesEdit'){
			this.salesEdit = true;
		}else{
			this.noEdit = true;
			this.tabValue = 'sales';
		}
	},
	methods: {
		//选择原厂点击事件
		getBrandSelected: function(e){
			var _this = this;
			if(e.length > 1){
				_this.multBrand = false;
				_this.productItems = [];
				for(var i = 0; i < e.length; i++){
					_this.productItem = {}; //将对象置空
					_this.productItem.brandId = e[i].id.toString();
					_this.productItem.brandName = e[i].brandName;
					_this.productItem.category1Id = '';
					_this.productItem.category1Name = '';
					_this.productItem.category2Id = '';
					_this.productItem.category2Name = '';
					_this.productItem.category3Id = '';
					_this.productItem.category3Name = '';
					_this.productItem.isNew = true;
					_this.productItems.push(_this.productItem);
					_this.productItems = _.uniqBy(_this.productItems, 'brandId')
				}
			}else if(e.length === 1){
				_this.productItems = [];
				_this.multBrand = true;
				_this.productItem = {};
				_this.productItem.isNew = true;
				_this.productItem.brandId = e[0].id.toString();
				_this.productItem.brandName = e[0].brandName;
				_this.productItems.push(_this.productItem);
				_this.productItems = _.uniqBy(_this.productItems, 'brandId')
			}else{
				_this.multBrand = true;
				_this.productItems = [];
				
			}
		},
		// 三级联动onchange赋值
		change : function (data) {//赋值
			var _this = this;
			if(!_this.productItem.brandId){
				_this.$refs.refs.resetSelected();
//				layer.msg('请先选择原厂！')
				return false;
			}
			this.$nextTick(function(){
				_this.productItems = [];
				var obj = vm.$refs.refs.getSelected();
				if(obj.province){//赋值大类
					_this.productItem.category1Id = obj.province._id.toString();
					_this.productItem.category1Name = obj.province.cateName;
				}else{
					_this.productItem.category1Id = '';
					_this.productItem.category1Name = '';
				}
				if(obj.city){//赋值小类
					_this.productItem.category2Id = obj.city._id.toString();
					_this.productItem.category2Name = obj.city.cateName;
				}else{
					_this.productItem.category2Id = '';
					_this.productItem.category2Name = '';
				}
				
				if(obj.district){//赋值次小类
					_this.productItem.category3Id = obj.district._id.toString();
					_this.productItem.category3Name = obj.district.cateName;
				}else{
					_this.productItem.category3Id = '';
					_this.productItem.category3Name = '';
				}
				_this.productItem.isNew = true;
				_this.productItems.push(_this.productItem);
            });
        },
        //保存产品线
        saveProduct: function(){
        	var _this = this;
        	if(_this.editProduct){
        		if(_this.productItems.length > 1){
        			_this.productLines = _.uniqBy(_this.productLines.concat(_this.productItems), 'brandId');
        		}else{
        			_this.productLines[_this.productIndex] = _this.productItem;
        		}
        	}else{
        		for(var i = 0; i< _this.productLines.length; i++){
        			for(var k = 0; k < _this.productItems.length; k++){
        				if(!_this.productItems[k].category1Id){
        					_this.productItems[k].category1Id = '';
        				}
        				if(!_this.productItems[k].category2Id){
        					_this.productItems[k].category2Id = '';
        				}
        				if(!_this.productItems[k].category3Id){
        					_this.productItems[k].category3Id = '';
        				}
        				if(_this.productLines[i].brandId === _this.productItems[k].brandId && _this.productLines[i].category1Id === _this.productItems[k].category1Id && _this.productLines[i].category2Id === _this.productItems[k].category2Id && _this.productLines[i].category3Id === _this.productItems[k].category3Id){
        					_this.productItems.splice(k,1);
        				}
        			}
        		}
        		_this.productLines = _this.productLines.concat(_this.productItems);
        	}
        	
        	_this.productItem = {};
        	_this.productItems = [];
        	_this.productSelectFlag = false;
        	_this.editProduct = false;
        	_this.productIndex = '';
        },
        showProductSelect: function(){
        	var _this = this;
        	_this.editProduct = false;
        	_this.productItem = {};
        	_this.productItems = [];
        	_this.selected = []; 
        	_this.queryParam = {
        			id: ''
        	};
        	_this.setProvince = '';
        	_this.setCity = '';
        	_this.setDistrict = '';
        	_this.multiple = true;
        	_this.productSelectFlag = true;
        },
        //移除选中的原厂
        removeSelected: function(i){
        	var _this = this;
        	if(_this.productItems.length < 2){
        		if(_this.productItems[0].category1Id){
        			_this.$refs.refs.resetSelected();
        		}
        		_this.multBrand = true;
        	}  
        	_this.$refs.letter.del(Number(_this.productItems[i].brandId));
        	_this.productItems.splice(i,1);
        	_this.productItem = {};
        	_this.selected = [];
        	_this.queryParam = {
        			id: ''
        	};
        	for(var j = 0; j < _this.productItems.length; j++){
        		_this.selected.push(Number(_this.productItems[j].brandId))
        	}
        	
        	         	
        },
        //删除单条产品线
        deleteProductItem: function(i){
        	var _this = this;
        	var checkObj = _this.productLines[i],
        	vendorId = getQueryString('partyId'),
        	catId = '';
        	
        	if(checkObj.category3Id && checkObj.category3Id !== ''){
        		catId = checkObj.category3Id;
        	}else if(checkObj.category2Id && checkObj.category2Id !== ''){
        		catId = checkObj.category2Id;
        	}else if(checkObj.category1Id && checkObj.category1Id !== ''){
        		catId = checkObj.category1Id;
        	}
        	
        	if(catId === '' || checkObj.brandSign === 'Y' || checkObj.category1Sign === 'Y' || checkObj.category2Sign === 'Y' || checkObj.category3Sign === 'Y' || checkObj.isNew){
        		layer.open({
	        		title: '提示',
	        		move: false,
	        		area: '500px',
	        		content: '<h2>确定删除该产品线？</h2><p>删除后不可恢复哦!</p>',
	        		btn: ['确定', '取消'],
	        		yes: function(index, layero) {
	        			_this.productLines.splice(i,1);
	        			layer.close(index);
	        		},
	        		cancel: function(index, layero) {
	        		}
	        	})
        	}else{
        		syncData(ykyUrl.product + "/v1/inventory?vendorId="+vendorId+"&cat="+catId, 'GET', null, function(res, err) {
            		if (!err) {
            			if(res && res.productInfo.length > 0){
            				layer.open({
            	        		title: '提示',
            	        		move: false,
            	        		content: '该产品线存在上架商品，请先下架商品后再删除',
            	        		btn: ['知道了']
            	        	})
            			}else{
            				layer.open({
            	        		title: '提示',
            	        		move: false,
            	        		area: '500px',
            	        		content: '<h2>确定删除该产品线？</h2><p>删除后不可恢复哦!</p>',
            	        		btn: ['确定', '取消'],
            	        		yes: function(index, layero) {
            	        			_this.productLines.splice(i,1);
            	        			layer.close(index);
            	        		},
            	        		cancel: function(index, layero) {
            	        		}
            	        	})
            			}
            		}
            	});
        	}
        },
        //编辑单条产品线
        editProductItem: function(i){
        	var _this = this;
        	_this.editProduct = true,
        	_this.productIndex = i;
        	_this.productItems = [];
        	_this.selected = new Array;
        	localStorage.removeItem('productItem')
        	if(!_this.productLines[i].isNew){
        		var checkObj = _this.productLines[i],
            	vendorId = getQueryString('partyId'),
            	catId = '';
            	
            	if(checkObj.category3Id && checkObj.category3Id !== ''){
            		catId = checkObj.category3Id;
            	}else if(checkObj.category2Id && checkObj.category2Id !== ''){
            		catId = checkObj.category2Id;
            	}else if(checkObj.category1Id && checkObj.category1Id !== ''){
            		catId = checkObj.category1Id;
            	}
        		syncData(ykyUrl.product + "/v1/inventory?vendorId="+vendorId+"&cat="+catId, 'GET', null, function(res, err) {
            		if (!err) {
            			if(res && res.productInfo.length > 0){
            				layer.open({
            	        		title: '提示',
            	        		move: false,
            	        		content: '该产品线存在上架商品，请先下架商品后再删除',
            	        		btn: ['知道了']
            	        	})
            	        	return false;
            			}else{
            				localStorage.setItem('productItem', JSON.stringify(_this.productLines[i]));
            	    		_this.productItem = JSON.parse(localStorage.getItem('productItem'));
            	    		_this.productSelectFlag = true;
            	    		_this.queryParam = {};
            	    		_this.multiple = false;
            	    		_this.multBrand = true;
            	    		
            				var selecteds;
            				selecteds = Number(_this.productItem.brandId);
            				_this.selected.push(selecteds);
            	        	_this.setProvince = _this.productItem.category1Id ? _this.productItem.category1Id.toString() : '';
            	        	_this.setCity = _this.productItem.category2Id ? _this.productItem.category2Id.toString(): '';
            	        	_this.setDistrict = _this.productItem.category3Id ? _this.productItem.category3Id.toString(): '';
            	        	_this.$nextTick(function(){
            	        		_this.productItems.push(_this.productItem);
            	        	})
            			}
            		}
            	});
        	}
        },
      //上传产品线
        uploadProductLine: function(){
        	var _this = this;
        	var vendorId = getQueryString('partyId');
        	layer.open({
				type: 1,
				title: '添加产品线',
				area: '700px',
				offset: '300px',
				move: false,
				skin: "s_select_data",
				content: $("#file-upload"),
				btn: ['保存', '取消'],
				yes: function(index, layero) {
					if(vm.fileName === ''){
						layer.msg('请选择文件！')
						return false;
					}
					var index = layer.load(1, {
					  shade: [0.1,'#fff'] //0.1透明度的白色背景
					});
					
					$.aAjax({
						url: ykyUrl.party+'/v1/vendorManage/uploadLine?partyId='+vendorId+'&fileUrl='+vm.fileUrl,
						type: 'POST',
						success: function(res){
							layer.close(index);
							_this.fileName='';
							_this.fileUrl='';
							for(var i = 0; i< _this.productLines.length; i++){
			        			for(var k = 0; k < res.list.length; k++){
			        				if(!res.list[k].category1Id){
			        					res.list[k].category1Id = '';
			        				}
			        				if(!res.list[k].category2Id){
			        					res.list[k].category2Id = '';
			        				}
			        				if(!res.list[k].category3Id){
			        					res.list[k].category3Id = '';
			        				}
			        				if(!res.list[k].brandSign){
			        					res.list[k].brandSign = '';
			        				}
			        				if(!res.list[k].category1Sign){
			        					res.list[k].category1Sign = '';
			        				}
			        				if(!res.list[k].category2Sign){
			        					res.list[k].category2Sign = '';
			        				}
			        				if(!res.list[k].category3Sign){
			        					res.list[k].category3Sign = '';
			        				}
			        				if(_this.productLines[i].brandId === res.list[k].brandId 
			        						&& _this.productLines[i].category1Id === res.list[k].category1Id 
			        						&& _this.productLines[i].category2Id === res.list[k].category2Id 
			        						&& _this.productLines[i].category3Id === res.list[k].category3Id
			        						&& _this.productLines[i].brandSign === res.list[k].brandSign
			        						&& _this.productLines[i].category1Sign === res.list[k].category1Sign
			        						&& _this.productLines[i].category2Sign === res.list[k].category2Sign
			        						&& _this.productLines[i].category3Sign === res.list[k].category3Sign
			        						){
			        					res.list.splice(k,1);
			        				}
			        			}
			        		}
			        		_this.productLines = _this.productLines.concat(res.list);
							layer.closeAll();
						},
						error: function(err){
							layer.close(index);
							var errorTop = layer.open({
								type: 1,
								title: '错误',
								area: ['700px', '300px'],
								offset: '300px',
								move: false,
								skin: "s_select_data",
								content: err.responseJSON.errMsg,
								btn: ['确定'],
								yes: function(index, layero){
									layer.close(errorTop);
								}
							});
						}
					});
				},
				cancel: function(index, layero) {
					vm.fileName='';
					vm.fileUrl='';
				}
			})
        },
        addBankInfo: function(type, i){
        	var _this = this;
        	var bankInfo = {};
        	if(type === 'add'){
        		resetBankinfo();
        	}else{
        		localStorage.removeItem('bankInfo')
        		localStorage.setItem('bankInfo', JSON.stringify(_this.creditInfo.partyBankAccount[i]));
        		_this.partyBankAccount = JSON.parse(localStorage.getItem('bankInfo'));
        		_this.$nextTick(function(){
        			if(_this.partyBankAccount.isDefault === 'Y'){
            			$('.bank_layer input[name="isDefault"]').prop('checked', true);
            		}else{
                		$('.bank_layer input[name="isDefault"]').prop('checked', false);
            		}
        		})
        		
        	}
        	layer.open({
        		type: 1,
        		title: '银行资料',
        		area: '800px',
        		offset: '150px',
        		move: false,
        		skin: "s_select_data",
        		content: $(".bank_layer"),
        		btn: ['保存', '取消'],
        		yes: function(index, layero) {
        			var bankVerifyValid = bankVerify().form();
        			
        			if(!bankVerifyValid){
        				return false;
        			}
        			
        			if($('.bank_layer input[name="isDefault"]').prop('checked')){
        				_this.partyBankAccount.isDefault = 'Y';
        				_this.creditInfo.partyBankAccount.forEach(function(item, i){
        					item.isDefault = 'N';
        				});
        			}else{
        				_this.partyBankAccount.isDefault = 'N';
        			}
        			if(type === 'add'){
        				_this.creditInfo.partyBankAccount.push(_this.partyBankAccount);
        			}else{
        				_this.creditInfo.partyBankAccount[i] = _this.partyBankAccount;
        			}
        			
        			resetBankinfo();
        			layer.close(index);
        		},
        		cancel: function(index, layero) {
        			
        		}
        	})
        },
        //删除银行信息
        deleteBankInfo: function(i){
        	var _this = this;
        	_this.creditInfo.partyBankAccount.splice(i,1);
        },
      //删除附件
        removeAttachment: function(i){
        	var _this = this;
        	_this.creditInfo.creditAttachmentList.splice(i,1);
        	_this.productFlagNum++;
        },
      //新增仓库
        addFacility: function(){
        	var _this= this;
        	if(_this.salesInfo.facilityList.length === 10){
        		layer.msg('最多只能添加10个仓库')
        		return false;
        	}
        	_this.salesInfo.facilityList.push({facilityName:''}); 
        },
      //添加编辑联系人
        addContact: function(type, i){
        	var _this = this;
        	var contactInfo = {};
        	if(type === 'add'){
        		resetContactinfo();
        		_this.$nextTick(function(){
        			if(_this.contactPersonInfo.isDefault === 'Y'){
            			$('.contact_layer input[name="isDefault"]').prop('checked', true);
            		}else{
                		$('.contact_layer input[name="isDefault"]').prop('checked', false);
            		}
        			$('.contact_layer input[value="ENQUIRY"]').prop('checked',true);
    				$('.contact_layer input[value="ORDER"]').prop('checked',false);
        		})
        	}else{
        		localStorage.removeItem('contactInfo');
        		localStorage.setItem('contactInfo', JSON.stringify(_this.salesInfo.contactPersonInfoList[i]));
        		_this.contactPersonInfo = JSON.parse(localStorage.getItem('contactInfo'));
        		_this.contactPersonInfo.partyProductLineList = [];
        		
        		if(_this.contactPersonInfo.partyProductLineIdList){
        			for(var j = 0; j < _this.contactPersonInfo.partyProductLineIdList.length; j++){
        				for(var k = 0; k < _this.salesInfo.partyProductLineList.length; k++){
        					if(_this.contactPersonInfo.partyProductLineIdList[j] === _this.salesInfo.partyProductLineList[k].partyProductLineId){
        						_this.contactPersonInfo.partyProductLineList.push(_this.salesInfo.partyProductLineList[k]);
        					}
        				}
        			}
        		}
        		     		
        		_this.$nextTick(function(){
        			if(_this.contactPersonInfo.isDefault === 'Y'){
            			$('.contact_layer input[name="isDefault"]').prop('checked', true);
            		}else{
                		$('.contact_layer input[name="isDefault"]').prop('checked', false);
            		}
        			
        			if(_this.contactPersonInfo.personalTitle === 'NOT_LIMIT'){
        				$('.contact_layer input[value="ENQUIRY"]').prop('checked',true);
        				$('.contact_layer input[value="ORDER"]').prop('checked',true);
        			}else if(_this.contactPersonInfo.personalTitle === 'ORDER'){
        				$('.contact_layer input[value="ORDER"]').prop('checked',true);
        				$('.contact_layer input[value="ENQUIRY"]').prop('checked',false);
        			}else{
        				$('.contact_layer input[value="ENQUIRY"]').prop('checked',true);
        				$('.contact_layer input[value="ORDER"]').prop('checked',false);
        			}
        		})	
        	}
        	layer.open({
        		type: 1,
        		title: '供应商联系人',
        		area: '800px',
        		offset: '150px',
        		move: false,
        		skin: "s_select_data",
        		content: $(".contact_layer"),
        		btn: ['保存', '取消'],
        		yes: function(index, layero) {
        			var contactVerifyValid = contactVerify().form();
        			
        			if(!contactVerifyValid){
        				return false;
        			}
        			
        			if($('.contact_layer input[name="isDefault"]').prop('checked')){
        				_this.contactPersonInfo.isDefault = 'Y';
        				if(_this.salesInfo.contactPersonInfoList && _this.salesInfo.contactPersonInfoList.length > 0){
        					_this.salesInfo.contactPersonInfoList.forEach(function(item, i){
            					item.isDefault = 'N';
            				});
        				}
        			}else{
        				_this.contactPersonInfo.isDefault = 'N';
        			}
        			if(type === 'add'){
        				_this.salesInfo.contactPersonInfoList.push(_this.contactPersonInfo);
        			}else{
        				_this.salesInfo.contactPersonInfoList[i] = _this.contactPersonInfo;
        			}
        			
        			resetContactinfo();
        			layer.close(index);
        		},
        		cancel: function(index, layero) {
        		}
        	})
        },
        //删除联系人信息
        deleteContactInfo: function(i){
        	var _this = this;
        	_this.salesInfo.contactPersonInfoList.splice(i,1);
        },
        showProductLine: function(){
        	var _this = this;
        	_this.checkboxModel = _this.contactPersonInfo.partyProductLineIdList?_this.contactPersonInfo.partyProductLineIdList:[];
        	layer.open({
        		type: 1,
        		title: '选择产品线',
        		area: '800px',
        		offset: '150px',
        		move: false,
        		skin: "s_select_data",
        		content: $(".productline_layer"),
        		btn: ['保存', '取消'],
        		yes: function(i, layero) {
        			_this.contactPersonInfo.partyProductLineIdList = _this.checkboxModel;
        			_this.contactPersonInfo.partyProductLineList = [];
        			for(var j = 0; j < _this.checkboxModel.length; j++){
        				for(var k = 0; k < _this.salesInfo.partyProductLineList.length; k++){
        					if(_this.checkboxModel[j] === _this.salesInfo.partyProductLineList[k].partyProductLineId){
        						_this.contactPersonInfo.partyProductLineList.push(_this.salesInfo.partyProductLineList[k]);
        					}
        				}
        			}
        			_this.productFlagNum += 1;
        			layer.close(i);
        		},
        		cancel: function(i, layero) {
        		}
        	})
        },
        checkedAll: function(){
        	var _this = this;
            if (this.checked) {//实现反选
              _this.checkboxModel = [];
            }else{//实现全选
              _this.checkboxModel = [];
              _this.productLines.forEach(function(item) {
                _this.checkboxModel.push(item.partyProductLineId);
              });
            }
        },
        saveBaseData: function(){
        	var _this = this;
    		$('#createVendorBase').submit();
        	if(!validate || $("#createVendorBase input.error").length > 0){
        		return false;
        	}
        	_this.baseData.deptId = $("[name='deptId']").val();
        	_this.baseData.deptName = $("[name='deptId'] option:selected").text();
        	_this.baseData.enquiryId = $("[name='enquiryId']").val();
        	_this.baseData.enquiryName = $("[name='enquiryId'] option:selected").text();
        	_this.baseData.principalId = $("[name='principalId']").val();
        	_this.baseData.principalName = $("[name='principalId'] option:selected").text();
        	_this.baseData.offerId = $("[name='offerId']").val();
        	_this.baseData.offerName = $("[name='offerId'] option:selected").text();
        	_this.baseData.categoryName = $("[name='category'] option:selected").text();
        	_this.baseData.regionName = $("[name='region'] option:selected").text();
        	_this.baseData.genreName = $('input[name="genre"]:checked').parent().text();
        	
        	layer.open({
        		type: 1,
        		title: '确认提交',
        		area: '500px',
        		offset: '300px',
        		move: false,
        		skin: "s_select_data",
        		content: $('.basedata-describe'),
        		btn: ['确定', '取消'],
        		yes: function(i, layero) {
        			var postData;
        			postData = _this.baseData;
        			if(!_this.baseDescribe){
        				layer.msg('描述不能为空');
        				return false;
        			}
        			
        			if(_this.baseDescribe.length > 100){
        				layer.msg('描述长度不能超过100个字符');
        				return false;
        			}
        			postData.describe = _this.baseDescribe;
        			postData.partyId = getQueryString('partyId');
        			delete _this.baseData.vendorInfoAttributeMap.VENDOR_CREDIT_PURCHASEDEAL;
        			delete _this.baseData.vendorInfoAttributeMap.VENDOR_CREDIT_PURCHASEDEALDATE;
        			delete _this.baseData.vendorInfoAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOL;
        			delete _this.baseData.vendorInfoAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE;
        			delete _this.baseData.vendorInfoAttributeMap.VENDOR_SALE_INFOVO_FOCUSFIELDS;
        			delete _this.baseData.vendorInfoAttributeMap.VENDOR_SALE_INFOVO_MAJORCLIENTS;
        			delete _this.baseData.vendorInfoAttributeMap.VENDOR_SALE_INFOVO_PRODUCTCATEGORYS;
        			syncData(ykyUrl.party + "/v1/vendorManage/updateVendorInfoVo", 'POST', postData, function(res, err) {
        				if (!err) {
        					layer.msg('基本信息提交成功！')
        					location.href= ykyUrl._this + '/myVendor.htm';
        				}
        			});
        			layer.close(i);
        		},
        		cancel: function(i, layero) {
        		}
        	})
        },
        //保存产品线数据
        saveProductData: function(){
        	var _this = this;
    		
    		var flag = true;
    		for(var i = 0; i < _this.productLines.length; i++){
    			if(_this.productLines[i].brandSign === 'Y'){
    				layer.msg('已上传的产品线有误，请检查');
    				flag =  false;
    				break;
    			}
    		}
    		
    		if(!flag){
    			return false;
    		}
        	
    		layer.open({
        		type: 1,
        		title: '确认提交',
        		area: '500px',
        		offset: '300px',
        		move: false,
        		skin: "s_select_data",
        		content: $('.product-describe'),
        		btn: ['确定', '取消'],
        		yes: function(i, layero) {
        			var postData = {};
        			postData.partyProductLineList = _this.productLines;
        			postData.describe = _this.prodctDescribe;
        			postData.partyId = getQueryString('partyId');
        			if(!_this.prodctDescribe){
        				layer.msg('描述不能为空');
        				return false;
        			}
        			
        			if(_this.prodctDescribe.length > 100){
        				layer.msg('描述长度不能超过100个字符');
        				return false;
        			}
        			syncData(ykyUrl.party + "/v1/vendorManage/updatePartyProductLine", 'POST', postData, function(res, err) {
        				if (!err) {
        					layer.msg('产品线信息提交成功！')
        					location.href= ykyUrl._this + '/myVendor.htm';
        				}
        			});
        			layer.close(i);
        		},
        		cancel: function(i, layero) {
        		}
        	})
        },
        saveCreditData: function(){
        	var _this = this;
        	$('#createVendorCredit').submit();
        	if(!validate || $("#createVendorCredit input.error").length > 0){
        		return false;
        	}
        	if(_this.creditInfo.partyBankAccount.length === 0){
        		layer.msg('请填写银行资料');
        		return false;
        	}
        	
        	layer.open({
        		type: 1,
        		title: '确认提交',
        		area: '500px',
        		offset: '300px',
        		move: false,
        		skin: "s_select_data",
        		content: $('.credit-describe'),
        		btn: ['确定', '取消'],
        		yes: function(i, layero) {
        			var postData;
        			postData = _this.creditInfo;
        			if(!_this.creditDescribe){
        				layer.msg('描述不能为空');
        				return false;
        			}
        			
        			if(_this.creditDescribe.length > 100){
        				layer.msg('描述长度不能超过100个字符');
        				return false;
        			}
        			postData.describe = _this.creditDescribe;
        			postData.partyId = getQueryString('partyId');
        			delete _this.creditInfo.creditAttributeMap.VENDOR_SALE_INFOVO_FOCUSFIELDS;
        			delete _this.creditInfo.creditAttributeMap.VENDOR_SALE_INFOVO_MAJORCLIENTS;
        			delete _this.creditInfo.creditAttributeMap.VENDOR_SALE_INFOVO_PRODUCTCATEGORYS;
        			delete _this.creditInfo.creditAttributeMap.VENDOR_INFO_EMPLOYEENUM;
        			delete _this.creditInfo.creditAttributeMap.VENDOR_INFO_LEGALPERSON;
        			delete _this.creditInfo.creditAttributeMap.VENDOR_INFO_REGPRICE;
        			delete _this.creditInfo.creditAttributeMap.VENDOR_INFO_REGRADDRESS;
        			delete _this.creditInfo.creditAttributeMap.VENDOR_INFO_WEBSITE;
        			syncData(ykyUrl.party + "/v1/vendorManage/updateVendorCreditVo", 'POST', postData, function(res, err) {
        				if (!err) {
        					layer.msg('信用信息提交成功！')
        					location.href= ykyUrl._this + '/vendor.htm';
        				}
        			});
        			layer.close(i);
        		},
        		cancel: function(i, layero) {
        		}
        	})
        },
        saveSalesData: function(){
        	var _this = this;
        	$('#createVendorSales').submit();
        	if(!validate || $("#createVendorSales input.error").length > 0 || $("#createVendorSales textarea.error").length > 0){
        		return false;
        	}
        	if(_this.salesInfo.contactPersonInfoList.length === 0 &&(_this.salesInfo && $('#userId').val() !== _this.salesInfo.offerId)){
        		layer.msg('请填写联系人信息');
        		return false;
        	}
        	
        	_this.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_FOCUSFIELDS = eval('('+$('#focusFields').val()+')').join(',');
        	_this.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_PRODUCTCATEGORYS = eval('('+$('#productCategorys').val()+')').join(',');
        	_this.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_MAJORCLIENTS = eval('('+$('#majorClients').val()+')').join(',');
        	_this.salesInfo.enquiryId = $("[name='saleEnquiryId']").val();
        	_this.salesInfo.enquiryName = $("[name='saleEnquiryId'] option:selected").text();
        	_this.salesInfo.principalId = $("[name='salePrincipalId']").val();
        	_this.salesInfo.principalName = $("[name='salePrincipalId'] option:selected").text();
        	_this.salesInfo.offerId = $("[name='saleOfferId']").val();
        	_this.salesInfo.offerName = $("[name='saleOfferId'] option:selected").text();
        	layer.open({
        		type: 1,
        		title: '确认提交',
        		area: '500px',
        		offset: '300px',
        		move: false,
        		skin: "s_select_data",
        		content: $('.sales-describe'),
        		btn: ['确定', '取消'],
        		yes: function(i, layero) {
        			var postData;
        			postData = _this.salesInfo;
        			if(!_this.salesDescribe){
        				layer.msg('描述不能为空');
        				return false;
        			}
        			
        			if(_this.salesDescribe.length > 100){
        				layer.msg('描述长度不能超过100个字符');
        				return false;
        			}
        			postData.describe = _this.salesDescribe;
        			postData.partyId = getQueryString('partyId');
        			delete _this.salesInfo.saleAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE;
        			delete _this.salesInfo.saleAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOL;
        			delete _this.salesInfo.saleAttributeMap.VENDOR_CREDIT_PURCHASEDEALDATE;
        			delete _this.salesInfo.saleAttributeMap.VENDOR_CREDIT_PURCHASEDEAL;
        			delete _this.salesInfo.saleAttributeMap.VENDOR_INFO_EMPLOYEENUM;
        			delete _this.salesInfo.saleAttributeMap.VENDOR_INFO_LEGALPERSON;
        			delete _this.salesInfo.saleAttributeMap.VENDOR_INFO_REGPRICE;
        			delete _this.salesInfo.saleAttributeMap.VENDOR_INFO_REGRADDRESS;
        			delete _this.salesInfo.saleAttributeMap.VENDOR_INFO_WEBSITE;
        			syncData(ykyUrl.party + "/v1/vendorManage/updateVendorSaleInfoVo", 'POST', postData, function(res, err) {
        				if (!err) {
        					layer.msg('销售信息提交成功！')
        					location.href= ykyUrl._this + '/salesVendor.htm';
        				}
        			});
        			layer.close(i);
        		},
        		cancel: function(i, layero) {
        		}
        	})
        },
        saveCreateBaseData: function(){
        	var _this = this;
    		$('#createVendorBase').submit();
        	if(!validate || $("#createVendorBase input.error").length > 0){
        		return false;
        	}
        	if(vm.baseData.listed === 'Y'){
        		vm.baseData.stockCode = vm.stockCode;
        	}
        	
        	_this.baseData.deptId = $("[name='deptId']").val();
        	_this.baseData.deptName = $("[name='deptId'] option:selected").text();
        	_this.baseData.enquiryId = $("[name='enquiryId']").val();
        	_this.baseData.enquiryName = $("[name='enquiryId'] option:selected").text();
        	_this.baseData.principalId = $("[name='principalId']").val();
        	_this.baseData.principalName = $("[name='principalId'] option:selected").text();
        	_this.baseData.offerId = $("[name='offerId']").val();
        	_this.baseData.offerName = $("[name='offerId'] option:selected").text();
        	_this.baseData.categoryName = $("[name='category'] option:selected").text();
        	_this.baseData.regionName = $("[name='region'] option:selected").text();
        	_this.baseData.genreName = $('input[name="genre"]:checked').parent().text();
        	
        	_this.tabValue = 'product';
        },
        saveCreateProductData: function(){
        	var _this = this;
    		var flag = true;
    		for(var i = 0; i < _this.productLines.length; i++){
    			if(_this.productLines[i].brandSign === 'Y' || _this.productLines[i].category1Sign === 'Y' || _this.productLines[i].category2Sign === 'Y' || _this.productLines[i].category3Sign === 'Y'){
    				layer.msg('已上传的产品线有误，请检查');
    				flag = false;
    				break;
    			}
    		}
    		if(!flag){
    			return false;
    		}
        	_this.tabValue = 'credit';
        },
        //保存数据
        saveData: function(){
        	var _this = this;
        	$('#createVendorCredit').submit();
        	if(!validate || $("#createVendorCredit input.error").length > 0){
        		return false;
        	}
        	if(_this.creditInfo.partyBankAccount.length === 0){
        		layer.msg('请填写银行资料');
        		return false;
        	}
        	
        	_this.vendorMap.VENDOR_INFO_WEBSITE = _this.baseData.vendorInfoAttributeMap.VENDOR_INFO_WEBSITE;
        	_this.vendorMap.VENDOR_INFO_REGRADDRESS = _this.baseData.vendorInfoAttributeMap.VENDOR_INFO_REGRADDRESS;
        	_this.vendorMap.VENDOR_INFO_LEGALPERSON = _this.baseData.vendorInfoAttributeMap.VENDOR_INFO_LEGALPERSON;
        	_this.vendorMap.VENDOR_INFO_REGPRICE = _this.baseData.vendorInfoAttributeMap.VENDOR_INFO_REGPRICE;
        	_this.vendorMap.VENDOR_INFO_EMPLOYEENUM = _this.baseData.vendorInfoAttributeMap.VENDOR_INFO_EMPLOYEENUM;
        	_this.vendorMap.VENDOR_CREDIT_PURCHASEDEAL = _this.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEAL;
        	_this.vendorMap.VENDOR_CREDIT_PURCHASEDEALDATE = _this.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEALDATE;
        	_this.vendorMap.VENDOR_CREDIT_SECRECYPROTOCOL = _this.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOL;
        	_this.vendorMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE = _this.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE;
        	
        	var vendorObj = {
        			partyId: getQueryString('partyId'),
        			partyProductLineList: _this.productLines,
        			vendorCreditVo : _this.creditInfo,
        			vendorInfoVo : _this.baseData,
        			map: _this.vendorMap
        	};
        	
        	layer.open({
        		type: 1,
        		title: '确认提交',
        		area: '500px',
        		offset: '300px',
        		move: false,
        		skin: "s_select_data",
        		content: $('.save-describe'),
        		btn: ['确定', '取消'],
        		yes: function(i, layero) {
        			if(!_this.saveDescribe){
        				layer.msg('描述不能为空');
        				return false;
        			}
        			
        			if(_this.saveDescribe.length > 100){
        				layer.msg('描述长度不能超过100个字符');
        				return false;
        			}
        			vendorObj.describe = _this.saveDescribe;
        			syncData(ykyUrl.party + "/v1/vendorManage/addVendor", 'POST', vendorObj, function(res, err) {
                		if (!err) {
                			location.href = ykyUrl._this+'/vendor.htm';
                		}
                	});
        			layer.close(i);
        		},
        		cancel: function(i, layero) {
        		}
        	})
        },
	},
	watch: {
		'departmentId': function(newVal,oldVal){
			if(!newVal){
				vm.departmentId = oldVal;
				return false;	
			}
			getUserList(newVal);
			if(this.offerList.length  === 0){
				getOfferList(operateDeptId)
			}
			
		},
		'saleDepartmentId': function(newVal,oldVal){
			if(!newVal){
				vm.saleDepartmentId = oldVal;
				return false;	
			}
			getSalesUserList(newVal);
			if(this.offerList.length  === 0){
				getSalesOfferList(operateDeptId)
			}
		},
		'supportCurrency': function(newVal){
			for(var i = 0; i < newVal.length; i++){
				if(newVal[i] === 'RMB'){
					$('input[value="RMB"]').prop('checked',true);
					vm.showRmb = true;
				}
				if(newVal[i] === 'USD'){
					$('input[value="USD"]').prop('checked',true);
					vm.showUsd = true;
				}
			}
		},
		'checkboxModel': {
		    handler: function (val, oldVal) { 
		      if (this.checkboxModel.length === this.productLines.length) {
		        this.checked=true;
		      }else{
		        this.checked=false;
		      }
		    },
		    deep: true
		  }
	}
})

function getBaseData(id){
	syncData(ykyUrl.party + "/v1/vendors/vendorInfo/"+id, 'GET', null, function(res, err) {
		if (!err) {
			Vue.nextTick(function(){
				vm.baseData = res;
				var userId = $('#userId').val();
				if(res){
					if((res.enquiryId && res.enquiryId === userId) || (res.principalId && res.principalId === userId)){
						vm.noEdit = true;
					}
					if(!vm.baseData.vendorInfoAttributeMap){
						vm.baseData.vendorInfoAttributeMap = {}
					}
					
					if(!vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_WEBSITE){
						vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_WEBSITE = ''
					}
					if(!vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_LEGALPERSON){
						vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_LEGALPERSON = ''
					}
					if(!vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_REGPRICE){
						vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_REGPRICE = ''
					}
					if(!vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_REGRADDRESS){
						vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_REGRADDRESS = ''
					}
					if(!vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_EMPLOYEENUM){
						vm.baseData.vendorInfoAttributeMap.VENDOR_INFO_EMPLOYEENUM = ''
					}
					if(!vm.baseData.category){
						vm.baseData.category = '100001'
					}
					if(!vm.baseData.region){
						vm.baseData.region = '100100'
					}
					if(!vm.baseData.generalHeadquarters){
						vm.baseData.generalHeadquarters = ''
					}
					if(!vm.baseData.genre){
						vm.baseData.genre = '100200'
					}
					if(!vm.baseData.enquiryId){
						vm.baseData.enquiryId = ''
					}
					if(!vm.baseData.principalId){
						vm.baseData.principalId = ''
					}
					if(!vm.baseData.deptId){
						vm.baseData.deptId = ''
					}
					if(!vm.baseData.offerId){
						vm.baseData.offerId = '';
					}
				}
				getDeptList();
				if(!vm.baseData.offerId || !vm.baseData.enquiryId){
					getOfferList(operateDeptId)
				}
				getPrivateUrl(vm.baseData.logoImageUrl);
			})
			
		}
	});
}

function getProductLine(id){
	syncData(ykyUrl.party + "/v1/vendors/productLine/"+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.productLines = res;
		}
	});
}

function getCreditInfo(id){
	syncData(ykyUrl.party + "/v1/vendors/vendorCredit/"+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.creditInfo = res;
			
			if(res){	
				if(!vm.creditInfo.creditAttributeMap){
					vm.creditInfo.creditAttributeMap = {};
				}
				if(!vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEAL){
					vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEAL = 'NOT_SIGN';
				}
				if(!vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEALDATE){
					vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEALDATE = '';
				}
				if(!vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOL){
					vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOL = 'NOT_SIGN';
				}
				if(!vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE){
					vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE = '';
				}
				if(!vm.creditInfo.checkDate){
					vm.creditInfo.checkDate = '';
				}
				if(!vm.creditInfo.creditDeadline){
					vm.creditInfo.creditDeadline = '';
				}
				if(!vm.creditInfo.creditQuota){
					vm.creditInfo.creditQuota = '';
				}
				if(!vm.creditInfo.currency){
					vm.creditInfo.currency = 'CNY';
				}
				if(!vm.creditInfo.partyBankAccount){
					vm.creditInfo.partyBankAccount = [];
				}
				if(!vm.creditInfo.payDate){
					vm.creditInfo.payDate = '';
				}
				if(!vm.creditInfo.paymentTerms){
					vm.creditInfo.paymentTerms = '';
				}
				if(!vm.creditInfo.creditAttachmentList){
					vm.creditInfo.creditAttachmentList = [];
				}
			}
		}
	});
}

function getSalesInfo(id){
	syncData(ykyUrl.party + "/v1/vendors/vendorSaleInfo/"+id, 'GET', null, function(res, err) {
		if (!err) {
			if(res.offerId && res.offerId === $('#userId').val() && res.enquiryId !== $('#userId').val() && res.principalId !== $('#userId').val()){
				vm.noContactInfo = true;
			}
			if(getQueryString('status') !== 'salesEdit' && !res.orderVerify){
				vm.noSales = true;
			}
			vm.salesInfo = res;
			
			if(res){
				if(!vm.salesInfo.saleAttributeMap){
					vm.salesInfo.saleAttributeMap = {};
				}
				if(!vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_FOCUSFIELDS){
					vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_FOCUSFIELDS = '';
				}
				if(!vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_MAJORCLIENTS){
					vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_MAJORCLIENTS = '';
				}
				if(!vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_PRODUCTCATEGORYS){
					vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_PRODUCTCATEGORYS = '';
				}
				if(!vm.salesInfo.saleAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE){
					vm.salesInfo.saleAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE = '';
				}
				if(!vm.salesInfo.contactPersonInfoList){
					vm.salesInfo.contactPersonInfoList = [];
				}
				if(!vm.salesInfo.description){
					vm.salesInfo.description = '';
				}
				if(!vm.salesInfo.isShowName){
					vm.salesInfo.isShowName = 'Y';
				}
				if(!vm.salesInfo.lastPayDate){
					vm.salesInfo.lastPayDate = '';
				}
				if(!vm.salesInfo.lastPaymPrice){
					vm.salesInfo.lastPaymPrice = '';
				}
				if(!vm.salesInfo.lastTransactionDate){
					vm.salesInfo.lastTransactionDate = '';
				}
				if(!vm.salesInfo.lastTransactionPrice){
					vm.salesInfo.lastTransactionPrice = '';
				}
				if(!vm.salesInfo.minOrderPriceCNY){
					vm.salesInfo.minOrderPriceCNY = '';
				}
				if(!vm.salesInfo.minOrderPriceUSD){
					vm.salesInfo.minOrderPriceUSD = '';
				}
				if(!vm.salesInfo.orderVerify){
					vm.salesInfo.orderVerify = 'N';
				}
				if(!vm.salesInfo.supportCurrency){
					vm.salesInfo.supportCurrency = '';
				}
				if(!vm.salesInfo.facilityList){
					vm.salesInfo.facilityList = [{facilityName:''}];
				}
				if(!vm.salesInfo.skuMovStatus){
					vm.salesInfo.skuMovStatus = 'N';
				}
				if(!vm.salesInfo.vendorMovStatus){
					vm.salesInfo.vendorMovStatus = 'N';
				}
				if(!vm.salesInfo.offerId){
					vm.salesInfo.offerId = '';
				}
				if(!vm.salesInfo.enquiryId){
					vm.salesInfo.enquiryId = '';
				}
			}
			vm.majorClientsOptions= vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_MAJORCLIENTS.split(',');
			vm.focusFieldsOptions= vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_FOCUSFIELDS.split(',');
			vm.productCategorysOptions= vm.salesInfo.saleAttributeMap.VENDOR_SALE_INFOVO_PRODUCTCATEGORYS.split(',');
			vm.supportCurrency = vm.salesInfo.supportCurrency.split(',');
			if(res){	
				for(var i = 0; i<vm.salesInfo.contactPersonInfoList.length; i++){
					if(vm.salesInfo.contactPersonInfoList[i].partyProductLineIdList){
						vm.salesInfo.contactPersonInfoList[i].partyProductLineList = [];
						for(var j = 0; j < vm.salesInfo.contactPersonInfoList[i].partyProductLineIdList.length; j++){
	        				for(var k = 0; k < vm.salesInfo.partyProductLineList.length; k++){
	        					if(vm.salesInfo.contactPersonInfoList[i].partyProductLineIdList[j] === vm.salesInfo.partyProductLineList[k].partyProductLineId){
	        						vm.salesInfo.contactPersonInfoList[i].partyProductLineList.push(vm.salesInfo.partyProductLineList[k]);
	        					}
	        				}
	        			}
					}    					        		
				}
				if(vm.salesInfo.skuMovStatus === 'Y'){
					$('input[name="skuMovStatus"]').prop('checked',true);
				}
				if(vm.salesInfo.vendorMovStatus === 'Y'){
					$('input[name="vendorMovStatus"]').prop('checked',true);
				}
			}
			if(!vm.salesInfo.offerId || !vm.salesInfo.enquiryId){
				getSalesOfferList(operateDeptId)
			}
		}
	});
}

function getAuditList(id){
	syncData(ykyUrl.party + "/v1/audit?actionRst=SUCCEEDED&size=1000&actionId="+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.auditList = res.list;
		}
	});
}

//获取图片地址
var getPrivateUrl =  function(url){
	$.aAjax({
		url: ykyUrl.party + "/v1/enterprises/getImgUrl",
     	type:"POST",
     	data:JSON.stringify({"id":url}),
     	success: function(data) {
     		if(null !=data || data == ""){
     			vm.vendorLogo = data;
     		}
     	},
     	error:function(e){
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
 	});
}


//获取所属分类数据
function getCategoryList(){
	syncData(ykyUrl.database + "/v1/category/companylist?categoryTypeId=VENDOR_THE_TYPE", 'GET', null, function(res, err) {
		if (!err) {
			vm.categoryList = res;
		}
	});
}

//获取所属地区数据
function getRegionList(){
	syncData(ykyUrl.database + "/v1/category/companylist?categoryTypeId=VENDOR_THE_REGION", 'GET', null, function(res, err) {
		if (!err) {
			vm.regionList = res;
		}
	});
}

//获取公司类型数据
function getCompanyType(){
	syncData(ykyUrl.database + "/v1/category/companylist?categoryTypeId=VENDOR_COMPANY_TYPE", 'GET', null, function(res, err) {
		if (!err) {
			vm.companyTypeList = res;
		}
	});
}

//获取分管部门数据
function getDeptList(){
	syncData(ykyUrl.party + "/v1/dept/sonlist?parentId=99999999", 'GET', null, function(res, err) {
		if (!err) {
			vm.deptList = res;
			vm.departmentId = vm.baseData.deptId;
			vm.saleDepartmentId = vm.baseData.deptId;
		}
	});
}

//获取负责人、询价员数据
function getUserList(id){
	syncData(ykyUrl.party + "/v1/dept/findCustomerByDeptId?page=1&size=100&deptId="+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.userList = res.list;
			if(res && res.list.length > 0){
				if(!vm.baseData.principalId){
					vm.principalId = vm.userList[0].partyId;
				}else{
					vm.principalId = vm.baseData.principalId
				}
			}
		}
	});
}

//获取负责人数据
function getSalesUserList(id){
	syncData(ykyUrl.party + "/v1/dept/findCustomerByDeptId?page=1&size=100&deptId="+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.userList = res.list;
			if(res && res.list.length > 0){
				if(!vm.salesInfo.principalId){
					vm.salePrincipalId = vm.userList[0].partyId;
				}else{
					vm.salePrincipalId = vm.salesInfo.principalId
				}
			}
		}
	});
}
//获取运营部下所有人
function getOfferList(id){
	syncData(ykyUrl.party + "/v1/dept/findCustomerByDeptId?page=1&size=100&deptId="+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.offerList = res.list;
			if(vm.offerList && vm.offerList.length > 0){
				if(!vm.baseData.enquiryId){
					vm.enquiryId = vm.offerList[0].partyId;
				}else{
					vm.enquiryId = vm.baseData.enquiryId
				}
				if(!vm.baseData.offerId){
					vm.offerId = vm.offerList[0].partyId;
				}else{
					vm.offerId = vm.baseData.offerId
				}
			}
		}
	});
}

//获取运营部下所有人
function getSalesOfferList(id){
	syncData(ykyUrl.party + "/v1/dept/findCustomerByDeptId?page=1&size=100&deptId="+id, 'GET', null, function(res, err) {
		if (!err) {
			vm.offerList = res.list;
			if(vm.offerList && vm.offerList.length > 0){
				if(!vm.salesInfo.enquiryId){
					vm.saleEnquiryId = vm.offerList[0].partyId;
				}else{
					vm.saleEnquiryId = vm.salesInfo.enquiryId
				}
				if(!vm.salesInfo.offerId){
					vm.saleOfferId = vm.offerList[0].partyId;
				}else{
					vm.saleOfferId = vm.salesInfo.offerId
				}
			}
		}
	});
}
//重置银行信息数据
function resetBankinfo(){
	var _this = vm;
	_this.partyBankAccount = {
		accountName:"",
		address:"",
		bankAccount:"",
		bankName:"",
		contactNumber:"",
		currency:"CNY",
		isDefault:"Y",
		swiftCode:"",
		taxNumber:"",
	}
}
//重置联系信息数据
function resetContactinfo(){
	var _this = vm;
	_this.contactPersonInfo = {
		address: '',//地址
    	fixedtel: '',//电话 ,
    	isDefault: 'Y',//是否默认联系人：是:Y,否：N ,
    	lastNameLocal: '',// 联系人名字 ,
    	mail: '',//邮箱
    	occupation:'',// 联系人职位 ,
    	personalTitle: 'ENQUIRY',// 联系人职能 = ['ENQUIRY', 'ORDER', 'NOT_LIMIT'
    	tel: '',//手机   	
	}
}

//校验银行信息
var bankVerify = function(){
	return $("#bankLayer").validate({
		rules: {
			accountName: {
				required: true,
			},
			bankName: {
				required: true,
			},
			bankAccount: {
				required: true,
				noCn: [''],
			},
			taxNumber: {
				required: true,
				noCn: [''],
			},
			address: {
				required: true,
			},
			contactNumber: {
				required: true,
			},
			swiftCode: {
				required: true,
			}
		},
		messages: {
			accountName: {
				required: '账户名称不能为空',
			},
			bankName: {
				required: '开户银行不能为空',
			},
			bankAccount: {
				required: '银行账号不能为空',
			},
			taxNumber: {
				required: '税号不能为空',
			},
			address: {
				required: '地址不能为空',
			},
			contactNumber: {
				required: '电话不能为空',
			},
			swiftCode: {
				required: 'SWIFT CODE不能为空',
			}
		},
		errorElement: "em",
		success: function(label) {
			$(label).parent().find('.tip').remove();
			$(label).removeClass("error icon-triangle-leftmin"); // speech-bubble speech-bubble-left

			$(label).addClass("icon-confirm");
			if ($(label).parent().find('input').val() === '') {
				$(label).removeClass("icon-confirm");
			}
		},
		errorPlacement: function(error, element) {
			var f = error[0].getAttribute("for");
			var ele = $("em[for=" + f + "]");
			if (ele.length > 0) {
				ele[0].remove();
			}
			element.parent().find('.tip').remove();
			error.appendTo(element.parent());
			$(error).addClass("error icon-triangle-leftmin");
		},
		submitHandler: function(form) { // 表单提交时修改校验状态
			validate = true;
		}
	});
	/* 插件验证end */
}
//校验联系人信息
var contactVerify = function(){
	return $("#contactLayer").validate({
		rules: {
			lastNameLocal: {
				required: true,
			},
			occupation: {
				required: true,
			},
			mail: {
				required: true,
				isMail: [''],
			},
			address: {
				required: true,
			},
			
		},
		messages: {
			lastNameLocal: {
				required: '联系人不能为空',
			},
			occupation: {
				required: '联系人职位不能为空',
			},
			mail: {
				required: '邮箱不能为空',
			},
			address: {
				required: '联系人地址不能为空',
			},
		},
		errorElement: "em",
		success: function(label) {
			$(label).parent().find('.tip').remove();
			$(label).removeClass("error icon-triangle-leftmin"); // speech-bubble speech-bubble-left

			$(label).addClass("icon-confirm");
			if ($(label).parent().find('input').val() === '') {
				$(label).removeClass("icon-confirm");
			}
		},
		errorPlacement: function(error, element) {
			var f = error[0].getAttribute("for");
			var ele = $("em[for=" + f + "]");
			if (ele.length > 0) {
				ele[0].remove();
			}
			element.parent().find('.tip').remove();
			error.appendTo(element.parent());
			$(error).addClass("error icon-triangle-leftmin");
		},
		submitHandler: function(form) { // 表单提交时修改校验状态
			validate = true;
		}
	});
	/* 插件验证end */
}

/**
 * 基本信息表单校验
 */
$("#createVendorBase").validate({
	rules: {
		groupNameFull: {
			required: true,
		},
		groupName: {
			required: true,
			vendorShotNameCheck: [''],
		},
		partyCode: {
			required: true,
			noCn: [''],
		},
		category: {
			required: true,
		},
		website: {
			noCn: [''],
		},
		principalId: {
			required: true,
		},
		enquiryId: {
			required: true,
		},
		offerId: {
			required: true,
		},
		legalPerson: {
			noNumber: ['']
		},
		stockCode: {
			required: true,
			noCn: [''],
		}
	},
	messages: {
		groupNameFull: {
			required: '供应商全称不能为空',
		},
		groupName: {
			required: '供应商简称不能为空',
		},
		partyCode: {
			required: '供应商编码不能为空',
		},
		category:{
			required: '所属分类不能为空',
		},
		principalId: {
			required: '负责人不能为空',
		},
		enquiryId: {
			required: '询价员不能为空',
		},
		enquiryId: {
			required: '报价员不能为空',
		},
		stockCode: {
			required: '股票代码不能为空',
		}
		
	},
	errorElement: "em",
	success: function(label) {
		$(label).parent().find('.tip').remove();
		$(label).removeClass("error icon-triangle-leftmin"); // speech-bubble speech-bubble-left

		$(label).addClass("icon-confirm");
		if ($(label).parent().find('input').val() === '') {
			$(label).removeClass("icon-confirm");
		}
	},
	errorPlacement: function(error, element) {
		var f = error[0].getAttribute("for");
		var ele = $("em[for=" + f + "]");
		if (ele.length > 0) {
			ele[0].remove();
		}
		element.parent().find('.tip').remove();
		error.appendTo(element.parent());
		$(error).addClass("error icon-triangle-leftmin");
	},
	submitHandler: function(form) { // 表单提交时修改校验状态
		validate = true;
	}
});

/**
 * 信用表单校验
 */
$("#createVendorCredit").validate({
	rules: {
		creditQuota: {
			number: true,
			min: 0,
			floatTwo: ['']
		},
		creditDeadline: {
			noZero: [''],
		},
		checkDate: {
			noZero: [''],
		},
		payDate: {
			noZero: [''],
		},
	},
	messages: {
		creditQuota: {
			number: '请输入不小于0数字',
			min: '请输入不小于0数字',
		}
	},
	errorElement: "em",
	success: function(label) {
		$(label).parent().find('.tip').remove();
		$(label).removeClass("error icon-triangle-leftmin"); // speech-bubble speech-bubble-left

		$(label).addClass("icon-confirm");
		if ($(label).parent().find('input').val() === '') {
			$(label).removeClass("icon-confirm");
		}
	},
	errorPlacement: function(error, element) {
		var f = error[0].getAttribute("for");
		var ele = $("em[for=" + f + "]");
		if (ele.length > 0) {
			ele[0].remove();
		}
		element.parent().find('.tip').remove();
		error.appendTo(element.parent());
		$(error).addClass("error icon-triangle-leftmin");
	},
	submitHandler: function(form) { // 表单提交时修改校验状态
		validate = true;
	}
});

/**
 * 销售信息表单校验
 */
$("#createVendorSales").validate({
	rules: {
		minOrderPriceCNY: {
			number: true,
			floatTwo: [''],
			floatZero: [''],
		},
		minOrderPriceUSD: {
			number: true,
			floatTwo: [''],
			floatZero: [''],
		},
		description: {
			maxlength: 100,
		}
	},
	messages: {
		minOrderPriceCNY: {
			number: '请输入不小于0数字',
			min: '请输入不小于0数字',
		},
		minOrderPriceUSD: {
			number: '请输入不小于0数字',
			min: '请输入不小于0数字',
		},
		description: {
			maxlength: '装运条款最多只能输入100个字符'
		}
	},
	errorElement: "em",
	success: function(label) {
		$(label).parent().find('.tip').remove();
		$(label).removeClass("error icon-triangle-leftmin"); // speech-bubble speech-bubble-left

		$(label).addClass("icon-confirm");
		if ($(label).parent().find('input').val() === '') {
			$(label).removeClass("icon-confirm");
		}
	},
	errorPlacement: function(error, element) {
		var f = error[0].getAttribute("for");
		var ele = $("em[for=" + f + "]");
		if (ele.length > 0) {
			ele[0].remove();
		}
		element.parent().find('.tip').remove();
		error.appendTo(element.parent());
		$(error).addClass("error icon-triangle-leftmin");
	},
	submitHandler: function(form) { // 表单提交时修改校验状态
		validate = true;
	}
});



//供应商logo上传
var uploaderLogo = createUploader({
	buttonId: "upload-logo", 
	uploadType: "vendor.logo", //上传后文件存放路径
	url:  ykyUrl.webres,
	types: "png,bmp,jpeg,jpg",//可允许上传文件的类型
	fileSize: "10mb", //最多允许上传文件的大小
	isImage: true, //是否是图片
	init:{
		FileUploaded : function(up, file, info) { 
         layer.close(index);
			if (info.status == 200 || info.status == 203) {
				vm.vendorLogo = signatureData.image;
				vm.baseData.logoImageUrl = _fileUrl;
			} else {
				layer.msg("上传文件失败,请重新上传！",{icon:2,offset:120}); 
			}
			up.files=[];
		}
	}
}); 
uploaderLogo.init();

//上传产品线文件
var uploaderProduct = createUploader({
	buttonId: "uploadProductFile", 
	uploadType: "vendor.product", //上传后文件存放路径
	url:  ykyUrl.webres,
	types: "xls,xlsx,csv",//可允许上传文件的类型
	fileSize: "5mb", //最多允许上传文件的大小
	isImage: false, //是否是图片
	init:{
		FileUploaded : function(up, file, info) { 
         layer.close(index);
			if (info.status == 200 || info.status == 203) {
				vm.fileName = file.name;
				vm.fileUrl = _fileUrl;
			} else {
				layer.msg("上传文件失败,请重新上传！",{icon:2,offset:120}); 
			}
			up.files=[];
		}
	}
}); 
uploaderProduct.init(); 


//上传协议
var uploaderDeal = createUploader({
	buttonId: "upload-deal", 
	uploadType: "vendor.accessories", //上传后文件存放路径
	url:  ykyUrl.webres,
	types: "xls,xlsx,csv,pdf,zip,rar",//可允许上传文件的类型
	fileSize: "10mb", //最多允许上传文件的大小
	isImage: false, //是否是图片
	multi_selection: true,
	init:{
		FileUploaded : function(up, file, info) { 
         layer.close(index);
			if (info.status == 200 || info.status == 203) {
				if(!vm.creditInfo.creditAttachmentList){
					vm.creditInfo.creditAttachmentList = [];
				}
				var files = {
					attachmentName: file.name,
					attachmentUrl: _fileUrl,
				}
				vm.creditInfo.creditAttachmentList.push(files);
				vm.productFlagNum++;
				
			} else {
				layer.msg("上传文件失败,请重新上传！",{icon:2,offset:120}); 
			}
			up.files=[];
		}
	}
}); 
uploaderDeal.init(); 


$(function(){
	vm.status = getQueryString('status');
	
	//初始化支持币种选择
	for(var i = 0; i < vm.supportCurrency.length; i++){
		if(vm.supportCurrency[i] === 'RMB'){
			$('input[value="RMB"]').prop('checked',true);
		}
		if(vm.supportCurrency[i] === 'USD'){
			$('input[value="USD"]').prop('checked',true);
		}
	}
	
	
	$('input[name="skuMovStatus"]').click(function(){
		if($(this).prop('checked')){
			vm.salesInfo.skuMovStatus = 'Y';
		}else{
			vm.salesInfo.skuMovStatus = 'N';
		}
	})
	
	
	$('input[name="vendorMovStatus"]').click(function(){
		if($(this).prop('checked')){
			vm.salesInfo.vendorMovStatus = 'Y';
		}else{
			vm.salesInfo.vendorMovStatus = 'N';
		}
	})
	
	if(vm.contactPersonInfo.personalTitle === 'ORDER'){
		$('input[value="ORDER"]').prop('checked',true);
	}
	if(vm.contactPersonInfo.personalTitle === 'ENQUIRY'){
		$('input[value="ENQUIRY"]').prop('checked',true);
	}
	
	currencyChecked($('input[name="currencyRmb"]'), $('input[name="currencyUsd"]'), 'RMB');
	currencyChecked($('input[name="currencyUsd"]'), $('input[name="currencyRmb"]'), 'USD');
	personalTitleChecked($('input[name="enquiry"]'),$('input[name="order"]'));
	personalTitleChecked($('input[name="order"]'),$('input[name="enquiry"]'));
	
	$('#secrecyTime .input-daterange,#dealTime .input-daterange').datepicker({
	    format: config.dateFormat,
	    autoclose: true
	}).on('changeDate', function(ev){
		vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_PURCHASEDEALDATE = $('input[name="purchaseDealDate"]').val();
		vm.creditInfo.creditAttributeMap.VENDOR_CREDIT_SECRECYPROTOCOLDATE= $('input[name="secrecyProtocolDate"]').val();
	});
	
});

function currencyChecked(dom, dom1, currency){
	dom.click(function(){
		if($(this).prop('checked')){
			if(dom1.prop('checked')){
				$(this).prop('checked', true);
				vm.supportCurrency.push(currency);
				if(currency === 'RMB'){
					vm.showRmb = true;
				}
				if(currency === 'USD'){
					vm.showUsd = true;
				}
			}else{
				return false;
			}
		}else{
			if(dom1.prop('checked')){
				$(this).prop('checked', false);
				vm.supportCurrency = _.pullAllWith(vm.supportCurrency, [currency], _.isEqual);
				if(currency === 'RMB'){
					vm.showRmb = false;
				}
				if(currency === 'USD'){
					vm.showUsd = false;
				}
			}else{
				return false;
			}
		}
	})
}

function personalTitleChecked(dom, dom1, title){
	dom.click(function(){
		if($(this).prop('checked')){
			if(dom1.prop('checked')){
				$(this).prop('checked', true);
				vm.contactPersonInfo.personalTitle = 'NOT_LIMIT';
			}else{
				vm.contactPersonInfo.personalTitle = dom1.val();
				return false;
			}
		}else{
			if(dom1.prop('checked')){
				$(this).prop('checked', false);
				vm.contactPersonInfo.personalTitle = dom1.val();
			}else{
				vm.contactPersonInfo.personalTitle = $(this).val();
				return false;
			}
		}
	})
}
