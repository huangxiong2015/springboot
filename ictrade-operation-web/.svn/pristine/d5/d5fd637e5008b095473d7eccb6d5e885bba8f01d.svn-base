var vm = new Vue({
	el: '#editCoupon',
	data: {
		initData: '',
		id: '',
		action: '',
		logList: '',
		logListNull: false,
		specified: false,
		profImg: '',
		original: '',
		approvedProof: '',
		specified: true,
		vendorList: [],
		brandList: [],
		categoryList: [],
		useLimitPerCustomer: '',
		useProductType: 1,
		businessType: 'PERSON_REG',
		couponProductList: [],
		approvedProofShow: '',
		fileName: '',
		fileUrl: '',
		vendorModel: [],
		vendorNames: [],
		vendorIds: '',
		vendorNameString: '',
		vendorToggle: false,
		brandModel: [],
		brandNames: [],
		brandIds: '',
		brandNameString: '',
		brandToggle: false,
		categoryModel: [],
		cateNames: [],
		categoryIds: '',
		categoryNameString: '',
		categoryToggle: false,
		activityUrl: '',
	},
	methods: {
		showBigImg: function(){
			if(vm.profImg !=''){
				layer.open({
					  type: 1,
					  title: false,
					  closeBtn: 0,
					  area: ['800px', '500px'],
					  offset: '100px',
					  shadeClose: true,
					  content: $('.originalImage')
				});
			}
		},
		saveData: function(){
			var couponId = getQueryString("id");
			if(!/^[0-9]*[1-9][0-9]*$/.test(vm.initData.totalQty)){
				layer.msg('发行量只能是正整数');
				return false;
			}
			
			if(!Number(vm.initData.totalQty)){
				layer.msg('请输入正确的发行量');
				return false;
			}
			
			if(Number(vm.initData.totalQty)> Number(vm.original)){
				popChangeQtyFrame(couponId);
			}else{
				layer.msg('发行量不能小于上一次的'+vm.original+'张');
			}
			
			
		},
		uploadProducts: function(){	
			layer.open({
				type: 1,
				title: '添加商品',
				area: '700px',
				offset: '300px',
				move: false,
				skin: "s_select_data",
				content: $("#file-upload"),
				btn: ['保存', '取消'],
				yes: function(index, layero) {
					if(vm.fileName === ''){
						layer.msg('请选择文件！')
						return false;
					}
					var index = layer.load(1, {
					  shade: [0.1,'#fff'] //0.1透明度的白色背景
					});
					
					$.aAjax({
						url: ykyUrl.pay+'/v1/coupons/parseProductsFile?couponId='+vm.id+'&fileUrl='+vm.fileUrl,
						type: 'POST',
						success: function(res){
							layer.close(index);
							var dataList = [];
							for(var i =0; i< res.productList.length; i++){
								var item = res.productList[i];
								dataList.push(eval('('+item+')'));
							}
							vm.couponProductList = dataList;
							vm.fileName='';
							vm.fileUrl='';
							layer.closeAll();
						},
						error: function(err){
							layer.close(index);
							var errorTop = layer.open({
								type: 1,
								title: '错误',
								area: ['700px', '300px'],
								offset: '300px',
								move: false,
								skin: "s_select_data",
								content: err.responseJSON.errMsg,
								btn: ['确定'],
								yes: function(index, layero){
									layer.close(errorTop);
								}
							});
						}
					});
				},
				cancel: function(index, layero) {
					vm.fileName='';
					vm.fileUrl='';
				}
			})	
		},
		deleteProduct: function(i){
			vm.couponProductList.splice(i, 1);
		},
		toDefaultUrl: function(){
			return ykyUrl.portal+'/search/inventory/';
		}
	},
	watch: {//深度 watcher
	  'vendorModel': {
	    handler: function (val, oldVal) { 
	      this.vendorIds = this.vendorModel.join(',');
	      var vendorNameArr = [];
	      for(var i = 0; i < this.vendorModel.length; i ++){
	    	  for(var j = 0; j < this.vendorList.length; j ++){
	    		  if(this.vendorModel[i] == this.vendorList[j].id){
	    			  vendorNameArr.push(this.vendorList[j].partyGroup.groupName);
	    		  }
	    	  }
	      }
	      this.vendorNames = vendorNameArr;
	      this.vendorNameString = vendorNameArr.join(', ');
	    },
	    deep: true
	  },
	  'brandModel': {
	    handler: function (val, oldVal) { 
	      this.brandIds = this.brandModel.join(',');
	      var brandNameArr = [];
	      for(var i = 0; i < this.brandModel.length; i ++){
	    	  for(var j = 0; j < this.brandList.length; j ++){
	    		  if(this.brandModel[i] == this.brandList[j].id){
	    			  brandNameArr.push(this.brandList[j].brandName);
	    		  }
	    	  }
	      }
	      this.brandNames = brandNameArr;
	      this.brandNameString = brandNameArr.join(', ');
	    },
	    deep: true
	  },
	  'categoryModel': {
	    handler: function (val, oldVal) { 
	      this.categoryIds = this.categoryModel.join(',');
	      var categoryNameArr = [];
	      for(var i = 0; i < this.categoryModel.length; i ++){
	    	  for(var j = 0; j < this.categoryList.length; j ++){
	    		  if(this.categoryModel[i] == this.categoryList[j]._id){
	    			  categoryNameArr.push(this.categoryList[j].cateName);
	    		  }
	    	  }
	      }
	      this.cateNames = categoryNameArr;
	      this.categoryNameString = categoryNameArr.join(', ');
	    },
	    deep: true
	  }
	},
})

var popChangeQtyFrame = function(id){
	var num = vm.initData.totalQty;
	var inputLayer = layer.open({
		type: 1,
	  	title: "提示信息", //不显示标题
		shade: 0.5,
		btn: ['确定', '取消'],
		offset: '300px',
		area: ['620px', '180px'],
		skin:"up_skin_class",
		content: "<div class='layer_cont'>确定将发行量修改为<span>"+num+"</span>张吗？</div>",
		yes:function(){
			changeTotalQty(id,num,inputLayer);
		},
		cancel: function(){
			
		}
	})
}

var changeTotalQty = function(id,total,inputLayer){
	vm.submiting = true;
	var param ={
		"couponId": id,
		"totalQty": total,
		'activityUrl': vm.initData.activityUrl
	}
	
	param.useProductType = vm.useProductType;
	if(vm.useProductType === 0){
		param.brandId = vm.brandIds;
		param.brandName = vm.brandNameString;
		param.vendorId = vm.vendorIds;
		param.vendorName = vm.vendorNameString;
		param.productTypeId = vm.categoryIds;
		param.productTypeName = vm.categoryNameString;
	}else{
		if(vm.couponProductList.length === 0){
			layer.msg('请上传指定商品！')
			vm.submiting = false;
			layer.close(inputLayer);
			return false;
		}else{
			param.couponProductList = [];
			for(var i =0; i<vm.couponProductList.length; i++){
				if(vm.couponProductList[i].id === ''){
					layer.msg('商品信息中含有不合法数据，请删除！')
					vm.submiting = false;
					layer.close(inputLayer);
					break;
				}
				var item = {
					productId: vm.couponProductList[i].id,
					manufacturer: vm.couponProductList[i].spu.manufacturer,
					manufacturerPartNumber: vm.couponProductList[i].spu.manufacturerPartNumber,
					sourceId: vm.couponProductList[i].sourceId,
					vendorId: vm.couponProductList[i].vendorId
				};
				param.couponProductList.push(item);
			}
		}
	}
	
	if(!vm.submiting){
		return false;
	}
	
	$.aAjax({
		url: ykyUrl.pay + "/v1/coupons/updateTotalQtyById",
     	type:"POST",
     	data:JSON.stringify(param),
     	dataType:"json",
     	success: function(data) {
 			layer.close(inputLayer);
 			layer.msg("代金券总发行量修改成功 ！")
 			window.location.href = location.origin + ykyUrl._this + '/coupon.htm'	
     	},
	    error:function(e){
	    	layer.msg("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
 	});
}

var getDetail = function(id,action){
	var detailUrl = ykyUrl.pay+"/v1/coupons/detail/"+id;
	$.aAjax({
		url: detailUrl,
		type:"GET",
	    success: function(data) {
	    	if(data){
	    		vm.original = data.totalQty;
	    		vm.initData = data;
	    		vm.useProductType = vm.initData.useProductType;
	    		if(vm.initData.brandId || vm.initData.vendorId || vm.initData.productTypeId){
	    			if(!vm.initData.productTypeId){
	    				vm.categoryModel = [];
	    				vm.cateNames = [];
	    			}else{
	    				vm.categoryModel = vm.initData.productTypeId.split(',');
	    				Vue.nextTick(function(){
	    					vm.cateNames = vm.initData.productTypeName.split(',');
	    				})
//	    				vm.cateNames = vm.initData.productTypeName.split(',');
	    			}
	    			Vue.nextTick(function(){
	    				vm.categoryIds = vm.initData.productTypeId;
		    			vm.categoryNameString = vm.initData.productTypeName;
    				})
	    			
	    			
	    			if(vm.initData.vendorId === ''){
	    				vm.vendorModel = [];
	    				vm.vendorNames = [];
	    			}else{
	    				vm.vendorModel = vm.initData.vendorId.split(',');
	    				vm.vendorNames = vm.initData.vendorName.split(',');
	    			}
	    			vm.vendorIds = vm.initData.vendorId;
	    			vm.vendorNameString = vm.initData.vendorName;
	    			if(vm.initData.brandId === ''){
	    				vm.brandModel = [];
	    				vm.brandNames = [];
	    			}else{
	    				vm.brandModel = vm.initData.brandId.split(',');
	    				vm.brandNames = vm.initData.brandName.split(',');
	    			}
	    			vm.brandIds = vm.initData.brandId;
	    			vm.brandNameString = vm.initData.brandName;	
	    			
	    		}
	    		getPrivateUrl(data);
	    		if(vm.action == 'edit'){
	    			getBrand();
		    		getSupplier();
		    		getCategory();
	    		}
	    		if(data.useProductType == 1){
	    			getProductList(vm.id);
	    		}
	    	}
	    },
	    error:function(e){
	    	layer.msg("系统错误，审批失败，请联系系统管理员："+e.responseText)
	    }
	});
}

function getBrand(){
	var brandUrl =ykyUrl.product +"/v1/products/brands";
	$.aAjax({
		url: brandUrl,
		type:"GET",
		async: false,
	    success: function(data) {
	    	vm.brandList = data;
	    },
	    error:function(e){
	    	layer.msg("系统错误，审批失败，请联系系统管理员："+e.responseText)
	    }
	});
}

function getSupplier(){
	var supplierUrl =ykyUrl.party +"/v1/party/allparty";
	var params = {
		   "roleType": "SUPPLIER",
		    "status": "PARTY_ENABLED"
		}
	$.aAjax({
		url: supplierUrl,
		type:"PUT",
		data:JSON.stringify(params),
		async: false,
		contentType:'application/json',
		dataType:'json',
	    success: function(data) {
	    	vm.vendorList = data;
	    },
	    error:function(e){
	    	layer.msg("系统错误，审批失败，请联系系统管理员："+e.responseText)
	    }
	});
}

function getCategory(){
	var categoryUrl =ykyUrl.product +"/v1/products/categories/list";
	$.aAjax({
		url: categoryUrl,
		type:"GET",
	    success: function(data) {
	    	vm.categoryList = data;
	    },
	    error:function(e){
	    	layer.msg("系统错误，审批失败，请联系系统管理员："+e.responseText)
	    }
	});
}

var getProductList = function(id){
	$.aAjax({
		url: ykyUrl.pay+'/v1/coupons/parseProductsFile?couponId='+id,
		type: 'POST',
		success: function(res){
			var dataList = [];
			for(var i =0; i< res.productList.length; i++){
				var item = res.productList[i];
				dataList.push(eval('('+item+')'));
			}
			vm.couponProductList = dataList;
			vm.fileName='';
			vm.fileUrl='';
		},
		error: function(err){
			var errorTop = layer.open({
				type: 1,
				title: '错误',
				area: ['700px', '300px'],
				offset: '300px',
				move: false,
				skin: "s_select_data",
				content: err.responseJSON.errMsg,
				btn: ['确定'],
				yes: function(index, layero){
					layer.close(errorTop);
				}
			});
		}
	});
}

var getLogList = function(id){
	var logListUrl = ykyUrl.pay+"/v1/coupons/getCouponStatusList/"+id+"?actionName=EDIT";
	$.aAjax({
		url: logListUrl,
		type:"GET",
	    success: function(data) {
	    	vm.logList = data;
	    	if(data.length>0){
	    		vm.logListNull = true;
	    	}else{
	    		vm.logListNull = false;
	    	}
	    },
	    error:function(e){
	    	layer.msg("系统错误，审批失败，请联系系统管理员："+e.responseText)
	    }
	});
}

var getPrivateUrl =  function(dataParam){
	var temp = dataParam;
	$.aAjax({
		url: ykyUrl.party + "/v1/enterprises/getImgUrl",
     	type:"POST",
     	data:JSON.stringify({"id":temp.approvedProof}),
     	success: function(data) {
     		if(null !=data || data == ""){
     			vm.profImg = data;
     		}
     	},
     	error:function(e){
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
 	});
}


var initUI = function(id,action){
	if("edit"==action){
		$(document).attr("title","编辑代金券页");
	}else if("examine"==action){
		$(document).attr("title","修改代金券页");
	}
	if(id){
		getDetail(id,action);
		getLogList(id);
	}else{
		console.log("id为空,系统错误，审批失败，请联系系统管理员：");
	}
}
$(function(){
	var databaseTotalQty;
	vm.id = getQueryString("id");
	vm.action = location.href.indexOf('edit') > -1 ? 'edit': 'examine';
	initUI(vm.id,vm.action);
})

var uploadProduct = createUploader({
	buttonId: "uploadProductFile", 
	uploadType: "coupon.product", //上传后文件存放路径
	url:  ykyUrl.webres,
	types: "xls,xlsx,csv",//可允许上传文件的类型
	fileSize: "5mb", //最多允许上传文件的大小
	isImage: false, //是否是图片
	init:{
		FileUploaded : function(up, file, info) { 
            layer.close(index);
			if (info.status == 200 || info.status == 203) {
				vm.fileName = file.name;
				vm.fileUrl = _fileUrl;
			} else {
				layer.msg("上传文件失败,请重新上传！",{icon:2,offset:120}); 
			}
			up.files=[];
		}
	}
}); 
uploadProduct.init(); 



