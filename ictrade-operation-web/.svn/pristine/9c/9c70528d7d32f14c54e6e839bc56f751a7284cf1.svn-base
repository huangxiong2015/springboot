/**
 * create by roy.he@yikuyi.com at 2017-7-24
 */
var validate;
var vm = new Vue({
	el: '#createCoupon',
	data: {
		couponCateList: [{
			value: 'PLATFORM_PROMO',
			text:'活动推广劵',
		},{
			value: 'EXACT_PROMO',
			text:'定向推广劵',
		},{
			value: 'OFFLINE_PROMO',
			text:'地推类型劵',
		}],
		couponCate: 'PLATFORM_PROMO',
		name: '',
		thruTypeIdList: [{
			value: 'EXACT_DATE_ZONE',
			text: '限时领取'
		},{
			value: 'FROM_GET_DATE',
			text: '限时使用'
		}],
		thruTypeId: 'EXACT_DATE_ZONE',
		limitMonth: '',
		thruDate: '',
		fromDate: '',
		unitAmount: '',
		couponCurrency: 'CNY',
		totalQty: '',
		couponPartyType: 'UNLIMIT',
		couponMethodType: 'AUTO_SEND',
		consumeLimitAmount: '',
		couponText: '',
		approvedProof: '',
		specified: true,
		vendorList: [],
		brandList: [],
		useLimitPerCustomer: '',
		useProductType: 1,
		businessType: 'ACTIVITY_ORDER',
		couponProductList: [],
		approvedProofShow: '',
		fileName: '',
		fileUrl: '',
		submiting: false,
		vendorModel: [],
		vendorNames: [],
		vendorIds: '',
		vendorNameString: '',
		vendorToggle: false,
		brandModel: [],
		brandNames: [],
		brandIds: '',
		brandNameString: '',
		brandToggle: false,
		activityUrl: '',
	},
	created: function(){
		getSupplier();
		getBrand();
	},
	methods: {
		saveData: function(){
			vm.submiting = true;
			var postData = {};
			postData.couponCate = vm.couponCate;
			postData.name = vm.name;
			postData.unitAmount = vm.unitAmount;
			postData.couponCurrency = vm.couponCurrency;
			postData.consumeLimitAmount = vm.consumeLimitAmount;
			postData.totalQty = vm.totalQty;
			postData.couponText = vm.couponText;
			postData.couponPartyType = vm.couponPartyType
			postData.couponMethodType = vm.couponMethodType
			postData.thruTypeId = vm.thruTypeId;
			postData.activityUrl = vm.activityUrl;
					
			$('#createCouponForm').submit();
			if(!validate){
				vm.submiting = false;
				return false;
			}
			
			if(vm.thruTypeId === 'EXACT_DATE_ZONE'){
				if(!vm.fromDate || vm.fromDate === '' || !vm.fromDate || vm.fromDate === ''){
					layer.msg('起始时间和结束时间不能为空');
					vm.submiting = false;
					return false;
				}else{
					postData.fromDate = vm.fromDate;
					postData.thruDate = vm.thruDate;
				}
			}else if(vm.thruTypeId === 'FROM_GET_DATE'){
				if(vm.limitMonth === ''){
					layer.msg('有效时间不能为空');
					vm.submiting = false;
					return false;
				}else{
					postData.limitMonth = vm.limitMonth;
				}
			}
			
			if(vm.approvedProof === ''){
				layer.msg('请上传代金券申请凭证');
				vm.submiting = false;
				return false;
			}else{
				postData.approvedProof = vm.approvedProofShow;
			}
			
			if(vm.couponMethodType === 'AUTO_SEND'){
				postData.businessType = vm.businessType
			}
			
			if(!$('#useLimitPerCustomer input[value="0"]').prop('checked') && vm.useLimitPerCustomer == '0'){
				layer.msg('每用户限领不能为空')
				vm.submiting = false;
				return false;
			}else if($('#useLimitPerCustomer input[value="0"]').prop('checked')){
				postData.useLimitPerCustomer = '0';
				vm.useLimitPerCustomer='';
			}else{
				if(parseInt(vm.useLimitPerCustomer) <= 0){
					layer.msg('每用户限领不能小于0')
					vm.submiting = false;
					return false;
				}else{
					postData.useLimitPerCustomer = vm.useLimitPerCustomer;
				}
			}
			
			if(Number(vm.unitAmount) > Number(vm.consumeLimitAmount)){
				layer.msg('使用限额必须大于等于单张面值');
				vm.submiting = false;
				return false;
			}
			
			if(Number(vm.totalQty) < Number(vm.useLimitPerCustomer)){
				layer.msg('总发行量必须大于等于每用户限领张数');
				vm.submiting = false;
				return false;
			}
			postData.useProductType = vm.useProductType;
			if(vm.useProductType === 0){
				postData.brandId = vm.brandIds;
				postData.brandName = vm.brandNameString;
				postData.vendorId = vm.vendorIds;
				postData.vendorName = vm.vendorNameString;
			}else{
				if(vm.couponProductList.length === 0){
					layer.msg('请上传指定商品！')
					vm.submiting = false;
					return false;
				}else{
					postData.couponProductList = [];
					for(var i =0; i<vm.couponProductList.length; i++){
						if(vm.couponProductList[i].id === ''){
							layer.msg('商品信息中含有不合法数据，请删除！')
							vm.submiting = false;
							break;
						}
						var item = {
							productId: vm.couponProductList[i].id,
							manufacturer: vm.couponProductList[i].spu.manufacturer,
							manufacturerPartNumber: vm.couponProductList[i].spu.manufacturerPartNumber,
							sourceId: vm.couponProductList[i].sourceId,
							vendorId: vm.couponProductList[i].vendorId
						};
						postData.couponProductList.push(item);
					}
				}
			}
			
			if(!vm.submiting){
				return false;
			}
			
			syncData(ykyUrl.pay + "/v1/coupons/addCoupon", 'POST', postData,
				function(res, err) {
					vm.submiting = false;
					if (res.code === '200') {
						location.href = location.origin + ykyUrl._this + '/coupon.htm';
					}else{
						layer.msg('创建失败！');
					}
				});
		},
		cancel: function(){
			history.back(-1)
		},
		uploadProducts: function(){	
			layer.open({
				type: 1,
				title: '添加商品',
				area: '700px',
				offset: '300px',
				move: false,
				skin: "s_select_data",
				content: $("#file-upload"),
				btn: ['保存', '取消'],
				yes: function(index, layero) {
					if(vm.fileName === ''){
						layer.msg('请选择文件！')
						return false;
					}
					var index = layer.load(1, {
					  shade: [0.1,'#fff'] //0.1透明度的白色背景
					});
					
					$.aAjax({
						url: ykyUrl.pay+'/v1/coupons/parseProductsFile?fileUrl='+vm.fileUrl,
						type: 'POST',
						success: function(res){
							layer.close(index);
							var dataList = [];
							for(var i =0; i< res.productList.length; i++){
								var item = res.productList[i];
								dataList.push(eval('('+item+')'));
							}
							vm.couponProductList = dataList;
							vm.fileName='';
							vm.fileUrl='';
							layer.closeAll();
						},
						error: function(err){
							layer.close(index);
							var errorTop = layer.open({
								type: 1,
								title: '错误',
								area: ['700px', '300px'],
								offset: '300px',
								move: false,
								skin: "s_select_data",
								content: err.responseJSON.errMsg,
								btn: ['确定'],
								yes: function(index, layero){
									layer.close(errorTop);
								}
							});
						}
					});
				},
				cancel: function(index, layero) {
					vm.fileName='';
					vm.fileUrl='';
				}
			})	
		},
		couponCateChange: function(){
			if(vm.couponCate === 'PLATFORM_PROMO'){
				vm.couponMethodType = 'AUTO_SEND';
				this.$nextTick(function () {
					$('input[value="AUTO_SEND"]').prop('checked', true);
				})
			}else{
				vm.couponMethodType = 'EXACT_SEND';
				this.$nextTick(function () {
					$('input[value="EXACT_SEND"]').prop('checked', true);
				})		
			}					
		},
		showBigImg: function(){
			if(vm.approvedProof !=''){
				layer.open({
					  type: 1,
					  title: false,
					  closeBtn: 0,
					  area: ['800px', '500px'],
					  offset: '100px',
					  shadeClose: true,
					  content: $('.originalImage')
				});
			}
		},
		deleteProduct: function(i){
			vm.couponProductList.splice(i, 1);
		},
//		vendorAll: function(){
//			var _this = this;
//		    if (this.vendorAllChecked) {//实现反选
//		      _this.vendorModel = [];
//		    }else{//实现全选
//		      _this.vendorModel = [];
//		      _this.vendorList.forEach(function(item) {
//		        _this.vendorModel.push(item.id);
//		      });
//		    }
//		}
	},
	watch: {//深度 watcher
	  'vendorModel': {
	    handler: function (val, oldVal) { 
	      this.vendorIds = this.vendorModel.join(',');
	      var vendorNameArr = [];
	      for(var i = 0; i < this.vendorModel.length; i ++){
	    	  for(var j = 0; j < this.vendorList.length; j ++){
	    		  if(this.vendorModel[i] == this.vendorList[j].id){
	    			  vendorNameArr.push(this.vendorList[j].partyGroup.groupName);
	    		  }
	    	  }
	      }
	      this.vendorNames = vendorNameArr;
	      this.vendorNameString = vendorNameArr.join(', ');
	    },
	    deep: true
	  },
	  'brandModel': {
	    handler: function (val, oldVal) { 
	      this.brandIds = this.brandModel.join(',');
	      var brandNameArr = [];
	      for(var i = 0; i < this.brandModel.length; i ++){
	    	  for(var j = 0; j < this.brandList.length; j ++){
	    		  if(this.brandModel[i] == this.brandList[j].id){
	    			  brandNameArr.push(this.brandList[j].brandName);
	    		  }
	    	  }
	      }
	      this.brandNames = brandNameArr;
	      this.brandNameString = brandNameArr.join(', ');
	    },
	    deep: true
	  }
	},
})


$('#createCouponForm').validate({
	rules: {
		name: {
			required: true,
			maxlength: 30,
		},
		unitAmount: {
			required: true,
			min: 1,
			digits: true,
		},
		totalQty: {
			required: true,
			min: 1,
			digits: true,
		},
		couponText: {
			required: true,
			maxlength: 100,
		},
		consumeLimitAmount: {
			required: true,
			min: 1,
			digits: true,
		},
		activityUrl: {
			url: true
		}
	},
	messages: {
		name: {
			required: '代金券名称不能为空',
			maxlength: '代金券名称不能超过30个字'
		},
		unitAmount: {
			required: '面值不能为空',
			min: '发行量必须大于1的整数',
			digits: '面值必须大于1的整数'
		},
		totalQty: {
			required: '发行量不能为空',
			min: '发行量必须大于1的整数',
			digits: '发行量必须大于1的整数'
		},
		couponText: {
			required: '请填写代金券备注',
			maxlength: '备注最多不能超过100字'		
		},
		consumeLimitAmount: {
			required: '使用限额不能为空',
			min: '使用限额必须大于1的整数',
			digits: '使用限额必须大于1的整数'	
		},
		activityUrl: {
			url: '请输入正确的链接'
		}
	},
	errorElement: "em",
	success: function(label) {
		$(label).parent().find('.tip').remove();
		$(label).removeClass("error icon-triangle-leftmin"); // speech-bubble speech-bubble-left

		$(label).addClass("icon-confirm");
		if ($(label).parent().find('input').val() === '') {
			$(label).removeClass("icon-confirm");
		}
	},
	errorPlacement: function(error, element) {
		var f = error[0].getAttribute("for");
		var ele = $("em[for=" + f + "]");
		if (ele.length > 0) {
			ele[0].remove();
		}
		element.parent().find('.tip').remove();
		error.appendTo(element.parent());
		$(error).addClass("error icon-triangle-leftmin");
		validate = false;
	},
	submitHandler: function(form) { // 表单提交时修改校验状态
		validate = true;
	}
})

function getBrand(){
	var brandUrl =ykyUrl.product +"/v1/products/brands";
	$.aAjax({
		url: brandUrl,
		type:"GET",
	    success: function(data) {
	    	vm.brandList = data;
	    },
	    error:function(e){
	    	layer.msg("系统错误，审批失败，请联系系统管理员："+e.responseText)
	    }
	});
}

function getSupplier(){
	var supplierUrl =ykyUrl.party +"/v1/party/allparty";
	var params = {
		   "roleType": "SUPPLIER",
		    "status": "PARTY_ENABLED"
		}
	$.aAjax({
		url: supplierUrl,
		type:"PUT",
		data:JSON.stringify(params),
		contentType:'application/json',
		dataType:'json',
	    success: function(data) {
	    	vm.vendorList = data;
	    },
	    error:function(e){
	    	layer.msg("系统错误，审批失败，请联系系统管理员："+e.responseText)
	    }
	});
}

function init(){
	$.validator.messages.digits = '请输入大于1的整数'
	$('#thruDateRange.input-daterange').datepicker({
	    format: config.dateFormat,
	    autoclose: true,
	    todayHighlight : true,  
	    startDate: new Date() 
	}).on('changeDate', function(ev){
		vm.fromDate = $('#thruDateStart').val();
		vm.thruDate = $('#thruDateEnd').val();
	});
	
	$('#auto-send').prop('checked', true);
	$('#businessType input[value="NO_LIMIT"]').prop('checked', true)
	$('#useLimitPerCustomer input[value="0"]').prop('checked', true)
	$('#useLimitPerCustomer input[value="0"]').click(function(){
		vm.useLimitPerCustomer = '';
	})
	$('#businessType input[value="0"]').prop('checked', true)
	
	if(vm.couponPartyType === 'UNLIMIT'){
		$('#couponPartyType input').each(function(){
			$(this).prop('checked', true);
		})
	}else if(vm.couponPartyType === 'PARTY_GROUP'){
		$('#couponPartyType input[value="PARTY_GROUP"]').prop('checked', true)
	}else{
		$('#couponPartyType input[value="PERSON"]').prop('checked', true)
	}
	
	$('#couponPartyType input').click(function(){
		if($('#couponPartyType input:checked').length === 0){
			return false;
		}	
		if(!$('#couponPartyType input[value="PERSON"]').prop('checked')){
			vm.couponPartyType = 'PARTY_GROUP';
		}else if(!$('#couponPartyType input[value="PARTY_GROUP"]').prop('checked')){
			vm.couponPartyType = 'PERSON';
		}else{
			vm.couponPartyType = 'UNLIMIT';
		}
	})
	
	var business = ['PERSON_REG','COMPANY_REG','UP_COMPANY','APPROVE_COMPANY','ACTIVITY_ORDER'];
	var partyTypeGroup = $('#couponPartyType input[value="PARTY_GROUP"]'),
		partyTypePerson = $('#couponPartyType input[value="PERSON"]');
	
	if(vm.couponMethodType == 'AUTO_SEND' && vm.businessType == 'ACTIVITY_ORDER'){
		partyTypeGroup.prop('checked', true);
		partyTypePerson.prop('checked', true);
		vm.couponPartyType = 'UNLIMIT';
	}
		
	$('#businessType input').click(function(){
		if($('#businessType input[value='+business[0]+']').prop('checked')){
			vm.couponPartyType = 'PERSON';
			partyTypePerson.prop('checked', true);
			partyTypeGroup.prop('checked', false);
		}else if($('#businessType input[value='+business[1]+']').prop('checked') || $('#businessType input[value='+business[2]+']').prop('checked') || $('#businessType input[value='+business[3]+']').prop('checked')){
			vm.couponPartyType = 'PARTY_GROUP';
			partyTypeGroup.prop('checked', true);
			partyTypePerson.prop('checked', false);
		}else{
			partyTypeGroup.prop('checked', true);
			partyTypePerson.prop('checked', true);
			vm.couponPartyType = 'UNLIMIT';
		}
	})
}

var uploader = createUploader({
	buttonId: "uploadFile", 
	uploadType: "coupon.voucher", //上传后文件存放路径
	url:  ykyUrl.webres,
	types: "jpg,jpeg,png,bmp",//可允许上传文件的类型
	fileSize: "5mb", //最多允许上传文件的大小
	isImage: true, //是否是图片
	init:{
		FileUploaded : function(up, file, info) { 
            layer.close(index);
			if (info.status == 200 || info.status == 203) {
				vm.approvedProof = signatureData.image;
				vm.approvedProofShow = _fileUrl;
			} else {
				layer.msg("上传文件失败,请重新上传！",{icon:2,offset:120}); 
			}
			up.files=[];
		}
	}
}); 
uploader.init();

var uploadProduct = createUploader({
	buttonId: "uploadProductFile", 
	uploadType: "coupon.product", //上传后文件存放路径
	url:  ykyUrl.webres,
	types: "xls,xlsx,csv",//可允许上传文件的类型
	fileSize: "5mb", //最多允许上传文件的大小
	isImage: false, //是否是图片
	init:{
		FileUploaded : function(up, file, info) { 
            layer.close(index);
			if (info.status == 200 || info.status == 203) {
				vm.fileName = file.name;
				vm.fileUrl = _fileUrl;
			} else {
				layer.msg("上传文件失败,请重新上传！",{icon:2,offset:120}); 
			}
			up.files=[];
		}
	}
}); 
uploadProduct.init(); 

init();