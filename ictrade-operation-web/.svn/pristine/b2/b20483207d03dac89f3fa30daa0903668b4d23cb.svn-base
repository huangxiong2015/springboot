var vm
$(function() {
	var valid = false;
	 vm = new Vue(
			{
				el : "#activityInformation",
				data : {
					initData:{
						createType:'CUSTOM',//创建方式  CUSTOM:定制开发 , TEMPLATE:模板创建
						startDate:'',//促销开始时间 
						endDate:'',//促销结束时间
						faceImgUrl:'',//活动封面图片地址URL
						promotionId:$('#promotionId').val(),//活动促销id
						promotionName:'',//促销名称
						promotionUrl:'',//活动链接url
						isUseCoupon:'Y'//是否使用代金券
					},
					couponList:[],
					temporaryCouponList:[],
					selectCouponList:[],
					newsHome: operationWebUrl + "/promotion.htm",
				},
				created:function(){
					var that = this;
					syncData(ykyUrl.pay + "/v1/coupons/couponActivity/findByActivityId", 'GET', null, function(res,err) {//获取优惠券列表
						if (err == null) {
							$.each(res,function(i,e){
								var obj = {
										couponId:e.couponId,
										couponName:e.couponName
								}
								that.couponList.push(obj);
							})
						}
					},false)
					if (this.initData.promotionId) {
						syncData(ykyUrl.product + '/v1/promotions/' + this.initData.promotionId , 'GET', null, function(res, msg) {
							vm.init(res);
							});		
					}else{
						this.$nextTick(function(){
							setDate();							
					   });
					}
				},
				methods : {
					init : function(res) {
						var that = this;
						res.startDate = new Date(res.startDate).Format('yyyy-MM-dd');
						res.endDate = new Date(res.endDate).Format('yyyy-MM-dd');
						this.initData = $.extend({},this.initData,res);
						if(res.couponIds){
							var arr = res.couponIds.split(',');
							$.each(arr,function(i,e){
								$.each(that.couponList,function(idx,ele){
									if(e == ele.couponId){
										that.selectCouponList.push(ele);
										return false
									}
								})
							})
						}
						that.temporaryCouponList = that.selectCouponList;
						that.$nextTick(function(){
							setDate();
							$(".startDates.form_datetime").datetimepicker('setEndDate',res.endDate);
							$(".endDates.form_datetime").datetimepicker('setStartDate',res.startDate);
					   });
					},
					saveData : function() {//保存数据					
						$('#create').submit();						
					},				
					cancelClick:function(){
						location.href = ykyUrl._this + '/promotion.htm';
					},
					selectCoupon:function(){
						$('.coupon-par').addClass('show');
					},
					closeCouponList:function(type){
						$('.coupon-par').removeClass('show');
						if(type == 'save'){
							this.selectCouponList = this.temporaryCouponList;
						}else if(type == 'cancel'){
							this.temporaryCouponList = this.selectCouponList;
						}
					},
					deleteCoupon:function(item){
						var that = this;
						var cId = item.couponId;
						$.each(that.selectCouponList,function(i,e){
							if(e.couponId == cId){
								that.selectCouponList.splice(i,1);
								return false;
							}
						})
					}
				},
				
			});
	 $("#promotionName").on("focus",function(){
		 if($(this).val()=='' && !$(this).parent().hasClass('has-error')){			
			 $(".ipt-tips").removeClass("dn");
		 }else if($(this).val()=='' && $(this).parent().hasClass('has-error')){
			 $(".ipt-tips").addClass("dn");
			 $(".ipt-vail").removeClass("dn");
		 }
	 })
	 $("#promotionName").on("blur",function(){
		 $(".ipt-tips").addClass("dn");
		 if($(this).val()==''){			 
			 $(".ipt-vail").removeClass("dn");
			 $(this).addClass("error_bor")
		 }else{
			 vm.initData.name = $.trim($(this).val()); 
			 $(".ipt-vail").addClass("dn");
			 $(this).removeClass("error_bor")
		 }
	 })
	 function setDate(){
		 $('.startDates.form_datetime').datetimepicker({
				language: config.language,
				format: 'yyyy-mm-dd',
				minView: 'month',
		        startView: 2,
		        autoclose: true,
		        startDate:new Date,
		    }).on('change',function(ev){
		    	var startDate = $('#startDate').val();
			    $(".endDates.form_datetime").datetimepicker('setStartDate',startDate);
			    vm.initData.startDate = startDate;	
			    if(startDate){
			    	$('#startDate').valid()
			    }
		        });
			 //	时间控件绑定选择面板弹出 
			$('.endDates.form_datetime').datetimepicker({
				language: config.language,
				format: 'yyyy-mm-dd',
				minView: 'month',
		        startView: 2,
		        autoclose: true,
		        startDate:new Date,
		    }).on('change',function(ev){
		    	var endDate = $('#endDate').val();
		        $(".startDates.form_datetime").datetimepicker('setEndDate',endDate);
		        vm.initData.endDate = endDate;
		        if(endDate){
		        	$('#endDate').valid()
			    }
		    });
	 }

	

	var uploader = createUploader({
		buttonId: "uploadBtn", 
		uploadType: "productUpload.activityProductsUpload", //上传后文件存放路径
		url:  ykyUrl.webres,
		types: "jpg,png,jpeg,gif",//可允许上传文件的类型
		fileSize: "5mb", //最多允许上传文件的大小
		isImage: true, //是否是图片
		init:{
			FileUploaded : function(up, file, info) { 
	            layer.close(index);
				if (info.status == 200 || info.status == 203) {
					vm.initData.faceImgUrl = signatureData.image.replace(/http\:|https\:/,"");
					
				} else {
					layer.msg("上传文件失败,请重新上传！",{icon:2,offset:120}); 
				}
				up.files=[];
			}
		}
	});
	
	uploader.init();
	
	formValidate('#create', {}, function(){
		if(!vm.initData.faceImgUrl){
			layer.msg('请上传活动封面！')
			return;
		}
		if(vm.initData.createType == 'TEMPLATE' && vm.initData.isUseCoupon == 'Y' && vm.selectCouponList.length==0){
			layer.msg('请选择优惠券');
			return;
		}
		var formArry = $('#create').serializeObject();	
		formArry.faceImgUrl = vm.initData.faceImgUrl;
		formArry.promotionId = vm.initData.promotionId;
		if(vm.initData.isUseCoupon == 'Y' && vm.initData.createType == 'TEMPLATE'){
			var arr = [];
			$.each(vm.selectCouponList,function(i,e){
				arr.push(e.couponId);
			})
			formArry.couponIds = arr.join(',');
		}else{
			formArry.isUseCoupon = 'N';
			formArry.couponIds = '';
		}
		var url = ykyUrl.product + '/v1/promotions',
			type = vm.initData.promotionId ? 'PUT' : 'POST';
		syncData(url,type,formArry,function(res,msg){
			if(msg == null){
				location.href = ykyUrl._this + '/promotion.htm';
			}
		})
	});
	
});
function urlDispose(url){//活动链接路径处理
	if(!url){
		return '';
	}else{
		if(url.indexOf("http:")>=0){
			return url.replace("http:","")
		}else if(url.indexOf("https:")>=0){
			return url.replace("https:","")
		}else{
			if(url.substring(0,2) === "//"){
				return url
			}else{
				return "//" + url;
			}
		}
	}
}