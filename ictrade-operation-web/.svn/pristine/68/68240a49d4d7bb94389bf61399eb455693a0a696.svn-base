var vm = '';
$(function(){	 
     vm = new Vue({
        el: '#recuit-list',
        data: { 
            url : ykyUrl.info + "/v1/recommendations/searchlistpage", //访问数据接口 
            queryParams : {           //请求接口参数 
                defaultStatus:true,  //监测参数变化标识
            },
            goodsQuantityTotal:"3",
            gridColumns: [          //表格列
                {key: 'desc', name: '描述',align : 'center',width: '200px', cutstring: true},
                {key: 'goodsQuantity', name: '推广商品数',align : 'center',},
                {key: 'lastUpdateDate', name: '更新时间',align : 'center'},
                {key: 'publishDate', name: '生效时间',align : 'center'},
                {key: 'orderSeq', name: '排序',align : 'center'},
                {
					key : 'status',
					align : 'center',
					name : '状态',
					text : {
						PUBLISHED : {
							'color' : 'green',
							'value' : '已生效',
						},
						DRAFT : {
							'color' : 'black',
							'value' : '未生效'
						},
						HOLD : {
							'color' : 'red',
							'value' : '已停用'
						}
					}
				},
				{
					key : 'operate',
					name : '操作',
					align : 'center',
					items : [ {
						className : 'btn-detail',
						text : '详情',
						show : true,
						href : ykyUrl._this+'/searchPromotion/detail.htm?recommendationId={recommendationId}',
						target : '_blank'
					}, {
						className : 'btn-delete',
						show : "'{status}'=='PUBLISHED'",
						text : '停用',
						callback : {
							confirm : {
								title : '停用',
								content : '确认停用？'
							},
							action : 'doChangeStatus',
							params : [ '{recommendationId}', 'HOLD', '{goodsQuantity}' ]
						}
					}, {
						className : 'btn-delete',
						show : "'{status}'!='PUBLISHED'",
						text : '生效',
						callback : {
							confirm : {
								title : '生效',
								content : '确认生效？'
							},
							action : 'doChangeStatus',
							params : [ '{recommendationId}', 'PUBLISHED', '{goodsQuantity}' ]
						}
					}, {
						className : 'btn-edit',
						text : '编辑',
						show : " '{status}'!='PUBLISHED' ",
						href : ykyUrl._this+'/searchPromotion/edit.htm?recommendationId={recommendationId}',
					}]
				}
            ], 
            pageflag : false,    //是否显示分页
            refresh: false ,    //重载  
            selectUrl :ykyUrl.database + '/v1/category/companylist?categoryTypeId=OCCUPATION_TYPE',    //数据接口，必须
            id : 'categoryId',        //设置控件ID ，必须
            name : 'categoryName',        //设置控件name ，必须
            inputClass : '',    //设置下拉选项的class，可选
            styleObject: ''    //设置style，可选

        }, 
        created(){
        	  var that = this;
        	  var qModel = parseUrlParam();
        	  for(var i in qModel){
                  that.queryParams[i] = qModel[i];
              } 
              this.queryParams.defaultStatus = !this.queryParams.defaultStatus;
        }
    });   
});

//显示已生效条数
setTimeout('shouNum()', 1000);
function shouNum(){
	var published = $(".td-status");
    var publishedNum = 0;
    for(var i = 0;i < published.length;i++){
   	 if(published.eq(i).children("div").children("span").children("span").css("color") == "rgb(0, 128, 0)"){
   		 var num = published.eq(i).siblings(".td-goodsQuantity").children("div").children("span").children("span").children("div").children("span").text();
   		 publishedNum = Number(num) + Number(publishedNum);
   	 }
    }
    $(".hasPublished").text(publishedNum);
  	$(".canPublished").text(10-publishedNum);
};

var t=0;
function doChangeStatus(index, params) {//发布
	
	if(params[1]=='PUBLISHED'){
		t= t + params[2];
	}else if(params[1]=='HOLD'){
		t= (t - params[2])>0 ? (t - params[2]) : 0;
	}
	syncData(ykyUrl.info + "/v1/recommendations/searchstatus/" + params[0] + "/" + params[1], 'PUT',
			null, function(res, err) {//页面加载前调用方法
				window.setTimeout(function() {
					vm.refresh = !vm.refresh;//重载
				}.bind(vm), 400);
				layer.close(index);
				setTimeout('shouNum()', 1000);
			});
};

$(function(){
	var host = ykyUrl.portal;
	url = $('.viewlist').attr('href');
	$(".viewlist").attr('href', host+url);
});