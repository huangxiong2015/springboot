
$(function() {
	var brandId = getQueryString('id');
	vm = new Vue({
		el : "#manufacturer-edit",
		data : {
			brandId:getQueryString('id'),
			newsHome:ykyUrl._this + '/manageManufacturer.htm',
	    	initData:{
	    		abstracts:"", //分销商简介
			    attachUrl:"", //分销商图片url 编辑时存在newsAttachment.attachUrl
			    categoryTypeId:"BRAND", //固定
			    content:"", //代理线、类别、热销型号、最新型号、活动图标、自定义图标内容、图标链接 json字符串
			    newsId:"", //分销商id
			    orderSeq:"", //排序位置
			    title:"" //分销商名称
	    	},
	    	content:{
	    		agents:[], //代理线
	    		cate:[], //类别
	    		hotSaleModel:[], //热销型号
	    		latestModel:[], //最新信号
		    	labelContent:'nothing', //活动图标
		    	customContent:'', //自定义图标内容
		        activityUrl:'' //图标标签链接
	    	},
	    	labelType:{
	    		nothing:'无',
	    		promotion:'促销',
	    		fullCut:'满减',
	    		fullDelivery:'满送',
	    		seckill:'秒杀',
	    		flashPurchase:'闪购',
	    		custom:'自定义',
	    	},
	    	showModal:false, //弹窗显示
	    	showFoot:true, //弹窗footer显示
	    	modalTitle:'请选择制造商', //弹窗标题
	    	modalStyle:{ //弹窗样式
	    		width:950,
				maxHeight:600,
				overflowY:'auto'
	    	},
	    	maxNum:16, //代理线、类别最大值
	    	showVendor:false, //显示供应商
	    	showTopHot:false, //选择热销型号
	    	showPrdAssociate:false, //
	    	agentDefaultTip:'请选择制造商',
	    	cateDefaultTip:'请选择制造商',
	    	agentTitle:'请选择代理线',
	    	cateTitle:'请选择类别',
	    	activeAgent:[], //选中的代理线
	    	activeCate:[], //选中的类别
	    	activeHotPrd:[], //选中的热销型号
	    	activeLastestPrd:[], //选中的最新型号
	    	vendorSelect:{
	    		keyname:'选择制造商',
				validate:{
                    "required": true
                },
                id:'selbox',
                name:'selbox',
                options:[],
                optionId: 'id',
                optionName: 'brandName',
                selected:[],
                placeholder:'搜索制造商',
            	multiple:false //单选
	    	},
	    	agentSelect:{
	    		showSearch:false,
	    		showLetter:false,
	    		keyname:'选择代理分销商',
				validate:{
                    "required": true
                },
                id:'selbox',
                name:'selbox',
                options:[],
                optionId: 'partyId',
                optionName: 'groupName',
                selected:[],
                //placeholder:'搜索代理线',
            	multiple:true //单选
	    	},
	    	cateSelect:{
	    		showSearch:false,
	    		showLetter:false,
	    		keyname:'选择类别',
				validate:{
                    "required": true
                },
                id:'selbox',
                name:'selbox',
                options:[],
                optionId: 'id',
                optionName: 'name',
                selected:[],
                //placeholder:'搜索类别',
            	multiple:true //单选
	    	},
	    	topHot:{
	    		columns:[{key :'selected', name: '',width: '50px'},
	    		         {key :'index', name: '序号', align:'center', width: '50px'},
	    		         {key :'model', name: '型号', align:'center',cutstring: true,},
	    		         {key :'manufacturer', name: '原厂', align:'center',cutstring: true,}],
		        datas:[],
		        selectedItem:[],
	    		defaultTip:'暂无数据',
	    		checkflag:true
	    	},
	    	editPrdData:{
	    		id:'',
	    		prdUrl:'', //型号链接
				model:'', //型号
				manufacturer:'',  //原厂
				imageUrl:'' // 图片地址
	    	},
	    	productBasicApi: ykyUrl.product + '/v1/products/batch/basic',
	    	//productBasicApi:ykyUrl._this + '/data/basic.json',
	    	productRequestType: 'POST',
	    	isAdd:true,
	    	isEdit:true,
	    	isReadOnly:false,
	    	prdType:'',
	    	hotList:{
	    		refresh:true,
	    		defaultTip:'请选择制造商',
	    		datas:[],
	    		columns:[
    		         	{key :'index', name: '序号', align:'center', width: '50px'},
    		         	{key :'model', name: '型号', align:'center',cutstring: true,},
    		         	{key :'manufacturer', name: '原厂', align:'center',cutstring: true,},
    		         	{key :'operate', name: '操作', align:'center',
    		         		items:[
    		         		       {className:'btn-detail',
    		         		    	text: '上移',
    		         		    	show: "'{seq}' != 0",
	       		         		    callback: {
	       		         		    	action: 'changSeq', 
	       		                        params: ['{rowData}',1,'hotList']
	       		         		    	}
		         		    	   	},
		         		    	   	{className:'btn-detail down-change',
    		         		    	 text: '下移',
    		         		    	 show: true,
	       		         		     callback: {
	       		         		    	action: 'changSeq', 
	       		                        params: ['{rowData}',2,'hotList']
	       		         		    	}
		         		    	   	},
		         		    	   {className:'btn-detail',
    		         		    	text: '详情',
    		         		    	show: true,
	       		         		    callback: {
	       		         		    	action: 'detailPrd', 
	       		                        params: ['{rowData}']
	       		         		    	}
		         		    	   	},
		         		    	   	{className:'btn-detail',
    		         		    	 text: '编辑',
    		         		    	 show: true,
	       		         		     callback: {
	       		         		    	action: 'editPrd', 
	       		                        params: ['{rowData}','hotList']
	       		         		    	}
		         		    	   	},
		         		    	   {className:'btn-detail',
    		         		    	text: '删除',
    		         		    	show: true,
	       		         		    callback: {
	       		         		    	action: 'delPrd', 
	       		                        params: ['{rowData}','hotList']
	       		         		    	}
		         		    	   	}
    		         		       ]
    		         	}
	    		         ]
	    		
	    	},
	    	newestList:{
	    		refresh:true,
	    		defaultTip:'暂无数据',
	    		datas:[],
		       columns:[
    		         	{key :'index', name: '序号', align:'center', width: '50px'},
    		         	{key :'model', name: '型号', align:'center',cutstring: true,},
    		         	{key :'manufacturer', name: '原厂', align:'center',cutstring: true,},
    		         	{key :'operate', name: '操作', align:'center',
    		         		items:[
    		         		       {className:'btn-detail',
    		         		    	text: '上移',
    		         		    	show: "'{seq}' != 0",
	       		         		    callback: {
	       		         		    	action: 'changSeq', 
	       		                        params: ['{rowData}',1,'newestList']
	       		         		    	}
		         		    	   	},
		         		    	   	{className:'btn-detail down-change',
    		         		    	 text: '下移',
    		         		    	 show: true,
	       		         		     callback: {
	       		         		    	action: 'changSeq', 
	       		                        params: ['{rowData}',2,'newestList']
	       		         		    	}
		         		    	   	},
		         		    	   {className:'btn-detail',
    		         		    	text: '详情',
    		         		    	show: true,
	       		         		    callback: {
	       		         		    	action: 'detailPrd', 
	       		                        params: ['{rowData}']
	       		         		    	}
		         		    	   	},
		         		    	   	{className:'btn-detail',
    		         		    	 text: '编辑',
    		         		    	 show: true,
	       		         		     callback: {
	       		         		    	action: 'editPrd', 
	       		                        params: ['{rowData}','newestList']
	       		         		    	}
		         		    	   	},
		         		    	   {className:'btn-detail',
    		         		    	text: '删除',
    		         		    	show: true,
	       		         		    callback: {
	       		         		    	action: 'delPrd', 
	       		                        params: ['{rowData}','newestList']
	       		         		    	}
		         		    	   	}
    		         		       ]
    		         	}
	    		         ]
	    	}
		},
		mounted:function(){
			var that = this;
			var uploader = createUploader({
				buttonId: "uploadBtn", 
				uploadType: "notice.publicRead", 
				url:  ykyUrl.webres,
				types: "jpg,png,jpeg,gif",
				fileSize: "5mb",
				isImage: true, 
				init:{
					FileUploaded : function(up, file, info) { 
			            layer.close(index);
						if (info.status == 200 || info.status == 203) {
							console.log(_fileUrl);
							that.initData.attachUrl = _fileUrl;
						} else {
							layer.msg("上传文件失败,请重新上传！",{icon:2,offset:120}); 
						}
						up.files=[];
					}
				}
		    }); 
			uploader.init();
		},
		created(){
			var that = this;
			if(this.brandId == ''){
				syncData(ykyUrl.info + '/v1/news?categoryTypeIdStr=BRAND','GET',null, function(data, err) {
					if (err == null) {
						that.initData.orderSeq = data.total + 1;
					}
				});
			}else{
				this.getRelevantData(this.brandId,false);
				syncData(ykyUrl.info + '/v1/news/' + this.brandId, 'GET', null, function(res,err){
					if(err == null){
						console.log(res);
						that.initData = res ? $.extend({},that.initData,res) : {};
						that.content = res.content ? $.extend({},that.content,JSON.parse(res.content)) : {};
						that.initData.attachUrl = res.newsAttachment && res.newsAttachment.attachUrl ? res.newsAttachment.attachUrl : '';
						that.agentSelect.selected = that.content.agents ? that.content.agents : [];
						that.cateSelect.selected = that.content.cate ? that.content.cate : [];
						that.activeAgent = that.getActiveData(that.agentSelect.selected,that.agentSelect.options,'brandId');
						that.activeCate = that.getActiveData(that.cateSelect.selected,that.cateSelect.options,'id');
						that.hotList.datas = that.content.hotModel ? that.content.hotModel : [];
						that.newestList.datas = that.content.newestModel ? that.content.newestModel : [];
						that.hotList.refresh = !that.hotList.refresh;
						that.newestList.refresh = !that.newestList.refresh;
						that.$nextTick(function(){
							that.hotList.refresh = !that.hotList.refresh;
							that.newestList.refresh = !that.newestList.refresh;
						})
					}
				})
				
			}
			syncData(ykyUrl.product + '/v1/products/manufacturers','GET',{size:5000},function(res,err){
				if(err == null){
					that.vendorSelect.options = res.list;
				}
			})			
			
		},
		watch:{
			'initData.newsId':function(val,oldVal){
				if(oldVal){
					this.activeAgent = [];
					this.activeCate = [];
					this.agentSelect.selected = [];
					this.cateSelect.selected = [];
					this.hotList.datas = [];
					this.newestList.datas = [];
					this.hotList.refresh = !this.hotList.refresh;
					this.newestList.refresh = !this.newestList.refresh;
					this.$nextTick(function(){
						this.hotList.refresh = !this.hotList.refresh;
						this.newestList.refresh = !this.newestList.refresh;
					})
				}
			},
			'hotList.datas':function(val,oldVal){
				$.each(val,function(i,e){
					e.seq = i;
				})
			},
			'newestList.datas':function(val,oldVal){
				$.each(val,function(i,e){
					e.seq = i;
				})
			},
		}, 
		methods : { 
			toggleModal:function(){
				this.showModal = false;
				this.showFoot = true;
				this.showVendor = false;
				this.showTopHot = false;
				this.showPrdAssociate = false;
			},
			modalOk:function(){
				this.showModal = false;
				this.showFoot = true;
				if(this.showVendor){
					this.showVendor = false;
				}
			},
			showVendorModel:function(){
				this.showModal = true;
				this.showFoot = false;
				this.showVendor = true;
				this.modalTitle = '请选择制造商';
			},
			getActiveData:function(activeData,dataList,key){
				var arr = [];
				$.each(activeData,function(i,e){
					$.each(dataList,function(index,ele){
						if(e == ele[key]){
							arr.push(ele)
							return false
						}
					})
				})
				return arr;
			},
			getVendorSelected:function(ele){
				var initData = this.initData;
				initData.newsId = ele.id;
				//initData.newsId = 'mouser';
				initData.title = ele.brandName;
				initData.attachUrl = ele.logo ? ele.logo : '' ;
				this.vendorSelect.selected = String(ele.id);
				this.showModal = false;
				this.showFoot = true;
				this.showVendor = false;
				this.getRelevantData(ele.id,true);
			},
			getAgentSelected:function(data){
				var that = this;
				if(data.length > this.maxNum){
					layer.msg('最多选择' + this.maxNum + '项目');
					var arr = [];
					$.each(that.activeAgent,function(i,e){
						if(e.id){
							arr.push(e.id);
						}
					})
					this.agentSelect.selected = arr;
				}else{
					this.activeAgent = data;
				}
				
			},
			getCateSelected:function(data){
				var that = this;
				if(data.length > this.maxNum){
					layer.msg('最多选择' + this.maxNum + '项目');
					var arr = [];
					$.each(that.activeCate,function(i,e){
						if(e.id){
							arr.push(e.id);
						}
					})
					this.cateSelect.selected = arr;
				}else{
					this.activeCate = data;
				}
				
			},
			getRelevantData:function(id,isAsync){//获取代理线、分类等数据
				var that = this;
				//id = '899845721178505216';
				
				syncData(ykyUrl.party + '/v1/vendors/productLine/supplier/' + id,'GET',null,function(res,err){
					if(err == null){
						that.agentSelect.options = res;
						if(!res.length){
							that.agentDefaultTip = '暂无分销商数据';
						}
					}
				},isAsync)
			                            
				syncData(ykyUrl.party + '/v1/vendors/productLine/supplier/category/' + id,'GET',null,function(res,err){
					if(err == null){
						var cateObj = {
								category1Id:'category1Name',
								category2Id:'category2Name',
								category3Id:'category3Name',
						}
						$.each(res,function(i,e){
							var id = [],name = [];
							for(k in cateObj){
								if(e[k]){
									id.push(e[k]);
								}
								if(e[cateObj[k]]){
									name.push(e[cateObj[k]]);
								}
							}
							e.id = id.join('/');
							e.name = name.join('/');
						})
						that.cateSelect.options = res;
						if(!res.length){
							that.cateDefaultTip = '暂无类别数据';
						}
					}
				},isAsync)
				//id = 'mouser';
				syncData(ykyUrl.product + '/v1/products/findProductInfos','GET',{arg:id,flag:'b'},function(res,err){
					if(err == null){
						var arr = [];
						$.each(res,function(i,e){
							var obj = {
									id:e.id ? e.id :'',
									prdUrl:e.id ? ykyUrl.portal + '/product/' + e.id + '.htm' : '',
									model:e.spu && e.spu.manufacturerPartNumber ? e.spu.manufacturerPartNumber : '',
									manufacturer:e.spu && e.spu.manufacturer ? e.spu.manufacturer : '',
									imageUrl:e.spu && e.spu.images ? that.getImageUrl(e.spu.images) : ''
							}
							arr.push(obj);
						})
						that.topHot.datas = arr;
						if(!res.length){
							that.hotList.defaultTip = '暂无数据';
						}
					}
				},isAsync)
			},
			getImageUrl:function(data){
				var obj = {};
				$.each(data,function(i,e){
					obj[e.type] = e.url;
				})
				if(obj.large){
					return obj.large
				}else if(obj.stand){
					return obj.stand
				}else{
					return obj.thumbnail
				}
			},
			getActiveHotPrd:function(){
				var that = this;
				var checkedItem = eval('('+$(".top-hot-wrap #checkedIds").val()+')');
				if(that.hotList.datas.length){
					var manualAddList = [],list = [];
					$.each(this.hotList.datas,function(i,e){
						if(e.manualAdd){
							manualAddList.push(e);
						}
					})
					list = list.concat(manualAddList,checkedItem);
					if(list.length>5){
						layer.msg('热销型号最多为5条！');
						return;
					}else{
						this.hotList.datas = list;
					}
				}else{
					this.hotList.datas = checkedItem;
				}
				this.showModal = false;
				this.showFoot = true;
				this.showTopHot = false;
				this.hotList.refresh = !this.hotList.refresh;
				this.$nextTick(function(){
					this.hotList.refresh = !this.hotList.refresh;
				})
				
			},
			addProduct:function(type){
				var that = this;
				this.prdType = type;
				this.showModal = true;
				this.showPrdAssociate = true;
				this.isEdit = false;
				this.isAdd = true;
				this.editPrdData = {
						id:'',
						imageUrl:'',
						manufacturer:'',
						model:'',
						prdUrl:'',
						//seq:this[type].datas.length-1
				}
				if(type == 'hotList'){
					this.modalTitle = '添加热销型号';
				}else{
					this.modalTitle = '添加最新型号';
				}
			},
			getProductInfo:function(data){
				var type = this.prdType;
				var id = data.id,flag = true;
				if(this.isAdd){
					$.each(this[type].datas,function(i,e){
						if(e.id == id){
							layer.msg('请勿重复添加！');
							flag = false;
							return false
						}
					})
					if(!flag){
						return;
					}
					this[type].datas.push(data);
				}else if(this.isEdit){
					$.each(this[type].datas,function(i,e){
						if(e.id == data.id){
							for(k in e){
								e[k] =  data[k] || data[k] =='' ? data[k] : e[k];
							}
							return false;
						}
					})
				}
				this.showModal = false;
				this.showPrdAssociate = false;
				this[type].refresh = !this[type].refresh;
				this.$nextTick(function(){
					this[type].refresh = !this[type].refresh;
				})
			},
			prdAssociateCancel:function(){
				this.showModal = false;
				this.showPrdAssociate = false;
			},
			showTopHotList:function(){
				var that = this;
				this.showModal = true;
				this.showFoot = false;
				this.showTopHot = true;
				this.modalTitle = '请选择热销型号';
				var arr = [];
				$.each(that.hotList.datas,function(i,e){
					$.each(that.topHot.datas,function(idx,ele){
						if(e.id == ele.id){
							arr.push(ele);
							return false;
						}
					})
				})
				this.topHot.selectedItem = arr;
			},
			saveData:function(){
				$('#create').submit();
			}
		}
	});

	//提交表单
	formValidate('#create', {}, function(){
		var initData = vm.initData
			type = vm.brandId == '' ? 'POST' : 'PUT',
			url =  vm.brandId == '' ? ykyUrl.info + '/v1/news/' : ykyUrl.info + '/v1/news/' + vm.brandId; 
		if(initData.newsId == ''){
			layer.msg('请选择制造商！');
		}
		var dataList = $('#create').serializeObject();
		if(vm.activeAgent.length){
			dataList.content.agents = vm.$refs.agentSelect.$refs.letterSelect.sel;
			dataList.content.agentsData = vm.activeAgent;
		}
		if(vm.activeCate.length){
			dataList.content.cate = vm.$refs.cateSelect.$refs.letterSelect.sel;
			dataList.content.cateData = vm.activeCate;
		}
		if(vm.hotList.datas.length){
			dataList.content.hotModel = vm.hotList.datas;
		}
		if(vm.newestList.datas.length){
			dataList.content.newestModel = vm.newestList.datas;
		}
		dataList.content = JSON.stringify(dataList.content);
		syncData(url, type, dataList, function(res,err){
			if(err == null){
				
				layer.msg('保存成功');
				setTimeout(function(){
					location.href = ykyUrl._this + '/manageManufacturer.htm';
				},2000);
				
			}
		})
	}); 
	
	
	
}); 

function editPrd(index, params){
	vm.showModal = true;
	vm.showPrdAssociate = true;
	vm.editPrdData = params[0];
	vm.prdType = params[1];
	vm.isEdit = true;
	vm.isAdd = false;
	vm.isReadOnly = false;
	if(vm.prdType == 'hotList'){
		vm.modalTitle = '编辑热销型号';
	}else{
		vm.modalTitle = '编辑最新型号';
	}
}
function detailPrd(index, params){
	vm.showModal = true;
	vm.showPrdAssociate = true;
	vm.editPrdData = params[0];
	vm.prdType = params[1];
	vm.isEdit = false;
	vm.isReadOnly = true;
	if(vm.prdType == 'hotList'){
		vm.modalTitle = '热销型号详情';
	}else{
		vm.modalTitle = '最新型号详情';
	}
}
function delPrd(index, params){
	var seq = params[0].seq,
		key = params[1],
		list =  vm[key]['datas'];
	list.splice(seq,1);
}
function changSeq(index,params){
	var seq = params[0].seq,
		type = params[1],
		key = params[2],
		list = vm[key]['datas'];
	if(type == 1){
		list.splice(seq-1,2,list[seq],list[seq-1]);
	}else{
		list.splice(seq,2,list[seq+1],list[seq]);
	}
}