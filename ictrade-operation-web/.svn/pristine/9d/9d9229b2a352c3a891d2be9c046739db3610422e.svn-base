/**
 * Created vendorBaseInfoAudit.js by zr.xieyuanpeng@yikuyi.com on 2017年8月21日.
 */

var vm = new Vue({
	el: '#baseInfoAudit',
	data:{
		applyId:getQueryString("applyId"),
		auditInfo:{},
		auditApplyContent:{},
		applyContentJsonObj:{}
	},
	created: function(){
		var _this = this;
		var applyId = getQueryString("applyId");
		syncData(ykyUrl.workflow + "/v2/apply", 'GET', {'applyId': applyId}, function(res,err) {
			if (!err && res !== '') {
				var data = res;
				var bigData = data.list[0] || {};
				data = JSON.parse(data.list[0].applyContent) || {};
				//to do，麻烦后台把格式给我
				_this.auditInfo = bigData;
				_this.applyContentJsonObj = bigData.applyContentJsonObj;
				_this.auditApplyContent = data;
			}
		},false);  
	},
	methods:{
		examineEvent:function(type){
    		var that = this;
    		var applyType, backUrl, map;
    		var operPrefix = ykyUrl.party;
    		//账期审核
			backUrl = operPrefix+"/v1/vendorManage/apply/basedata/callback";    			
			/*map = {
				applyContentJsonObj:that.applyContentJsonObj
			}*/
    		var listData = {
					applyContent: JSON.stringify(that.auditApplyContent),
    				approvePartyId: $("#userId").val(),
    				id: that.auditInfo.applyOrgId,  //企业ID
    				callBackUrl: backUrl,  //回调url
    				remark:  '',   //审核意见
    			};
    		if(type == 'yes'){
    			applyType = 'APPROVED'; //通过        	
    			layer.confirm("<p style='font-weight:bold;'>确定审核通过？</p><p>审核通过后，该用户可以认证企业身份采购</p>",{
    				offset: "auto",
    				btn: ['确      认','取      消'], //按钮
    				title: " ",
    				area: 'auto',
    				maxWidth:'500px',
    				move: false,
    				skin: "up_skin_class",
    				yes:function(){
    					that.dyAjax(applyType,listData);
    				}
    			})
    		}else{
    			applyType = 'REJECT'; //驳回
    			layer.confirm($('.reason-wrap').html(),{
    				offset: "auto",
    				btn: ['确      认','取      消'], //按钮
    				title: " ",
    				area: 'auto',
    				maxWidth:'500px',
    				move: false,
    				skin: "up_skin_class",
    				yes:function(){
    					var reason = $.trim($('.up_skin_class #remark').val());
    					if(reason == ''){
    						$('.up_skin_class #remark').attr('placeholder','审核不通过的原因不能为空');
    						return;
    					}
    					listData.remark = reason;
    					that.dyAjax(applyType,listData);
    				}
    			})        			
    		}        		
    	},
    	dyAjax:function(type,postObj){//审核接口调用
    		var that = this;
    		var alertTxt = '';
    		if(type === 'APPROVED') {
				alertTxt = '审核通过';
			}else {
				alertTxt = '驳回成功';
			}
    		syncData(ykyUrl.workflow +"/v1/task/" + type + "/" + that.applyId,'PUT',postObj,function(res,err){
    			if(err == null){
    				layer.msg(alertTxt);
        			setTimeout(function(){
        				layer.closeAll();
        				debugger;
        				location.href = location.href;
        			}, 2000)
    			}
    		})
    	},
	}
})

/*function getApplyInfo(){
	var applyId = getQueryString("applyId");
	syncData(ykyUrl.workflow + "/v2/apply", 'GET', {'applyId': applyId}, function(res,err) {
		if (!err && res !== '') {
			var data = res;
			var bigData = data.list[0] || {};
			data = JSON.parse(data.list[0].applyContent) || {};
			//to do，麻烦后台把格式给我
			vm.auditInfo = bigData;
			vm.applyContentJsonObj = bigData.applyContentJsonObj;
			vm.auditApplyContent = data;
		}
	},false);  
}*/

/*统计textarea字数*/
function setLetterNum(e){
	var num = $(e).val().length;
	$(e).parent().find('.letter-num').text(num);
}