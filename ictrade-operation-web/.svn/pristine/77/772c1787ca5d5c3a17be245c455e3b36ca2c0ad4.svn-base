<!DOCTYPE html>
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<c:set var="ctx" value="${pageContext.request.contextPath }" scope="request" />

<!--[if IE 8 ]>    <html class="ie8" lang="zh-CN"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9" lang="zh-CN"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!-->
<html lang="zh-CN">
<!--<![endif]-->

<head>
	<!-- jQuery 1.11.3 -->
  <c:import url ="/WEB-INF/jsp/include/main/constants.jsp"/>
  <title>代金券发放页面</title>

 <style type="text/css">
 	/* tab头 */
 	.head_cont{
 		height:36px;
 		margin-top:20px;
 		height: 30px;
 	}
 	.head_tab{
 		margin-left: 20px;
 		padding-bottom: 5px;
 		cursor:pointer;
 	}
 	.head_tab.active{
 		color:#b1191a;
 		border-bottom: 2px solid #b1191a;
 	}
 	.head_tab:hover{
 		color: #b1191a;
 	}
 	.head_tab.active:hover{
 		color:#b1191a;
 		border-bottom: 2px solid #b1191a;
 	}
 	.set_sending_layer h4{
 		text-align:center;
 		margin-top: 80px;
 	}
 	.condition_inquery{background-color:#c11f2e;color:#fff;padding:10px 10px;font-size:14px;border-radius:3px;}
	.col_bt_time input{width:37%;}
  	.col_bt label,.col_bt_time label{text-align:right;}
  	.col_input_2{width:12%;}
  	.col_input_3{width:15%;}
  	.mt25{margin-top:25px;}
  	.table img{width: 32px;height: 32px;}
  	.ui-selectmenu-button.ui-button {width: 14%;margin: 0px;margin-top: -3px;height: 30px;line-height: 30px;}
  	#status-button{width: 16%;}
  	.content-wrapper .content-header .pitch_tab{border-top: 0px;}
  	.item_page .showpages {height: 120px;margin-bottom: 30px;}
  	
  	.up_skin_class .y_prompt_content {width: 330px;margin-top: 25px;}
  	.operation {margin-bottom: 20px;}
  	.w340{width: 340px;height: 100px;padding: 5px 10px;resize: none;}
  	
  	.table td a{padding-right: 0px;}
  	.lh25{line-height:25px;}
  	.titleClass span{display: inline-block;width: 100%;}
  	
  	.ms-controller{visibility: hidden;}
  	.col_bt{height:32px;}
  	.bred{border-color:#b1191a;}
  	
  	/*handleOut layer */
	.handle_g_layer{
		overflow:hidden;
		display:none;
	    width: 600px;
	    margin-top: 20px;
	    margin-left: 13px;
	}
	.handle_g_layer .label {
	    float: left;
	    min-width: 62px;
	    text-align: right;
	    height: 32px;
	    line-height: 32px;
	    color: #666;
	    margin-right: 10px;
	}
	.handle_g_layer .cont_title{
		height: 20px;
		line-height: 20px;
		margin-bottom: 20px;
		color:#666;
	}
	.handle_g_layer .cont_title span{
	    margin-left:8px;
	}
	.handle_g_layer .input_wrap {
	    position: relative;
	    margin-bottom: 10px;
	}
	
	.handle_g_layer .same_input {
	    width: 436px;
	    height: 32px;
	    line-height: 32px;
	    padding-left: 10px;
	    padding-right: 10px;
	    border: 1px solid #e4e4e4;
	    font-size: 12px;
	}
	.handle_g_layer textarea{
		padding:10px;
		resize: none;
	}
	.handle_g_layer .error_border{
		border:solid 1px #d0021b;
	}
	.handle_g_layer .icon-exclamark{
		font-size:24px;
		left: -35px;
	    top: 1px;
	    color: #dfac45;
	    position: absolute;
	}
	/*浮窗*/
	.fly_skin_class{margin: auto;background-color: #fff;border: 3px solid #afafaf !important;}
	.fly_skin_class .layui-layer-content{font-size:16px;color: #333;text-align: left;line-height: 91px !important;}
	.fly_skin_class .icon-right-c{position:relative;top:2px;font-size: 22px; color: #87b848; margin: 32px 0 0 0;font-weight: bold;display: inline-block;padding-right: 25px;}
	/*浮窗*/
	
	/* 选定的链接 */

	/* status search invoice type search */
	.status, .type {
	    position: relative;
	}
	.status_list, .type_list,.currency_list{
	    display: none;
	    position: absolute;
	    border: 1px solid #e4e4e4;
	    background-color: #fff;
	    top: 0;
	    z-index: 9;
	    text-align: center;
	}
	.status:hover .status_list,.type:hover .type_list,.currency:hover .currency_list{
	    display: block;
	}
	.status_list li, .type_list li,.currency_list li{
	    display: block;
	    height: 28px;
	    line-height: 28px;
	   /*  width: 80px; */
	    cursor: pointer;
	}
	.type_list,.status_list,.currency_list{
	    width: 100%;
	}
	.type_list li:hover, .status_list li:hover,.currency_list li:hover{
	    background: #f8f8f8;
	}
	.type_list li:hover a, .status_list li:hover a,.currency_list li:hover a{
	    color: #b1191a;
	}
	.icon-down_arrow1{
		margin-left:5px;
	}
	/* 可用条件 */
	.availble_txt{
		line-height:26px;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
		padding-left:10px;
		padding-right:10px;
	}
 </style>
  <link rel="stylesheet" href="${ctx}/js/credenceUpload/credenceUpload.css?20161229" />
</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

	<!---index header  start   ---->
	<jsp:directive.include file="../include/main/header.jsp" />
	<!---index header  end   ---->
	 <!---index nav  start   ---->
	<jsp:directive.include file="../include/main/menu.jsp" />
	<!---index nav  end   ---->
	  
	  <!-- 右边内容显示 -->
	  <div class="content-wrapper ms-controller"  ms-controller=list>
		<!-- Content Header (Page header) -->
		<section class="content-header">
			<a href="#" class="header_tab pitch_tab">代金券</a>
			<input type="hidden" id="orderId" value="237" />
		</section>
	    <!-- Main content -->
		<section class="content container-fluid">
			<div class="head_cont">
				<a class="head_tab" href="${ctx}/couponList.htm">代金券创建</a>
				<a class="head_tab active">代金券发放</a>
				<a class="head_tab" href="${ctx}/couponStatisticList.htm">代金券统计</a>
			</div>
			<div class="row mt20" ms-controller="search" id=searchFrom>
				<div class="col-xs-10"  style="border-right:1px solid #e2e2e2">
						<div class="col-xs-6 col_bt pr0 mb10">	
								<label>&ensp;&ensp;&ensp;&ensp;名称：</label>						
								<input class="col_input_1" type="text" name="name" data-duplex="@parameter.name" ms-attr="{value:@parameter.name}" style="width:37%;">
							</div>	
							<div class="col-xs-6 col_bt_time pr0 pl0 mb10">
								<label class="">创建时间：</label>
								<span class="rel">
									<input id="createDateStart" name="createDateStart" class="y_main_head_input ovh" 
										style="padding-right:46px;" type="text" ms-duplex="@parameter.createDateStart" 
										ms-attr="{value:@parameter.createDateStart}">
					                <span class="y_timer"><i class="cc1 icon-calendar"></i></span>
								</span>
								<span>至</span>
								<span class="rel">
					                <input id="createDateEnd" name="createDateEnd" class="y_main_head_input ml10 ovh" style="padding-right:46px;" type="text" ms-duplex="@parameter.createDateEnd" ms-attr="{value:@parameter.createDateEnd}">
					                  <span class="y_timer"><i class="cc2 icon-calendar"></i></span>
								</span>
								<span class="content_top_close" onclick="showDiv();"></span>								
							</div>
							<div class="col-xs-6 col_bt_time pr0">
								<label class="">有效时间：</label>
								<span class="rel">
									<input id="thruDateStart" name="thruDateStart" class="y_main_head_input ovh" style="padding-right:46px;" type="text" ms-duplex="@parameter.thruDateStart" ms-attr="{value:@parameter.thruDateStart}">
					                <span class="y_timer"><i class="cc3 icon-calendar"></i></span>
								</span>
								<span>至</span>
								<span class="rel">
					                <input id="thruDateEnd" name="thruDateEnd" class="y_main_head_input ml10 ovh" style="padding-right:46px;" type="text" ms-duplex="@parameter.thruDateEnd" ms-attr="{value:@parameter.thruDateEnd}">
					                  <span class="y_timer"><i class="cc4 icon-calendar"></i></span>
								</span>
								<span class="content_top_close" onclick="showDiv();"></span>								
							</div>
					</div>
				
				<div class="col-xs-2 mt25">
					<a href="javascript:;" class="condition_inquery" ms-click="@goSearch()">
						<span ><i class="icon-sousuo mr5"></i>查询</span>
					</a>
				</div>			
				
			</div>
			
			<!-- 表格 -->
			<div class="row mt20">
				<div class="col-xs-12" id="result_table">
					<table class="table">
						<thead>
							<tr>
								<th width="4%">序号</th>
								<th width="6%" style="position:relative;" class="type">
								   <span >类型<i class="icon-down_arrow1"></i>
			    				   </span>
					    			<ul class="type_list">
					    				<li><a href="javascript:void(0);"  onclick="return searchData('couponCate','');">全部类型</a></li>
				    					<li><a href="javascript:void(0);"  onclick="return searchData('couponCate','OFFLINE_PROMO');">地推类型</a></li>
				    					<li><a href="javascript:void(0);" onclick="return searchData('couponCate','PLATFORM_PROMO');">平台推广</a></li>
				    					<li><a href="javascript:void(0);" onclick="return searchData('couponCate','EXACT_PROMO');">定向推广</a></li>
					    			</ul>
								</th>
								<th width="9%">名称</th>
								<th width="8%">创建时间</th>
								<th width="3%">面值</th> 
								<th width="5%" class="currency" style="position:relative;">
									<span >币种<i class="icon-down_arrow1"></i>
			    				   </span>
					    			<ul class="currency_list">
					    				<li><a href="javascript:void(0);"  onclick="return searchData('couponCurrency','');">全部币种</a></li>
					    				<li><a href="javascript:void(0);"  onclick="return searchData('couponCurrency','CNY');">RMB</a></li>
				    					<li><a href="javascript:void(0);"  onclick="return searchData('couponCurrency','USD');">USD</a></li>
					    			</ul>
								</th>
								<th width="14%">有效时间</th>
								<th width="15%">使用条件</th>
								<th width="6%">总发行量</th>
								<th width="6%">剩余数量</th>
								<th width="6%" class="status">
									<span >全部状态<i class="icon-down_arrow1"></i>
			    				   </span>
					    			<ul class="status_list">
					    				<li><a href="javascript:void(0);"  onclick="return searchData('statusId','');">全部状态</a></li>
					    				<li><a href="javascript:void(0);"  onclick="return searchData('statusId','WAIT_SEND');">待发放</a></li>
				    					<li><a href="javascript:void(0);"  onclick="return searchData('statusId','SENDING');">发放中</a></li>
				    					<li><a href="javascript:void(0);"  onclick="return searchData('statusId','END');">已结束</a></li>
					    			</ul>
								</th>
								<th width="100px">操作</th>
							</tr>
						</thead>
						<tbody >
							<tr :if="@isfirst || !@list.list.length" >
								<td colspan="12" style="padding:20px" id="loadingData" ms-html="@isLoading">数据加载中</td>
							</tr>
							<tr ms-for="($index, co) in @list.list">

								<td>{{$index + 1}}</td>
								<td class="titleClass">
										<span ms-attr="{title:'平台推广'}" :if="co.couponCate == 'PLATFORM_PROMO'">平台推广</span>
										<span ms-attr="{title:'定向推广'}" :if="co.couponCate == 'EXACT_PROMO'">定向推广</span>
										<span ms-attr="{title:'地推类型'}" :if="co.couponCate == 'OFFLINE_PROMO'">地推类型</span>
									</td>
									<td ms-attr="{title:typeof(co.name) == 'undefined' ? '' : co.name}">{{co.name}}</td>
									<td ms-attr="{title:typeof(co.createdDate) == 'undefined' ? '' : co.createdDate}">{{co.createdDate}}</td>
									<td ms-attr="{title:typeof(co.unitAmount) == 'undefined' ? '' : co.unitAmount}">{{co.unitAmount}}</td>
									<td class="titleClass">
										<span ms-attr="{title:'USD'}" :if="co.couponCurrency == 'USD'">USD</span>
										<span ms-attr="{title:'RMB'}" :if="co.couponCurrency == 'CNY'">RMB</span>
									</td>
									
									<td>
										<span :if="(co.thruTypeId=='EXACT_DATE_ZONE')||(co.thruTypeId=='exact_date_zone')"><em>{{co.fromDateFormat}}</em>至<em>{{co.thruDateFormat}}</em></span>
										<span :if="(co.thruTypeId=='FROM_GET_DATE')||(co.thruTypeId=='from_get_date')">领取后<em>{{co.limitMonth}}</em>个月内有效</span>
									</td>
									
									
									<td>
										<p ms-html="@getAvailbleProduct(co.brandName,co.vendorName)" ms-attr="{title:@getAvailbleProduct(co.brandName,co.vendorName)}" class="availble_txt"></p>
										<p style="line-height:26px;">满<span>{{co.consumeLimitAmount||number(2)}}</span><span :if="co.couponCurrency=='CNY'">元</span><span :if="co.couponCurrency=='USD'">美元</span>使用</p>
									</td>
									<td ms-attr="{title:typeof(co.totalQty) == 'undefined' ? '' : co.totalQty}">{{co.totalQty}}</td>
									<td >{{co.totalQty - co.sendQty}}</td>
									<td class="titleClass">
										<span ms-attr="{title:'待发放'}" :if="co.statusId == 'WAIT_SEND'">待发放</span>
										<span ms-attr="{title:'发放中'}" :if="(co.statusId == 'SENDING')&&(co.totalQty - co.sendQty)">发放中</span>
										<span ms-attr="{title:'已结束'}" :if="co.statusId == 'END'">已结束</span>
										<span ms-attr="{title:'已领完'}" :if="(co.statusId == 'SENDING')&&!(co.totalQty - co.sendQty)">已领完</span>
									</td>
								
								
								<td>
										<a class="poi" ms-attr="{href:'${ctx}/coupon.htm?action=detail&id='+co.couponId}" target="_blank">详情</a>
										<span :if="co.statusId != 'END'">
											<a :if="(co.couponCate == 'EXACT_PROMO')&&(co.totalQty - co.sendQty)" class="poi" ms-attr="{'data-couponid':co.couponId}" ms-click="@handleOutTicket($event);">发放</a>
											<a :if="(co.couponCate == 'OFFLINE_PROMO')&&(co.totalQty - co.sendQty)" class="poi" ms-attr="{href:'${ctx}/coupon.htm?action=groundhandleOut&&id='+co.couponId}" target="_blank">发放</a>
											<a :if="(co.couponCate == 'EXACT_PROMO')&&!(co.totalQty - co.sendQty)" class="poi" ms-click="@qtyNull">发放</a>
											<a :if="(co.couponCate == 'OFFLINE_PROMO')&&!(co.totalQty - co.sendQty)" class="poi" ms-click="@qtyNull">发放</a>
											<a :if="(co.couponCate == 'PLATFORM_PROMO')&&(co.statusId == 'WAIT_SEND')" class="poi" ms-attr="{'data-couponid':co.couponId}" ms-click="@changeStatus($event);">发放</a>
										</span>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</section>
		<!-- /.content -->
		
		<div class="item_page pl30">
			<div class="l showpages">
	            <span class="l mr5">每页显示数量</span>
	            <div class="show_number_extrude l">
	            	<span class="spn">{{showList.list.pageSize}}</span><i class="icon-down"></i><i class="icon-upward dn"></i>
	                <div class="show_number_cont">
	                    <ul>
	                        <li ms-if="showList.list.pageSize != '10'" onclick="changeSize(10);"><a href="javascript:;">10</a></li>
	                        <li ms-if="showList.list.pageSize != '20'" onclick="changeSize(20);"><a href="javascript:;">20</a></li>
	                        <li ms-if="showList.list.pageSize != '30'" onclick="changeSize(30);"><a href="javascript:;">30</a></li>
	                        <li ms-if="showList.list.pageSize != '40'" onclick="changeSize(40);"><a href="javascript:;">40</a></li>
	                        <li ms-if="showList.list.pageSize != '50'" onclick="changeSize(50);"><a href="javascript:;">50</a></li>
	                    </ul>
	                </div>
	        	</div>
			</div>
			<!-- 分页 -->
			<div id="pager" class="r">
				  <div id="kkpager"></div>
			</div>
			<input type="hidden" value="" id="total">
			<input type="hidden" value="" id="pageSize">
		</div>
	  </div>
	 
	   
	<script type="text/javascript">
		var selectCatid = "242,250";
	</script>
	<!---footer  start   ---->
	<jsp:directive.include file="../include/main/footer.jsp" />
	<!---footer  end   ---->
	<!-- layer -->
	<div class="handle_g_layer">
		<p class="cont_title tc"><span class="f18 dn error_tip rel"><i class="icon-exclamark"></i>请输入定向发放用户信息</span></p>
		<div class="item">
			<span class="label" style="margin-top: -10px;">用户账号：</span>
			<div class="input_wrap">
				<textarea name="userNames" id="userNames" cols="70" rows="10" placeholder="最大可输入10个用户名称，以“,”间隔"></textarea>
			</div>
		</div>
		<div class="item">
			<span class="label">备注：</span>
			<div class="input_wrap">
				<input type="text" name="remark" id="remark" class="same_input" placeholder="输入发放原因" maxlength="20">
			</div>
		</div>
	</div>
	<!-- layer -->
<script src="${ctx}/js/lib/plupload-2.1.2/js/plupload.full.min.js"></script>
<script src="${ctx}/js/credenceUpload/credenceUpload.js?a=20170109"></script>
<script src="${ctx}/js/credenceUpload/oss_credence.js?b=20170100600"></script>
<script src="${ctx}/js/lib/jquery.validate.js"></script>
<script src="${ctx}/js/common/add.validate.js"></script>

</div>	    
	<script type="text/javascript">
	
	//平台定向卷发放
	/* var postplatformCouponUrl = ykyUrl.pay+"/v1/coupons/platformCoupon"; */
	var postplatformCouponUrl = ykyUrl.pay+"/v1/coupons/platformCoupon";
	var popHandleFrame = function(id){
		var inputLayer = layer.open({
			type: 1,
		  	title: "提示信息", //不显示标题
			shade: 0.5,
			btn: ['发放代金券', '取消'],
			area: ['620px', '400px'],
			skin:"up_skin_class",
			content: $(".handle_g_layer"),
			yes:function(){
				var userNames = $.trim($("#userNames").val());
				var remark = $.trim($("#remark").val());
				if(!userNames||!remark){
					$(".handle_g_layer .error_tip").removeClass("dn");
					if(!userNames){
						$("#userNames").addClass("error_border");
					}
					if(!remark){
						$("#remark").addClass("error_border");
					}
					return;
				}
				
				postPlatformCoupon(id,"EXACT_PROMO",inputLayer);
				initHandleLayer();				
			},
			cancel: function(){
				initHandleLayer();				
			}
		})
	}
	
	var postPlatformCoupon = function(id,type,layerToHandle){
		var params={
			  "couponCate": type,
			  "couponId": "",
			  "partyIds": "",
			  "remark": ""
			}
		params.couponId = id;
		params.partyIds = $.trim($("#userNames").val());
		params.remark = $("#remark").val();
		$.aAjax({
			url: postplatformCouponUrl,
			type:"POST",
			dataType: 'JSON',
			data:JSON.stringify(params),
			contentType:'application/json',
		    success: function(data) {
		    	layer.close(layerToHandle);
		    	if(data.statusId){
		    		layer.msg("<i class='icon-right-c'></i>代金券发放成功 ！", {
		    			  time: 1000,
		    			  area:['506px','140px'],
		    			  skin:"fly_skin_class"      
		    			})
		    		/* setTimeout(function(){window.location.reload();},2000); */ //重新刷新
		    	}
		    	if(data.flag){
		    		layer.msg("<i class='icon-right-c'></i>"+data.flag, {
		    			  time: 3000,
		    			  area:['506px','140px'],
		    			  skin:"fly_skin_class"      
		    			})
		    	}
		    },
		    error:function(data){
		    	if(data.status == 500 && data.responseJSON.errMsg){
		    		layer.msg("<i class='icon-right-c'></i>"+data.responseJSON.errMsg, {
		    			  time: 3000,
		    			  area:['506px','140px'],
		    			  skin:"fly_skin_class"
		    			})
		    	}
		    }
		});
		
	}
	/* 平台定向方法end */
	
	//平台卷发放，只改变状态
	var popSetCouponStatusFrame = function(id){
		var inputLayer = layer.open({
			type: 1,
		  	title: "提示信息", //不显示标题
			shade: 0.5,
			btn: ['发放代金券', '取消'],
			area: ['620px', '300px'],
			skin:"up_skin_class",
			content: "<div class='set_sending_layer'><h4><i class='icon-exclamark'></i>确定发放代金券？</h4></div>",
			yes:function(){
				setCouponReady(id,inputLayer);
			},
			cancel: function(){
				
			}
		})
	}
	
	var setCouponReady = function(id,layerToHandle){
		$.aAjax({
			url: ykyUrl.pay+"/v1/coupons/editCouponStateId?couponId="+id+"&statusId=SENDING",
			type:"POST",
			dataType: 'JSON',
			contentType:'application/json',
		    success: function(data) {
		    	layer.close(layerToHandle);
		    	if(data.code=='200'){
		    		layer.msg("<i class='icon-right-c'></i>代金券发放成功 ！", {
		    			  time: 1000,
		    			  area:['506px','140px'],
		    			  skin:"fly_skin_class"      
		    			})
		    		setTimeout(function(){window.location.reload();},2000); 
		    	}else{
		    		layer.msg("<i class='icon-right-c'></i>代金券发放失败，请重试 ！", {
		    			  time: 1000,
		    			  area:['506px','140px'],
		    			  skin:"fly_skin_class"      
		    			})
		    	}
		    },
		    error:function(e){
		    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
		    }
		});
		
	}
	/*平台代金卷活动开始 */
	var popNullFrame = function(){
		layer.msg("该代金券已领取完，如需继续发放，请联系代金券创建员修改发行量", {
			  time: 3000,
			  area:['506px','140px'],
			  skin:"fly_skin_class"      
			})
	}
	function desLen(){
		var val = $("#description")[0].value;
		$('#des')[0].innerHTML= val.length+'/100';
	}
	
    function changeSize(count){
    	showList.list.pageSize = count;
    	showList.list.pageNum = 1;
    	search.parameter.pageSize = count;
    	search.parameter.page = 1;
    	$(".condition_inquery")[0].click();
    }
    
    /* search */
    
    var getParameters = function(){
    	var arr = ["name","createDateStart","createDateEnd","thruDateStart","thruDateEnd"],
		par ={};
		
    	for(var i=0; i< arr.length; i++){
    		par[arr[i]] = decodeURI(getQueryString(arr[i]));
    	}
    	return par;
    }
    
	var search = avalon.define({
	    $id: "search",
	    parameter: getParameters(),
	    goSearch:function(){
	    	var wrap = $("#searchFrom");
	    	var inputList = wrap.find("input"),
	    		selectList = wrap.find("select"),
	    		parStr = "?",
	    		par = getQueryString("type"),
	    		parObj = {};
	    	
	    	if(par)
	    		parObj["type"] = par;
	    	
	    	function toUrl(pArr){
	    		for(var k in pArr){
	    			console.log(k)
	    			parStr += k + "=" + pArr[k] +"&";
	    		}
	    	}
	    	$.each(inputList,function(i,input){
	    		var val = input.value;
	    		if(val !== ""){
	    			parObj[input.name] = encodeURI(input.value);
	    		}
	    	})
	    	console.log(selectList)
	    	$.each(selectList,function(i,select){
	    		var val = "",
	    			selectObj = $(select,"option:selected");
	    		console.log(selectObj.val());
	    		if(selectObj.val()){
	    			parObj[select.name] = select.value;	        			
	    		}
	    	})
	    	
	    	toUrl(parObj);
	    	parStr = parStr.substring(0,parStr.length-1);
	    	
	     	var str = "?"
	    	if(parStr != ""){
	    		str = "&"
	    	}
			
	    	window.location.href=window.location.pathname+parStr+str+"page=1&size="+showList.list.pageSize;//"+showList.list.pageNum+"
	    	
	    }
	})

		var searchData = function(paramName,data){  //nType 1表示类型，2表示币种，3表示状态
			var mYRequest = GetUrlPars();
			var isUrlExist = false;
				mYRequest[paramName] = data; //do nothing
			var paramStr ='';
			var num = 0;
			for(key in mYRequest){
				if(mYRequest[key]!=''){
					if(num==0){
						paramStr+="?"+key+"="+mYRequest[key];
					}else{
						paramStr+="&"+key+"="+mYRequest[key];
					}
					num++;
				}
			}
			window.location.href= window.location.pathname+paramStr;
		}
		var  GetUrlPars=function(){
		    var url=location.search;
		    var theRequest = new Object();
		    if(url.indexOf("?")!=-1)
		    {
		       var str = url.substr(1);
		       strs = str.split("&");
		       for(var i=0;i<strs.length;i++)
		      {
		          var sTemp = strs[i].split("=");
		          theRequest[sTemp[0]]=(sTemp[1]);
		      }
		    }
		    return theRequest;
		 }
		var showList = avalon.define({
		    $id: "list",
		    list: [],
		   	isLoading:"数据加载中...",
		   	isfirst:true,
		    allchecked: false,
		    handleOutTicket:function(e){
		    	var el = $(e.target),
				id = el.data("couponid");
		    	popHandleFrame(id);
		    },
		    qtyNull:function(){
		    	popNullFrame();
		    },
		    changeStatus:function(e){
		    	var el = $(e.target),
				id = el.data("couponid");
		    	popSetCouponStatusFrame(id);
		    },
		   	audited:getQueryString("type"),
		    getAvailbleProduct:function(brandName,vendorName){
		    	if(!vendorName&&!brandName){
		    		return "全平台通用";
		    	}else if(vendorName&&brandName){
		    		return "供应商:"+vendorName+"制作商:"+brandName;
		    	}else if(vendorName&&!brandName){
		    		return "供应商:"+vendorName+"制作商：不限";
		    	}else if(!vendorName&&brandName){
		    		return "供应商:不限，"+"制作商"+showData.detail.brandName;
		    	}
		    },
	});

 	var queryPage = 0,querySize = 0;
 	if(!showList.list.pageNum){
 		queryPage = 1;
 	}else{
 		queryPage = showList.list.pageNum
 	}
 	if(!showList.list.pageSize){
 		querySize = 10;
 	}else{
 		querySize = showList.list.pageSize;
 	}
 	
 	var queryPage = getQueryString("page"),
 	querySize = getQueryString("size"),
	listPage = queryPage ? queryPage : 1,
	listSize = querySize ? querySize : 10;
 	
 	var listUrl = ykyUrl.pay+"/v1/coupons";
 	/* var listUrl = 'http://localhost:27085'+"/v1/coupons"; */
 	 
	var tempData = "";
	if(window.location.search.indexOf("?") != -1){
		tempData = "?"+window.location.search.split("?")[1];
	}else{
		tempData = "?page="+listPage+"&size="+listSize;
	}
 	 $.aAjax({
	     url: listUrl+tempData,
	     type:"GET",
	     success: function(data) {
	    	 for(var i = 0; i< data.list.length; i++){
	    		 data.list[i].checked = false;
	    	 }
	    	 if( data.list.length == 0)
		    	 	showList.isLoading = "暂无数据";
	    	 
	    	 showList.list=data;
	    	 showList.isfirst = false;
	    	 
	    	 setPageOption(data);
	    	 loadPage(window.location.pathname+GetRequestWithout(window.location.search,"page"));
	    	 
	     },
	     error:function(e){
  	    	layer.closeAll('loading');
	  	    console.log("系统错误，审批失败，请联系系统管理员："+e);
		}
	})
	
	//收款失败，输入框必填
  	function validateVal(){
  		if($("#description").val() == ""){
  			$("#description").addClass('bred');
  		}else{
  			$("#description").removeClass('bred');
  		}
  	}
	 
</script>


<script type="text/javascript">
$(function(){
		
		//日期控件
	var start = {
		elem: '#createDateStart',
		format: 'YYYY-MM-DD hh:mm:ss',
		// min: laydate.now(),    //设定最小日期为当前日期
		istime: true, //是否显示时间
		istoday: false,
		isclear: false, //是否显示清空
		//选择好日期的回调
		choose: function(dates) {
			$(this.elem).trigger("blur");
			var startTime = $('#createDateStart').val();
			var endTime = $('#createDateEnd').val();
			var arr1 = startTime.split('-');
			var sdate = new Date(arr1[0], parseInt(arr1[1] - 1), arr1[2]);
			var arr2 = endTime.split('-');
			var edate = new Date(arr2[0], parseInt(arr2[1] - 1), arr2[2]);
			if(sdate > edate) {
				layer.tips('开始时间不能大于结束时间', '#registerEnd', {
					tips: 1,
					time: 1000,
				});
				$('#registerStart').val('');
			};
		}
	};
	var end = {
		elem: '#createDateEnd',
		format: 'YYYY-MM-DD hh:mm:ss',
		// min: laydate.now(),    //设定最小日期为当前日期
		istime: true, //是否显示时间
		istoday: false,
		isclear: false, //是否显示清空
		//选择好日期的回调
		choose: function(dates) {
			$(this.elem).trigger("blur");
			var startTime = $('#createDateStart').val();
			var endTime = $('#createDateEnd').val();
			var arr1 = startTime.split('-');
			var sdate = new Date(arr1[0], parseInt(arr1[1] - 1), arr1[2]);
			var arr2 = endTime.split('-');
			var edate = new Date(arr2[0], parseInt(arr2[1] - 1), arr2[2]);
			if(sdate > edate) {
				layer.tips('开始时间不能大于结束时间', '#registerEnd', {
					tips: 1,
					time: 1000,
				});
				$('#createDateEnd').val('');
			};
		}
	};
	$("#createDateStart").on("click", function() {
		laydate(start);
	});
	$(".cc1").on("click", function() {
		laydate(start);
	});
	$("#createDateEnd").on("click", function() {
		laydate(end);
	});
	$(".cc2").on("click", function() {
		laydate(end);
	});
	
	var start2 = {
			elem: '#thruDateStart',
			format: 'YYYY-MM-DD hh:mm:ss',
			// min: laydate.now(),    //设定最小日期为当前日期
			istime: true, //是否显示时间
			istoday: false,
			isclear: false, //是否显示清空
			//选择好日期的回调
			choose: function(dates) {
				$(this.elem).trigger("blur");
				var startTime = $('#thruDateStart').val();
				var endTime = $('#thruDateEnd').val();
				var arr1 = startTime.split('-');
				var sdate = new Date(arr1[0], parseInt(arr1[1] - 1), arr1[2]);
				var arr2 = endTime.split('-');
				var edate = new Date(arr2[0], parseInt(arr2[1] - 1), arr2[2]);
				if(sdate > edate) {
					layer.tips('开始时间不能大于结束时间', '#lastLoginEnd', {
						tips: 1,
						time: 1000,
					});
					$('#thruDateStart').val('');
				};
			}
		};
		var end2 = {
			elem: '#thruDateEnd',
			format: 'YYYY-MM-DD hh:mm:ss',
			// min: laydate.now(),    //设定最小日期为当前日期
			istime: true, //是否显示时间
			istoday: false,
			isclear: false, //是否显示清空
			//选择好日期的回调
			choose: function(dates) {
				$(this.elem).trigger("blur");
				var startTime = $('#thruDateStart').val();
				var endTime = $('#thruDateEnd').val();
				var arr1 = startTime.split('-');
				var sdate = new Date(arr1[0], parseInt(arr1[1] - 1), arr1[2]);
				var arr2 = endTime.split('-');
				var edate = new Date(arr2[0], parseInt(arr2[1] - 1), arr2[2]);
				if(sdate > edate) {
					layer.tips('开始时间不能大于结束时间', '#thruDateEnd', {
						tips: 1,
						time: 1000,
					});
					$('#thruDateEnd').val('');
				};
			}
		}; 
  		$("#thruDateStart").on("click", function() {
			laydate(start2);
		});
		$(".cc3").on("click", function() {
			laydate(start2);
		});
		$("#thruDateEnd").on("click", function() {
			laydate(end2);
		});
		$(".cc4").on("click", function() {
			laydate(end2);
		});
		
		$("#status").selectmenu()
		.selectmenu( "menuWidget" )
	    .addClass( "overflow" );
		
		$("#userNames").blur(function(){
			var val = $.trim($(this).val())
			if(val){
				$(this).removeClass("error_border");
			}
		})
		
		$("#remark").blur(function(){
			var val = $.trim($(this).val())
			if(val){
				$(this).removeClass("error_border");
			}
		})		
	});
function initHandleLayer(){
	$(".handle_g_layer .error_tip").addClass("dn");
	$("#userNames").val("");
	$("#remark").val("");
	$("#userNames").removeClass("error_border");
	$("#remark").removeClass("error_border");
}
</script>
<script>
	
</script>
</body>
</html>
