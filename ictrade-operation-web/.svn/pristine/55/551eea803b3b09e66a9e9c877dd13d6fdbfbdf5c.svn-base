
/*定义vue对象*/
var app = new Vue({
	el: '#personUp',
	data: {
		//基础数据
		baseData: {
			corCategoryList: [],	//公司类型
			industryList: [],	//行业类型
			positionList:[{"id":"buyer","name":"采购员"},{"id":"purchasingManager","name":"采购经理"},{"id":"engineer","name":"工程师"},{"id":"other","name":"其他"}],//职业列表
		},
		companyInfo: {
			companyName: '',	//公司名称
			corCategory: '',	//公司类型
			corCategoryOther: '', //公司类型-其他
			industryCategory: [],	//所属行业
			otherArr: '',	//其他行业
			provinceId: '',	//省ID
			cityId: '',		//市ID
			countryId: '',	//县ID
			province: '',	//省
			city: '',	//市
			country: '',	//县
			address: '',	//详细地址
			dCode: '',	//邓氏编码
			webSite: ''	//公司网站
		},
		//企业资质
		qual: {
			regAddr: '',	//公司注册地
			busilisType: '',	//资质类型
			busilisPic: '',		//营业执照 | 注册证书(CR) | 盈利事業登記證 | CERTIFICATE OF INCORPORATION
			oocPic: '',			//组织机构代码
			taxregPic: '',		//税务登记 |  香港（商业登记证(BR)：） | 台湾（稅籍登記證）
			busiPdfName: '',	
			occPdfName: '',
			taxPdfName: ''
		},
		//联系人信息
		contacts: {
			name: '',	//联系人姓名
			mobile: '',	//手机号码
			mail: '',	//邮箱
			qq: '',		//QQ
			personalTitle: '',	//职位
			contactAddress: '',	//联系地址
			fixedTel: ''	//固定电话
		},
		logInfo: {
			reason: '',		//修改说明
			comments: ''	//客服备注
		}
	},
	methods: {
		//选择行业	
		selectIndustry: function(e) {
			var $target = $(e.target);
			var curIndustryId = $target.closest('.check-box-white').attr('data-value');
			var index;
			
			$target.closest('.check-box-white').toggleClass('check-box-red');
			
			//选中行业
			if($target.closest('.check-box-white').hasClass('check-box-red')) {
				app.companyInfo.industryCategory.push(curIndustryId);
			}else {
				index = app.companyInfo.industryCategory.indexOf(curIndustryId);
				app.companyInfo.industryCategory.splice(index, 1);
				 
				if(curIndustryId == '1008') {
					app.companyInfo.otherArr = '';
				}
			}
			
			if(curIndustryId == '1008') {
				$target.parents('.company_type').find('.rel').toggle();
			}
		},
		//保存信息
		saveInfo: function() {
			var valid = $('#infoForm').valid();
			
			if(!valid) return;
			
			//公司类型
			if($('#corCategory').val()=='') {
				layer.msg('公司类型不能为空');
				return;
			}
			
			//校验行业
			if(this.companyInfo.industryCategory.length == 0) {
				layer.msg('所属行业不能为空');
				return;
			}
			
			//校验资质信息
			if($('.BUSI_LIC_PIC').size() > 0) {
				if($('.BUSI_LIC_PIC').attr('src') == '') {
					layer.msg('资质信息不能为空！')
					return;
				}
			}
			
			if($('.TAX_REG_PIC').size() > 0) {
				if($('.TAX_REG_PIC').attr('src') == '') {
					layer.msg('资质信息不能为空！')
					return;
				}
			}
			
			if($('.OCC_PIC').size() > 0) {
				if($('.OCC_PIC').attr('src') == '') {
					layer.msg('资质信息不能为空！')
					return;
				}
			}
			
			//校验注册地址
			var province = $('#address-ld .province li.selected').attr('data-id');
			var city = $('#address-ld .city li.selected').attr('data-id');
			var country = $('#address-ld .county li.selected').attr('data-id');
			
			if(!(province && city && country)) {
				layer.msg('注册地址必填！');
				return;
			}
			
			//校验联系地址
			var personProvince = $('#contacts-ld .province li.selected').attr('data-id');
			var personCity = $('#contacts-ld .city li.selected').attr('data-id');
			var personCountry = $('#contacts-ld .county li.selected').attr('data-id');
			
			if(!(personProvince && personCity && personCountry)) {
				layer.msg('联系地址必填！');
				return;
			}
			
			save();
		}
	}
})

//初始化
function init() {
	
	//获取公司类型基础数据
	getCorCategoryList();
	
	//获取行业类别基础数据
	getIndustryList();
	
	//根据用户ID查询用户姓名
	getUserName();
	
	//tag: 公共组件中的单选失效，重新加上交互
	$('.radio-item input').on('change', function() {
		$(this).next('.radio').toggleClass('radio-selected');
		$(this).parent().siblings('.radio-item').find('.radio').toggleClass('radio-selected');
	})
	
	//三证
	zzRenzheng.init('#qual', {
		type: "0",
		busilisType: '',
		imgSrc: {
			BUSI_LIC_PIC: "", //营业执照影印件(大陆)  /  注册证书(香港)
			TAX_REG_PIC: "", //税务登记证影印件(大陆) / 商业登记证(香港)
			OCC_PIC: "", //组织结构代码影印件(大陆)
			BUSI_PDF_NAME: "",
			TAX_PDF_NAME: "",
			OCC_PDF_NAME: ""
		},
		fileMaxSize:  5
	});
	
	//公司地址
	try {
		selectArea.init('#address-ld', {});
	}catch(e){}
	
	//联系地址
	try {
		selectArea.init("#contacts-ld", {});
	}catch(e){}
	
	
	//拉取联系人信息
	loadContacts();
	
	//事件
	bindEvent();
	
	//表单校验
	formValidate();
}

//获取公司类型
function getCorCategoryList() {
	$.ajax({
		url: ykyUrl.database + '/v1/category/companytype',
		type: 'GET',
		success: function(data) {
			app.baseData.corCategoryList = data;
		}
	});
}

//获取行业类别
function getIndustryList() {
	$.ajax({
		url: ykyUrl.database + '/v1/category/industry',
		type: 'GET',
		success: function(data) {
			app.baseData.industryList = data;
		}
	})
}

//根据用户ID查询用户姓名
function getUserName(){	
	$.aAjax({
		url: ykyUrl.party + '/v1/customers/'+ $('#applyUserId').val() +'/username',
		type: 'GET',
		async: false,
		success: function(data) {
			if(data) {
				$("#contactUserName").val(data.lastNameLocal);
				$("#contactUserMail").val(data.mail);				
			}
		}
	})
}
//事件绑定
function bindEvent() {
	initCorCategory();
	initPersonalTitle();
}

//初始化公司类型列表
function initCorCategory() {
	$("#corCategory").selectmenu({
		width: 250,
		change: function() {
			app.companyInfo.corCategory = this.value;
			
			//公司类型-其他
			if(this.value == 2006) {
				$('#corCategory').parents('.row').next().show();
			}else {
				$('#corCategory').parents('.row').next().hide();
			}
			$('#corCategoryOther').val('');
			$('#corCategoryOther').valid();
		},
		close: function() {
			$(this).trigger("blur");
		}
	}).selectmenu("menuWidget")
	.addClass("overflow");
}

//初始化职位
function initPersonalTitle(){
	$("#personalTitle").selectmenu({
		width: 150,
		change: function() {
			app.contacts.personalTitle = this.value;
		},
		close: function() {
			$(this).trigger("blur");
		}
	}).selectmenu("menuWidget").addClass("overflow");
}

//拉取联系人信息
function loadContacts() {
	$.aAjax({
		url:  ykyUrl.party + '/v1/customers/' + getQueryString('id'),
		type: 'GET',
		success: function(data) {
			data = data || {};
			app.contacts = {
				name: data.name || '',
				mobile: data.telNumber || '',
				mail: data.mail || '',
				qq: data.qq || '',	
				personalTitle: data.personalTitle || '',
				contactAddress: data.address || '',
				fixedTel: data.fixedTel || ''
			}
			
			//职位
			if(data.personalTitle) {
				$('#personalTitle').val(data.personalTitle);
				$('#personalTitle').selectmenu('refresh');
			}
			
			//渲染地区
			if(data.province) {
				selectArea.init("#contacts-ld",{
					provinceId: data.province ? data.province : '', 
					cityId: data.city ? data.city : '', 
					countyId: data.country ? data.country : ''
				});
			}
		},
		error: function(e) {
			console.error('系统错误，请联系管理员,错误代码： ' + e.responseText);
		}
	})
}

//表单验证
function formValidate() {
	$("#infoForm").validate({
		rules: {
			Entname: {//公司名称
				required: true,
				rangelength: [4, 50]
			},
			Entaddress: {//公司地址
				required: true,			
			},
			name: {//联系人姓名
				required: true,
				username: [""]
			},
			mobile:{//联系人手机号
				required: true,
				addrMobileCheck:['']
			},
			mail:{//联系人邮箱
				required: true,
				addrMailCheck:[''],
				existAcount2:['一个邮箱只能关联一个企业，该邮箱已有关联企业，请重新填写']
			},
			address: {//联系人地址
				required: true
			},
			webSite: {//公司官网
				validWebSite: [""]
			},
			fax: {//传真
				isFax: [""]
			},
			qq: {
				isqq: [""]
			},
			fixedTel: {
				required: false,
				maxlength: 17,
				isPhone: [""]
			},
			otherAttr: {
				required: true
			},
			reason: {
				required: true
			},		
			corCategory:{
				required: true
			},
			corCategoryOther:{ //公司类型-其他
				required: function() {
					return $('#corCategory').val() == 2006;
				},
				corCategoryOther: [""]
			} 
		},
		messages: {
			Entname: {//公司名称
				required: '公司名称不能为空',
				rangelength:'公司名称长度只能在4-50位字符之间'
			},
			Entaddress: {//公司地址
				required: '公司地址不能为空',			
			},
			name: {//联系人姓名
				required: '联系人姓名不能为空',
			},
			mobile:{//联系人手机号
				required: '联系人手机号码不能为空',
			},
			mail:{//联系人邮箱
				required: '联系人邮箱不能为空',
			},
			address: {//联系人地址
				required: '联系人地址不能为空'
			},	
			fixedTel: {
				maxlength: '固定电话不能超过17位'
			},
			otherAttr: {
				required: "不能为空"
			},
			reason: {
				required: "修改原因不能为空"
			},
			corCategory:{
				required: "请选择公司类型"
			},
			corCategoryOther: {
				required: "公司类型不能为空"
			}
		},
		errorElement: "em",
		success: function(label) {
			$(label).removeClass("error icon-triangle-leftmin");
			$(label).addClass("icon-confirm");
			if ($(label).parent().find('input').val() === '') {
				$(label).removeClass("icon-confirm");
			}
		},
		errorPlacement: function(error, element) {
			var f = error[0].getAttribute("for");
			var ele = $("em[for=" + f + "]");
			if (ele.length > 0) {
				ele[0].remove();
			}
			error.appendTo(element.parent());
			$(error).addClass("error icon-triangle-leftmin");
		}
	});
}

//保存
function save() {
	
	//获取资质类型
	var REG_ADDR = $('.qual-type > span').data('id');
	var BUSI_LIS_TYPE = (function(reg_addr) {
		var returnVal = '';
		var dalu_type = $('.dalu_type .radio-selected').data('name');
		
		switch(reg_addr + '') {
			case '0':
				returnVal = dalu_type;
				break;
			case '1':
				returnVal = 'HK-CODE';
				break;
			case '2':
				returnVal = 'TW-CODE';
				break;
			case '3':
				returnVal = 'ABROAD-CODE';
				break;
		}
		
		return returnVal;
		
	})(REG_ADDR);
	
	var content = {
			id : getQueryString('id'),
			entUserId: getQueryString('id'),
			isVipCenter: '0',
			name: app.companyInfo.companyName,
			corCategory: app.companyInfo.corCategory,
			industryCategory: app.companyInfo.industryCategory.join(','),
			otherAttrs: [{
				'INDUSTRY_CATEGORY_ID_OTHER': $('#otherAttr').val(),
				'CORPORATION_CATEGORY_ID_OTHER' : $('#corCategoryOther').val()
			}],
			province: $('#address-ld .province li.selected').attr('data-id'),
			"provinceName": $('#address-ld .province li.selected').text(),
			city: $('#address-ld .city li.selected').attr('data-id'),
			"cityName": $('#address-ld .city li.selected').text(),
			country: $('#address-ld .county li.selected').attr('data-id'),
			"countryName": $('#address-ld .county li.selected').text(),
			address: app.companyInfo.address,
			webSite: app.companyInfo.webSite,
			dCode: app.companyInfo.dCode,
			personalTitle: app.contacts.personalTitle,
			contactUserTel: app.contacts.mobile,
			mail: app.contacts.mail,
			contactUserQQ: app.contacts.qq,
			personProvince: $('#contacts-ld .province li.selected').attr('data-id'),
			personProvinceName: $('#contacts-ld .province li.selected').text(),
			personCity: $('#contacts-ld .city li.selected').attr('data-id'),
			personCityName: $('#contacts-ld .city li.selected').text(),
			personCountry: $('#contacts-ld .county li.selected').attr('data-id'),
			personCountryName: $('#contacts-ld .county li.selected').text(),
			personAddress: app.contacts.contactAddress,
			"comments": app.logInfo.comments,
			mail:$("#mail").val(),
			contactUserName:$("#contactUserName").val(),
	        "fixedTel": $("#fixedTel").val(),
			map: {
				REG_ADDR: $('.qual-type > span').attr('data-id'),
				BUSI_LIS_TYPE: BUSI_LIS_TYPE,
				BUSI_LIC_PIC: $('.BUSI_LIC_PIC').attr('data-src'),
				OCC_PIC: $('.OCC_PIC').attr('data-src'),
				TAX_REG_PIC: $('.TAX_REG_PIC').attr('data-src'),
				BUSI_PDF_NAME: $('.BUSI_LIC_PIC').attr('data-pdfname'),
				TAX_PDF_NAME: $('.TAX_REG_PIC').attr('data-pdfname'),
				OCC_PDF_NAME: $('.OCC_PIC').attr('data-pdfname')
			},
			"applyUser":$("#name").val(),//联系人
			"applyMail":$("#mail").val(),//联系人邮箱
			"applyInformation":$("#mobile").val(),//联系方式
	}

	var jsonVal = {
		"applyContent":JSON.stringify(content),
		"applyUserId": getQueryString('id'),
		"processId":"ORG_DATA_REVIEW",
		"reason": app.logInfo.reason,
		"applyPageUrl":"",
		"applyOrgId": '',
		"callBackUrl": ''
	};
	
	$.aAjax({
		url: ykyUrl.party + '/v1/enterprises/editEntApply',
		type: 'POST',
		data: JSON.stringify(jsonVal),
		success: function(data) {
			$('#infoSuc').show();
			setTimeout(function() {
				location.href = ykyUrl._this + '/enterprise/customers.htm';	
			}, 1000);
		},
		error: function(e) {
			console.error('系统错误，请联系管理员，错误代码： ' + e.responseText);
		}
	})
}

init();
