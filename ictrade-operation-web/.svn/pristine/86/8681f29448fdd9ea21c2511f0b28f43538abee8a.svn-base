var getParameters = function() {

	var arr = ["mail", "contactUserName", "contactUserTel", "name", "status", "verifyStatus", "accountsStatus", "registerStart", "registerEnd",
			"lastLoginStart", "lastLoginEnd"
		],
		par = {};

	for (var i = 0; i < arr.length; i++) {
		par[arr[i]] = decodeURI(getQueryString(arr[i]));
	}
	return par;
};

var search = avalon.define({
	$id: "search",
	parameter: getParameters(),
	goSearch: function() {
		var wrap = $("#searchFrom");
		var inputList = wrap.find("input"),
			selectList = wrap.find("select"),
			parStr = "?",
			par = getQueryString("type"),
			parObj = {};

		if (par)
			parObj["type"] = par;

		function toUrl(pArr) {
			for (var k in pArr) {
				parStr += k + "=" + pArr[k] + "&";
			}
		}
		$.each(inputList, function(i, input) {
			var val = input.value;
			if (val !== "") {
				parObj[input.name] = encodeURI(input.value);
			}
		});
		$.each(selectList, function(i, select) {
			var val = "",
				selectObj = $(select, "option:selected");
			console.log(selectObj.val());
			if (selectObj.val()) {
				parObj[select.name] = select.value;
			}
		});

		toUrl(parObj);
		parStr = parStr.substring(0, parStr.length - 1);

		var str = "?";
		if (parStr !== "") {
			str = "&";
		}

		window.location.href = window.location.pathname + parStr + str +
			"page=1&size=" + showList.list.pageSize;

	}
});

var showList = avalon.define({
	$id: "list",
	list: [],
	isLoading: "数据加载中...",
	isfirst: true,
	allchecked: false,
	audited: getQueryString("type"),

	//导出全部
	exportExcels: function() {
		var date_url = ykyUrl._this + "/enterprise/excel.htm" + window.location.search;
		var form = $("#exportForm"); //定义一个form表单
		form.attr("action", date_url);
		form.submit(); //表单提交
	},
	frozenAccount:function(mail,id,status){
		var mail = mail ? mail : '';
		var partyStatus = status=='PARTY_ENABLED'?'PARTY_DISABLED':'PARTY_ENABLED';
		layer.confirm(status =='PARTY_ENABLED'?'确定冻结  '+ mail +'?' : '确定取消冻结  '+ mail +'?',{
			offset: "auto",
			closeBtn: false,
			btn: ['确      定','取      消'], //按钮
			title: " "/*status =='PARTY_ENABLED'?'冻结':'取消冻结'*/,
			area: 'auto',			
			move: false,
			skin: "up_skin_class",
			yes:function(){
				$.aAjax({
					url:ykyUrl.party + '/v1/customers/frozen?accountId=' + id + '&partyStatus=' + partyStatus,
					type:'POST',
					success:function(data){
						location.reload();
					},
					error:function(res){
						layer.msg("网络异常，请稍后重试！");
					}
				})
			}
		})				
	}
});

function changeSize(count){
	showList.list.pageSize = count;
	showList.list.pageNum = 1;
	search.parameter.pageSize = count;
	search.parameter.page = 1;
	$(".condition_inquery")[0].click();
}
var queryPage = 0,
	querySize = 0;
if (!showList.list.pageNum) {
	queryPage = 1;
} else {
	queryPage = showList.list.pageNum;
}
if (!showList.list.pageSize) {
	querySize = 10;
} else {
	querySize = showList.list.pageSize;
}
queryPage = getQueryString("page");
querySize = getQueryString("size");
listPage = queryPage ? queryPage : 1;
listSize = querySize ? querySize : 10;
var listUrl = ykyUrl.party + "/v1/enterprises";
var tempData = "";
if (window.location.search.indexOf("?") != -1) {
	tempData = "?" + window.location.search.split("?")[1];
} else {
	tempData = "?page=" + listPage + "&size=" + listSize;
}
$.aAjax({
	url: listUrl + tempData, //+window.location.search,
	success: function(data) {
		if (data.list.length === 0)
			showList.isLoading = "暂无数据";

		showList.list = data;
		showList.isfirst = false;
		setPageOption(data);
		loadPage(window.location.pathname + GetRequestWithout(window.location.search,
			"page"));

		//获取公司类型
		$.aAjax({
			url: ykyUrl.database + '/v1/category/companytype',
			type: 'GET',
			async: false,
			success: function(data) {
				var oldArr = showList.list.list;

				for (var i = 0; i < oldArr.length; i++) {
					for (var j = 0; j < data.length; j++) {
						if (oldArr[i].corCategory == data[j].categoryId) {
							showList.list.list[i].corCategory = data[j].categoryName;
							break;
						}
					}
				}
			}
		});
	}
});

$(function(){

  	//判断开始时间和结束时间   申请时间

  		$("#registerStart, .cc1").on("click",function(){
  		    laydate(start);
  		}); 		
  		$("#registerEnd, .cc2").on("click",function(){
  		    laydate(end);
  		});

  		
  		 var start = {
  		        elem: '#registerStart',
  		        format: 'YYYY-MM-DD',
  		       // min: laydate.now(),    //设定最小日期为当前日期
  		        istime: false,    //是否显示时间
  		        istoday: false,
  		        isclear: false,   //是否显示清空
  		        //选择好日期的回调
  		        choose: function(dates){ 
  		            $(this.elem).trigger("blur");
  		            var startTime = $('#registerStart').val();
  		       	    var createdateEnd = $('#registerEnd').val();
  		       	    var arr1 = startTime.split('-');
  		       	    var sdate=new Date(arr1[0],parseInt(arr1[1]-1),arr1[2]);
  		       	    var arr2 = createdateEnd.split('-');
  		       	    var edate=new Date(arr2[0],parseInt(arr2[1]-1),arr2[2]);
  		       	    if(sdate > edate){
  		       			layer.tips('开始时间不能大于结束时间', '#registerStart',{
  		       				tips: 1,
  		     				time: 1000,
  		       			});
  		       			$('#registerStart').val('');
  		       		};
  		        }
  		    };
  		 var end = {
  		      elem: '#registerEnd',
  		      format: 'YYYY-MM-DD',
  		      // min: laydate.now(),    //设定最小日期为当前日期
  		      istime: false,    //是否显示时间
  		      istoday: false,
  		      isclear: false,   //是否显示清空
  		      //选择好日期的回调
  		      choose: function(dates){ 
  		          $(this.elem).trigger("blur");
  		          var startTime = $('#registerStart').val();
  		     	  var createdateEnd = $('#registerEnd').val();
  		     	  var arr1 = startTime.split('-');
  		     	  var sdate=new Date(arr1[0],parseInt(arr1[1]-1),arr1[2]);
  		     	  var arr2 = createdateEnd.split('-');
  		     	  var edate=new Date(arr2[0],parseInt(arr2[1]-1),arr2[2]);
  		     	  if(sdate > edate){
  		     			layer.tips('开始时间不能大于结束时间', '#registerEnd',{
  		     				tips: 1,
  		     				time: 1000,
  		     			});
  		     			$('#registerEnd').val('');
  		     		};
  		      }
  		 };  		 
  		 //判断开始时间和结束时间
  		 $('#search_all').on('click',function(){
  			var startTime = $('#registerStart').val();
  			var createdateEnd = $('#registerEnd').val();
  			//日期格式转换
  			var reg = /^(?:(?!0000)[0-9]{4}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29)$/;
  			var arr1 = startTime.split('-');
  			var sdate=new Date(arr1[0],parseInt(arr1[1]-1),arr1[2]);
  			var arr2 = createdateEnd.split('-');
  			var edate=new Date(arr2[0],parseInt(arr2[1]-1),arr2[2]);
  			if(startTime == '' && createdateEnd == ''){
  		
  			}else if(startTime == '' && createdateEnd){
  				 layer.open({
  					    title: '信息',
  				        type: 1,
  				        area: ['260px', '160px'],
  				        shadeClose: true, //点击遮罩关闭
  				        content: '\<\div style="padding-top: 50px;padding-left: 80px;";>请填写开始时间\<\/div>'
  				    });
  				 return false;
  			}else if(startTime && createdateEnd == ''){
  			
  			}else if(!reg.test(startTime) || !reg.test(createdateEnd)){
  				layer.open({
  				    title: '信息',
  			        type: 1,
  			        area: ['260px', '160px'],
  			        shadeClose: true, //点击遮罩关闭
  			        content: '\<\div style="padding-top: 50px;padding-left: 80px;";>时间格式不正确\<\/div>'
  			    });
  			}else{

  			}
  		 });
  		 
		$("#status").selectmenu()
  		.selectmenu( "menuWidget" )
  	    .addClass( "overflow" );
		$("#verifyStatus").selectmenu()
  		.selectmenu( "menuWidget" )
  	    .addClass( "overflow" );
		$("#accountsStatus").selectmenu()
  		.selectmenu( "menuWidget" )
  	    .addClass( "overflow" );
  	});



  	 //判断开始时间和结束时间    审核时间

  	  		$("#lastLoginStart, .cc3").on("click",function(){
  	  		    laydate(start2);
  	  		});  		
  	  		$("#lastLoginEnd, .cc4").on("click",function(){
  	  		    laydate(end2);
  	  		});	
  	  		
  	  		var start2 = {
  	  		        elem: '#lastLoginStart',
  	  		        format: 'YYYY-MM-DD',
  	  		       // min: laydate.now(),    //设定最小日期为当前日期
  	  		        istime: false,    //是否显示时间
  	  		        istoday: false,
  	  		        isclear: false,   //是否显示清空
  	  		        //选择好日期的回调
  	  		        choose: function(dates){ 
  	  		            $(this.elem).trigger("blur");
  	  		            var startTime = $('#lastLoginStart').val();
  	  		       	    var createdateEnd = $('#lastLoginEnd').val();
  	  		       	    var arr1 = startTime.split('-');
  	  		       	    var sdate=new Date(arr1[0],parseInt(arr1[1]-1),arr1[2]);
  	  		       	    var arr2 = createdateEnd.split('-');
  	  		       	    var edate=new Date(arr2[0],parseInt(arr2[1]-1),arr2[2]);
  	  		       	    if(sdate > edate){
  	  		       			layer.tips('开始时间不能大于结束时间', '#lastLoginStart',{
  	  		       				tips: 1,
  	  		     				time: 1000,
  	  		       			});
  	  		       			$('#lastLoginStart').val('');
  	  		       		};
  	  		        }
  	  		    };

  	  		 
  	  		 var end2 = {
  	  		      elem: '#lastLoginEnd',
  	  		      format: 'YYYY-MM-DD',
  	  		      // min: laydate.now(),    //设定最小日期为当前日期
  	  		      istime: false,    //是否显示时间
  	  		      istoday: false,
  	  		      isclear: false,   //是否显示清空
  	  		      //选择好日期的回调
  	  		      choose: function(dates){ 
  	  		          $(this.elem).trigger("blur");
  	  		          var startTime = $('#lastLoginStart').val();
  	  		     	  var createdateEnd = $('#lastLoginEnd').val();
  	  		     	  var arr1 = startTime.split('-');
  	  		     	  var sdate=new Date(arr1[0],parseInt(arr1[1]-1),arr1[2]);
  	  		     	  var arr2 = createdateEnd.split('-');
  	  		     	  var edate=new Date(arr2[0],parseInt(arr2[1]-1),arr2[2]);
  	  		     	  if(sdate > edate){
  	  		     			layer.tips('开始时间不能大于结束时间', '#lastLoginStart',{
  	  		     				tips: 1,
  	  		     				time: 1000,
  	  		     			});
  	  		     			$('#lastLoginEnd').val('');
  	  		     		};
  	  		      }
  	  		 };
  	  		 
  	  		 //判断开始时间和结束时间
  	  		 $('#search_all').on('click',function(){
  	  			var startTime = $('#lastLoginStart').val();
  	  			var createdateEnd = $('#lastLoginEnd').val();
  	  			//日期格式转换
  	  			var reg = /^(?:(?!0000)[0-9]{4}-(?:(?:0[1-9]|1[0-2])-(?:0[1-9]|1[0-9]|2[0-8])|(?:0[13-9]|1[0-2])-(?:29|30)|(?:0[13578]|1[02])-31)|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)-02-29)$/;
  	  			var arr1 = startTime.split('-');
  	  			var sdate=new Date(arr1[0],parseInt(arr1[1]-1),arr1[2]);
  	  			var arr2 = createdateEnd.split('-');
  	  			var edate=new Date(arr2[0],parseInt(arr2[1]-1),arr2[2]);
  	  			if(startTime == '' && createdateEnd == ''){
  	  		
  	  			}else if(startTime == '' && createdateEnd){
  	  				 layer.open({
  	  					    title: '信息',
  	  				        type: 1,
  	  				        area: ['260px', '160px'],
  	  				        shadeClose: true, //点击遮罩关闭
  	  				        content: '\<\div style="padding-top: 50px;padding-left: 80px;";>请填写开始时间\<\/div>'
  	  				    });
  	  				 return false;
  	  			}else if(startTime && createdateEnd == ''){
  	  			
  	  			}else if(!reg.test(startTime) || !reg.test(createdateEnd)){
  	  				layer.open({
  	  				    title: '信息',
  	  			        type: 1,
  	  			        area: ['260px', '160px'],
  	  			        shadeClose: true, //点击遮罩关闭
  	  			        content: '\<\div style="padding-top: 50px;padding-left: 80px;";>时间格式不正确\<\/div>'
  	  			    });
  	  			}else{

  	  			}
  	  		 });
