var couponData = avalon.define({
	$id:"data",
	data:{
	  "name": "",
	  "couponCurrency": "CNY", //默认RMB
	  "totalQty": "",
	  "unitAmount": "",
	  "couponText": "",
	  "thruTypeId": "EXACT_DATE_ZONE",  //默认限时使用
	  "couponCate": "PLATFORM_PROMO",  //默认平台
	  "couponPartyType": "UNLIMIT",
	  "couponMethodType": "FREE_WGET",
	  "consumeLimitAmount": "",
	  "approvedProof": "",
	  "vendorId": "",
	  "vendorName":"",
	  "brandId": "",
	  "brandName":"",
	  "fromDate": "",   
	  "thruDate": "",
	  "limitMonth": ""
	},
	logList:[],
    logListNull:false,
	yetAnotherData:{
	  "name": "",
	  "couponCurrency": "CNY", //默认RMB
	  "totalQty": "",
	  "unitAmount": "",
	  "couponText": "",
	  "thruTypeId": "EXACT_DATE_ZONE",  //默认限时使用
	  "couponCate": "PLATFORM_PROMO",  //默认平台
	  "couponPartyType": "UNLIMIT",
	  "couponMethodType": "FREE_WGET",
	  "consumeLimitAmount": "",
	  "approvedProof": "",
	  "vendorId": "",
	  "vendorName":"",
	  "brandId": "",
	  "brandName":"",
	  "fromDate": "",   
	  "thruDate": "",
	  "limitMonth": ""
	},
	action:"",
	showBigImage:function(){
		if($('.big_img').attr("src")!=''){
			layer.open({
				  type: 1,
				  title: false,
				  closeBtn: 0,
				  area: ['800px', '500px'],
				  offset: '100px',
				  shadeClose: true,
				  content: $('.big_img')
			});
		}
	},
	changeQty:function(){
		couponData.yetAnotherData.totalQty = couponData.data.totalQty;
		var couponId = getQueryString("id");
		if(couponData.data.totalQty>databaseTotalQty){
			popChangeQtyFrame(couponId);
		}else{
			layer.msg('发行量不能小于上一次的'+databaseTotalQty+'张', {offset: '300px',icon: 2});
		}
		
	}
	
});
couponData.$watch("data.totalQty",function(a,b){
    /*console.log("totalQty","新值："+a,"旧值："+b);*/
    if(a!==b){
    	var temp = a;
		couponData.data.totalQty= temp.replace(/\D/g,'');
    }
});
var popChangeQtyFrame = function(id){
	var num = couponData.data.totalQty;
	var inputLayer = layer.open({
		type: 1,
	  	title: "提示信息", //不显示标题
		shade: 0.5,
		btn: ['确定', '取消'],
		offset: '300px',
		area: ['620px', '300px'],
		skin:"up_skin_class",
		content: "<div class='layer_cont'><p>确定将发行量修改为<span>"+num+"</span>张吗？</p></div>",
		yes:function(){
			changeTotalQty(id,num,inputLayer);
		},
		cancel: function(){
			
		}
	})
}

var changeTotalQty = function(id,total,inputLayer){
	var param ={
		"couponId": id,
		"totalQty": total
	}
	$.aAjax({
		url: ykyUrl.pay + "/v1/coupons/updateTotalQtyById?couponId="+id+"&totalQty="+total,
     	type:"POST",
     	data:JSON.stringify(param),
     	dataType:"json",
     	success: function(data) {
     		if(data.code=='200'){
     			layer.close(inputLayer);
     			layer.msg("<i class='icon-right-c'></i>代金券总发行量修改成功 ！", {
	    			  time: 1000,
	    			  offset: '300px',
	    			  area:['506px','140px'],
	    			  skin:"fly_skin_class"      
	    			})
	    		setTimeout(function(){window.location.reload();},2000); //重新刷新
     		}
     	},
	    error:function(e){
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
 	});
}
var getPrivateUrl =  function(dataParam){
	var temp = dataParam;
	$.aAjax({
		url: ykyUrl.party + "/v1/enterprises/getImgUrl",
     	type:"POST",
     	data:JSON.stringify({"id":temp.approvedProof}),
     	success: function(data) {
     		if(null !=data || data == ""){
     			temp.approvedProof = data;
     			couponData.data = temp;
         		couponData.yetAnotherData = temp;
     		}
     	},
     	error:function(e){
     		couponData.data = temp;
     		couponData.yetAnotherData = temp;
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
 	});
}
var getDetail = function(id,action){
	var detailUrl = ykyUrl.pay+"/v1/coupons/detail/"+id;
	$.aAjax({
		url: detailUrl,
		type:"GET",
	    success: function(data) {
	    	if(data){
		    	couponData.action = action;
		    	getPrivateUrl(data);
	    		databaseTotalQty = data.totalQty;
	    	}
	    },
	    error:function(e){
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
	});
}

/*获取日志*/
var getLogList = function(id){
	var logListUrl = ykyUrl.pay+"/v1/coupons/getCouponStatusList/"+id+"?actionName=EDIT";
	$.aAjax({
		url: logListUrl,
		type:"GET",
	    success: function(data) {
	    	couponData.logList = data;
	    	if(data.length>0){
	    		couponData.logListNull = true;
	    	}
	    },
	    error:function(e){
	    	console.log("系统错误，审批失败，请联系系统管理员："+e.responseText);
	    }
	});
}
var initUI = function(id,action){
	if("edit"==action){
		$(document).attr("title","编辑代金券页");
	}else if("examine"==action){
		$(document).attr("title","修改代金券页");
	}
	if(id){
		getDetail(id,action);
		getLogList(id);
	}else{
		console.log("id为空,系统错误，审批失败，请联系系统管理员：");
	}
}
$(function(){
	var databaseTotalQty;
	var id = getQueryString("id");
	var action = getQueryString("action");
	initUI(id,action);
})