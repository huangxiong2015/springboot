
function reImg(i) {
	var picType = '';
	reSizeImg($('#showImg' + i).get(0));
	reSizeImg($('#c' + i).get(0));

	//判断上传文件是否是PDF
	picType = $('#uploadImg' + i).data('type');
	detailList.picsList[picType] = $('#uploadImg' + i).attr('data-urlPreview');
	if ($('#uploadImg' + i).attr('data-url').indexOf('.pdf') != -1) {
		detailList.picsList[picType + 'Pdf_NAME'] = $('#uploadImg' + i).attr(
			'data-pdfName');
		detailList.picsList[picType + 'Pdf_NAME'] = $('#uploadImg' + i).attr(
			'data-pdfName');
		detailList.picsList[picType + 'Pdf'] = true;
	} else {
		detailList.picsList[picType + 'Pdf'] = false;
	}

	$('#' + picType + 'Save').val($('#uploadImg' + i).attr('data-url'));
}

//从mogodb获取的数据，私有图片需转换 add by helinmei
function getImage(imageUrl) {

	var url = imageUrl ? imageUrl : '';
	//获取图片公共方法
	$.aAjax({
		url: ykyUrl.party + "/v1/enterprises/getImgUrl",
		type: "POST",
		async: false,
		data: JSON.stringify({
			"id": imageUrl
		}),
		success: function(data) {
			if (data !== "") {
				url = data;
			}
		}
	});
	return url;
}


$(function() {
	$("#accountManagement .ck-btn").on("click",function(){
		showVoucherPic('locPicSample');
		reSizeImg($("#locPicSample").get(0));
	})
	var validate = false;
	//查询企业账号及子账号
	$.aAjax({
		url: ykyUrl.party + '/v1/enterprises/' + detailList.id + '/accounts',
		async: false,
		type: 'GET',
		//去掉数据模型中的所有函数
		success: function(data) {
			detailList.userList = data;
		}
	});
	//操作日志
	var listAction = [];
	listAction.push("Enterprise Modify");
	var listUrl = ykyUrl.party + "/v1/audit?actions=" + listAction +
		"&actionId=" + GetQueryString("corporationId");
	$.aAjax({
		url: listUrl, // +window.location.search,
		type: 'GET',
		async: false,
		success: function(data) {
			if (data.length === 0)
				showList.isLoading = "暂无数据";
			detailList.operationlist = data.list;
		}
	});
	//获取公司类型
	$.aAjax({
		url: ykyUrl.database + '/v1/category/companytype',
		type: 'GET',
		async: false,
		success: function(data) {
			detailList.corCategoryList = data;
		}
	});
	/*获取所属行业*/
	$.aAjax({
		url: ykyUrl.database + '/v1/category/industry',
		type: 'GET',
		async: false,
		success: function(data) {
			detailList.industryList = data;
		}
	});
});
//获取路径中的参数值
function GetQueryString(name) {
	var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
	var r = window.location.search.substr(1).match(reg);
	if (r !== null) return unescape(r[2]);
	return null;
}

function getOthersValue(otherValue, key) {
	var other = "";
	if (otherValue !== "" && typeof(otherValue) != "undefined") {
		for (var i = 0; i < otherValue.length; i++) {
			other = otherValue[i][key];
			if (other) {
				break;
			}
		}
	}
	if (typeof(other) == "undefined") other = "";
	return other;
}

//省
var provinceList = avalon.define({
	$id: "provinceList",
	list: [],
	activeProvince: '',
	id: getQueryString("id"),
	changeProvince: function() {
		var id = $("#province").val();
		cityListData(id);
	}
});
$.aAjax({
	url: ykyUrl.database + '/v1/geos/100000/BELONG_TO',
	data: provinceList.id,
	//去掉数据模型中的所有函数
	success: function(data) {
		provinceList.list = data;
		if (detailList.list.province) {
			provinceList.activeProvince = detailList.list.province;
		} else {
			provinceList.activeProvince = data[0].id;
		}
		cityListData(provinceList.activeProvince);
		$("#province").selectmenu("refresh");
	}
});
//市
var cityList = avalon.define({
	$id: "cityList",
	list: [],
	activeCity: '',
	id: getQueryString("id"),
	changeCity: function() {
		var id = $("#city").val();
		countryListData(id);
	}
});

function cityListData(province) {
	$.aAjax({
		url: ykyUrl.database + '/v1/geos/' + province + '/BELONG_TO',
		data: cityList.id,
		//去掉数据模型中的所有函数
		success: function(data) {
			if(null == data || data.length<=0){
				return;
			}
			cityList.list = data;
			if (cityList.list) {
				if (detailList.list.city) {
					cityList.activeCity = detailList.list.city;
				} else {
					cityList.activeCity = data[0].id;
				}
			}
			countryListData(cityList.activeCity);
			$("#city").selectmenu("refresh");
		}
	});
}
//县
var countryList = avalon.define({
	$id: "countryList",
	list: [],
	activeCountry: '',
	id: getQueryString("id")
});

function countryListData(city) {
	$.aAjax({
		url: ykyUrl.database + '/v1/geos/' + city + '/BELONG_TO',
		data: countryList.id,
		//去掉数据模型中的所有函数
		success: function(data) {
			countryList.list = data;
			if (countryList.list) {
				if (detailList.list.city) {
					countryList.activeCountry = detailList.list.country;
				} else {
					countryList.activeCountry = '';
				}
			}
			$("#country").selectmenu("refresh");
		}
	});
}

var initBackData = [],
	validate;

var detailList = avalon.define({
	$id: "list",
	list: [],
	userList: [],//企业账号及子账号
	operationList: [],//操作记录
	corCategoryList: [],//公司类型
	industryList: [],//所属行业
	contactInfo:{
		fixedTel: '-',
		qq: '-',
		personalTitle: '-',
		name: '-',
		telNumber: '-',
		mail: '-'
	},//联系人信息
	id: getQueryString("id"),
	corporationId: getQueryString("corporationId"),
	positionList:[{"id":"buyer","name":"采购员"},{"id":"purchasingManager","name":"采购经理"},{"id":"engineer","name":"工程师"},{"id":"other","name":"其他"}],//职业列表
	selected: [],	
	status: '',
	showVoucherPic: function(id) { //查看图片
		showVoucherPic(id);
		reSizeImg($('#' + id).get(0));
	},
	toHtml: function(data) {

		if (data == 'undefined' || !data) {
			return "";
		} else {
			return data;
		}
	},
	auditData: function(index, type) {
		if (type == 'part') {
			return index < 4
		}
		if (type == 'all') {
			$('.Infologomin').show();
			$('.look-morelog .look').hide();
		}
	},
	showIndustryCategory:function(){
		var a_industryList = detailList.list.map.INDUSTRY_CATEGORY_ID.split(",");
		var l_industryList = detailList.industryList;
		var str = "";
		$.each(l_industryList,function(idx,ele){
			$.each(a_industryList,function(i,e){
				if(e==ele.categoryId && e=='1008'&& detailList.list.map.INDUSTRY_CATEGORY_ID_OTHER){
					str +=ele.categoryName + '('+detailList.list.map.INDUSTRY_CATEGORY_ID_OTHER+')'+ '+'
				}else
				if(e==ele.categoryId){
					str +=ele.categoryName + '+'
				}
			})
		})
		return str.slice(0,-1)
	}
});

//公司注册地select
$('#selectSite').selectmenu({
	width: 250
});
//获取路径中的参数值
function GetQueryString(name){
     var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
     var r = window.location.search.substr(1).match(reg);
     if(r!=null)return  unescape(r[2]); return null;
}
/*拉取数据*/
$.aAjax({
	//url: ykyUrl.party + '/v1/enterprises/entDetail/' + detailList.id + '/' + detailList.corporationId + '/PARTY_GROUP',
	url: ykyUrl.party + '/v1/enterprises/entDetail/' + detailList.id + '/' + detailList.corporationId + '/CORPORATION',
	type: 'GET',
	/*async:false, */
	//去掉数据模型中的所有函数
	success: function(data) {
		if(data.map==undefined){
			data.map = "";
		}
		//资质审核组件
		zzRenzheng.init('#qual', {
			type: data.map.REG_ADDR,
			busilisType: data.map.REG_ADDR == '0'? data.map.BUSI_LIS_TYPE : '' ,
			imgSrc: {
				BUSI_LIC_PIC: getImage(data.map.BUSI_LIC_PIC), //营业执照影印件(大陆)  /  注册证书(香港)
				TAX_REG_PIC: getImage(data.map.TAX_REG_PIC), //税务登记证影印件(大陆) / 商业登记证(香港)
				OCC_PIC: getImage(data.map.OCC_PIC), //组织结构代码影印件(大陆)
			}
		});
		//资质审核组件只读
		zzRenzheng.onlyRead('#qual');
		if(data.map.LOA){
			var loaurl = getImage(data.map.LOA);
			var loapdfname = data.map.LOA_PDF_NAME;
			if(loapdfname){
				$("#img8").attr("data-pdfname",loapdfname);
				$("#img8").attr("data-type","pdf");
				$("#img8").attr("data-url",loaurl)
				$("#img8").attr("src",ykyUrl._this+'/images/pdf_icon.png')
				$('.uploadImgLoa').find('img').attr('src', ykyUrl._this + '/images/pdf_icon.png');
				$('.uploadImgLoa').find('img').on('click', function() {
					window.open($(this).data('url'));
				})
			}else{
				$("#img8").attr("data-type","img");
				$("#img8").attr("src",loaurl)
				layerPic.init($('.uploadImgLoa').find('img').attr('id'), $('.uploadImgLoa').find('img'));
			}
		}
		var mail = GetQueryString("mail");
		detailList.list = data;
		detailList.list.mail = mail;
		initBackData = data;
		/*获取省份*/
		provinceList.activeProvince = data.province;
		$('#province').selectmenu('refresh');
		cityListData(data.province);

		/*获取市区*/
		cityList.activeCity = data.city;
		$('#city').selectmenu('refresh');
		countryListData(data.city);

		/*获取县城*/
		countryList.activeCountry = data.country;
		$('#country').selectmenu('refresh');
		
		//选中所属行业
		detailList.industryCategory = data.industryCategory?data.industryCategory.split(','):'';
		detailList.selected = data.industryCategory?data.industryCategory.split(','):'';
		if(data.industryCategory){
			$.each(data.industryCategory.split(','), function(index, item) {
				$('.check-box-white').each(function() {
					var val = $(this).find('input[type=checkbox]').val();
					if (val == item) {
						$(this).addClass('check-box-red');
					}

					if (item === '1008') {
						$(this).trigger('click');
						$(this).trigger('click');
					}
				});
			});
		}
		$.aAjax({
			url:ykyUrl.party + '/v1/customers/' + detailList.id,
			//url:'http://192.168.1.118:27082/v1/customers/861518187475238912',
			type:'GET',
			success:function(res){
				
				$.each(res, function(key, value) {
					if(key == 'provinceName' || key == 'cityName' || key == 'countryName') {
						return;
					}
					
					if(typeof value == 'undefined' || value == '') {
						res[key] = '-';
					}
				})
				
				detailList.contactInfo = $.extend({}, detailList.contactInfo, res);
				
				//判断子账号管理是否可编辑
				if(detailList.list.partyCode && res.personType == "MAIN"){										
					$("#accountManagement").removeClass("dn");
				}else if(detailList.list.partyCode && res.personType == "COMMON"){					
					$.aAjax({
						url: ykyUrl.party + '/v1/enterprises/entCertificationList?partyCode=' + detailList.list.partyCode,
						type:'GET',
						success:function(rec){
							if(rec.list[0].accountStatus == 'ACCOUNT_NOT_VERIFIED'){								
								$("#accountManagement").removeClass("dn");
							}						
						}
					})
				}
			},
			error:function(){
				console.log('error');
			}
		})
	}

});
