(function () {
    var ORDER_STATUS_MAP = {
        'WAIT_SHIP': '待发货',
        'WAIT_RECEIVE': '待收货',
        'COMPLETED': '交易完成'
    }
    //发票状态
    var INVOICE_STATUS_MAP = {
    		'INVOICE_APPROVED': '未开票'
    }
    
    //支付状态
    var PAY_STATUS_MAP = {
    		'WAIT_SHIP': '待发货',
    		'WAIT_RECEIVE': '待收货',
    		'COMPLETED': '交易完成'
    }

	function mapToArray (obj) {
		var result = []
		for (var key in obj) {
			result.push({
				value: key,
				text: obj[key]
			})
		}

		return result
	}

	new Vue({
		el: '#order-list',
      /*  components: {
            'ElDialog': elDialog,
            'UploadDialog': UploadDialog
        },*/
		data: function () {
		    var self = this
			return {
                url: ykyUrl.transaction + '/v1/orders/term/orderlist',
                queryParams: {
                    size: 10,
                    page: 1,
                    defaultStatus: true,
                    searchType:'OPERATE',
                    partyId: $('#enterpriseId').val(),
                    roleType: 'CUSTOMER'
                },
                pageflag: true,
                refresh: false,
                showTotal: true,
                showReceiptFaild: false,
                checkflag: true,
                formData: {
					id: 'search-form',
					data: '',
                    columnCount: 3,
					fields: [{
                        keyname: '交易时间',
                        type: 'daterange',
                        startkey: 'orderCreateDateBegin',  //star id
                        endkey: 'orderCreateDateEnd',        //end id
                        startname: 'orderCreateDateBegin',    //star name
                        endname: 'orderCreateDateEnd'
                    },{
						keyname: '订单编号',
						type: 'text',
						key: 'orderIds',
						name: 'orderIds'
                	},{
                        keyname: '账号',
                        type: 'text',
                        key: 'account',
                        name: 'account'
                    },{
                        keyname: '发货时间',
                        type: 'daterange',
                        startkey: 'deliveryDateBegin',  //star id
                        endkey: 'deliveryDateEnd',        //end id
                        startname: 'deliveryDateBegin',    //star name
                        endname: 'deliveryDateEnd'
                    },{
                        keyname: '状态',
                        type: 'select',
                        key: 'status',
                        name: 'status',
                        options: mapToArray({
							'': '全部',
                            'WAIT_SHIP': '待发货',
							'WAIT_RECEIVE': '待收货',
							'COMPLETED': '交易完成'
						})
                    }],
                    buttons:[{
                        text: '查询',
                        type: 'submit',
                        id: '',
                        name: '',
                        inputClass: 'btn-danger',
                        callback: {
                            action: 'on-search'
                        }
                    }]
				},
                gridColumns: [
                {
                    key: 'selected',
                    name: '',
                    width: '20px'
                    // checkflag: true
                },
                {
                    key: 'index',
                    name: '序号',
                    width: '50px',
                    align: 'center'
                },{
                    key: 'createdDate',
                    name: '交易时间',
                    width: '50px',
                    align: 'center'
                },{
                    key: 'purchaserName',
                    name: '交易账号',
                    width: '50px',
                    align: 'center'
                },{
                	key: 'id',
                	name: '订单编号',
                	width: '50px',
                	align: 'center',
                	cutstring: true
                },{
                    key: 'orderShipmentCreatedDate',
                    name: '发货时间',
                    width: '50px',
                    align: 'center',
                    formatter: function (rowData) {
                    	var payDate=rowData.orderShipmentPreference;
                        if(payDate){
                        	return payDate.createdDate;
                        }
                    }
                },{
                    key: 'orderStatus',
                    name: '订单状态',
                    width: '50px',
                    align: 'center',
                    formatter: function (rowData, val) {
                        return ORDER_STATUS_MAP[val] || ''
                    }
                },{
                    key: 'invoiceStatus',
                    name: '开票状态',
                    width: '50px',
                    align: 'center',
                    formatter: function (rowData, val) {
                        return INVOICE_STATUS_MAP[val] || '已开票'
                    }
                },{
                    key: 'havePay',
                    name: '是否付款',
                    width: '50px',
                    align: 'center',
                    formatter: function (rowData, val) {
                        return PAY_STATUS_MAP[val] || ''
                    }
                },{
                    key: 'operation',
                    name: '操作',
                    width: '50px',
                    align: 'center',
                    render: function (h, params) {
                        var rowData = params.row, 
                        label = '',
                        renderBtn = [
                            h('Button', {
                                props: {
                                    type: 'text'
                                },
                                on: {
                                    click: function () {
                                        window.open(ykyUrl._this + '/order.htm?action=detail&id=' + rowData.id)
                                    }
                                }
                            }, '详情')
                        ]
                         //未支付需要销账
                        if (rowData.havePay === 'UNPAY') {
                            renderBtn.unshift(
                                h('Button', {
                                    props: {
                                        type: 'text'
                                    },
                                    on: {
                                        click: function () {
                                            return self.onReceiptFaild(rowData)
                                        }
                                    }
                                }, '销账')
                            )
                        }

                        return h('div', renderBtn)

                    }
                }]
			}
		},
		methods: {
            exportData: function (type) {
                var params = {}
                if (type === 'all') {
                    params = Object.assign({}, this.queryParams)
                } else {
                    var selectedDatas = this.$refs.lemoGrid.getChecked()
                    params.orderIds = selectedDatas.map(function (data) {
                        return data.id
                    }).join(',')
                    if (!params.orderIds) {
                        alert('请至少勾选一行')
                        return
                    }
                }

                $.aAjax({
                    url: ykyUrl.transaction + "/v1/bills/new",
                    type:"GET",
                    data: params,
                    success: function(url) {
                        window.location.href = url
                    }
                })
            },
            onPutOk: function () {
                this.updateGrid()
            },
		    updateGrid: function () {
                this.refresh = !this.refresh
            },
            onUploadCredClick: function (data) {
                alert(data.index)
            },
            onSearchClick: function (searchParam) {
                var queryParams = this.queryParams
                queryParams.pageSize = 10
                queryParams.page = 1
                queryParams.defaultStatus = !queryParams.defaultStatus

                for (var key in searchParam) {
                    queryParams[key] = searchParam[key] ? searchParam[key] : undefined
                }
			},
            onReceiptFaild: function (rowData) {
                var self = this
		        this.$refs.dialog.show(rowData.id)
            },
            onReceiptSuccess: function (rowdata) {
                var self = this
                var param = {
                    paymentPreferenceId: rowdata.id,
                    result: 1,
                    reason: ''
                }

                this.$Modal.confirm({
                    title: '确认收到汇款吗？',
                    content: '请确认财务部已经收到相应转账汇款再进行本操作',
                    onOk: function () {
                    	//调用ga函数
                    	var prodList = [];
                    	var orderInfo = {                      //操作类型设置为购买     
                      		  'id': rowdata.id,                //订单号(string类型).  必填  
                      		  'revenue': rowdata.orderPay.amount,            //价格（总价）(string类型).     
                      		};
                    	
                    	purchaseClick(prodList,orderInfo);
                    	
                      /*  $.aAjax({
                            url:  ykyUrl.pay + "/v1/payment?" + $.param(param),
                            type:"PUT",
                            complete: function(){
                                self.updateGrid()
                            }
                        });*/
                    }
                })
            }
		}
	})
})()










