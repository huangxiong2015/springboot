<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"  
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"  
         xmlns:aop="http://www.springframework.org/schema/aop"  
         xmlns:tx="http://www.springframework.org/schema/tx"  
         xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd  
           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd  
           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">
 	<!-- 保证实现了Shiro内部lifecycle函数的bean执行 -->  
	<bean id="lifecycleBeanPostProcessor" class="org.apache.shiro.spring.LifecycleBeanPostProcessor"/> 
	<!-- 自定义的realm用来实现用户角色和权限数据的查询 -->
    <bean id="authorityRealm" class="com.ictrade.web.shiro.realm.AuthorityRealm">
    	<property name="casServerUrlPrefix" value="${cas.serverUrlPrefix.internal}"></property>
    	<property name="casService" value="${pay.cas.client.validation.url}"></property> 
    </bean> 
    
    <!-- 扩展SecurityManager   authorityRealm暂时不要-->
    <bean id="securityManager" class="org.apache.shiro.web.mgt.DefaultWebSecurityManager">
        <property name="realm" ref="authorityRealm"/>
        <property name="subjectFactory" ref="casSubjectFactory"></property> 
    </bean>  
    
    
    <!-- shiro filter -->
   <bean id="logout" class="org.apache.shiro.web.filter.authc.LogoutFilter" lazy-init="false"> 
        <property name="redirectUrl" value="/index.htm" /> 
    </bean> 
    <!-- shiro filter -->
   <bean id="shiroFilter" class="org.apache.shiro.spring.web.ShiroFilterFactoryBean">  
    	<property name="securityManager" ref="securityManager" /> 
        <property name="loginUrl" value="${cas.serverUrlPrefix}/login?service=${pay.cas.client.validation.url}" />   
        <property name="filters">    
            <map>    
                <entry key="casFilter" value-ref="casFilter"/>  
                <entry key="logout" value-ref="logout"></entry>
                <entry key="corsFilter" value-ref="corsFilter"></entry>
            </map>    
        </property>   
        <property name="filterChainDefinitions">  
            <value> 
            	<![CDATA[   
            		/index.htm** = authc
            		/ = authc
	                /logout.htm = logout
	                /login.htm = casFilter  
	                /goods.htm** = authc,corsFilter
	                /payOrder.htm** = authc,corsFilter
	                /** = authc,corsFilter
	                /payments/** = authc,corsFilter
                ]]>
            </value>    
        </property>   
    </bean>

    <bean id="casSubjectFactory" class="org.apache.shiro.cas.CasSubjectFactory" />

    <bean id="casFilter" class="org.apache.shiro.cas.CasFilter">
		<property name="failureUrl" value="/errors/error" />
	</bean>
	
    <bean id="corsFilter" class="com.ictrade.common.web.CorsFilter"></bean>
</beans>
	